---
title: "Include Compare Exchange Values"
sidebar_label: Include Compare Exchange Values
sidebar_position: 5
hide_table_of_contents: true
---

import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';
import LanguageSwitcher from "@site/src/components/LanguageSwitcher";
import LanguageContent from "@site/src/components/LanguageContent";

export const supportedLanguages = ["csharp", "nodejs"];


# Include Compare Exchange Values
<LanguageSwitcher supportedLanguages={supportedLanguages} />
<LanguageContent language="csharp">

<Admonition type="note" title="Note">

* Compare-Exchange items can be included when [loading entities](../../../client-api/session/loading-entities.mdx) 
  and when making [queries](../../../client-api/session/querying/how-to-query.mdx).

* The Session [tracks](../../../client-api/session/what-is-a-session-and-how-does-it-work.mdx#tracking-changes) 
  the included Compare Exchange items which means their value can be accessed  
  in that Session without making an additional call to the server.

* The Compare Exchange include syntax is based on the [include method](../../../client-api/how-to/handle-document-relationships.mdx#includes).  

* In this page:  
  * [Syntax](../../../client-api/operations/compare-exchange/include-compare-exchange.mdx#syntax)  
  * [Examples](../../../client-api/operations/compare-exchange/include-compare-exchange.mdx#examples)  

</Admonition>
## Syntax

#### Include method

Chain the method `IncludeCompareExchangeValue()` to include compare exchange values 
along with `Session.Load()` or LINQ queries.  

<TabItem value="include_builder" label="include_builder">
<CodeBlock language="csharp">
{`public interface ICompareExchangeValueIncludeBuilder<T, out TBuilder>
\{
    TBuilder IncludeCompareExchangeValue(string path);

    TBuilder IncludeCompareExchangeValue(Expression<Func<T, string>> path);

    TBuilder IncludeCompareExchangeValue(Expression<Func<T, IEnumerable<string>>> path);
\}
`}
</CodeBlock>
</TabItem>

| Parameter | Type | Description |
| - | - | - |
| **path** | `string`;
`Expression<Func<T, string>>`;
`Expression<Func<T, IEnumerable<string>>>` | The key of the compare exchange value you want to include, a path to the key, or a path to a `string[]` of keys. |

#### RQL

In an RQL query, you can use the [`include` keyword](../../../client-api/session/querying/what-is-rql.mdx#include) 
followed by `cmpxchg()` to include a compare exchange value:  

<TabItem value="sql" label="sql">
<CodeBlock language="sql">
{`include cmpxchg(key)
`}
</CodeBlock>
</TabItem>

In [javascript functions](../../../client-api/session/querying/what-is-rql.mdx#declare) within queries, 
use `includes.cmpxchg()` (see the RawQuery example 
[below](../../../client-api/operations/compare-exchange/include-compare-exchange.mdx#examples)):  

<TabItem value="javascript" label="javascript">
<CodeBlock language="javascript">
{`includes.cmpxchg(key);
`}
</CodeBlock>
</TabItem>

| Parameter | Type | Description |
| - | - | - |
| **key** | `string`;
path to `string` | The key of the compare exchange value you want to include, or a path to the key. |



## Examples

<Tabs groupId='languageSyntax'>
<TabItem value="Load" label="Load">
<CodeBlock language="csharp">
{`using (IDocumentSession session = documentStore.OpenSession())
{
    // Load a user document, include the compare exchange value
    // with the key equal to the user's Name field
    var user = session.Load<User>("users/1-A", 
                                  includes => includes.IncludeCompareExchangeValue(
                                      x => x.Name));

    // Getting the compare exchange value does not require
    // another call to the server
    var value = session.Advanced.ClusterTransaction
                                .GetCompareExchangeValue<string>(user.Name);
}
`}
</CodeBlock>
</TabItem>
<TabItem value="LoadAsync" label="LoadAsync">
<CodeBlock language="csharp">
{`using (IAsyncDocumentSession session = documentStore.OpenAsyncSession())
{
    // Load a user document, include the compare exchange value
    // with the key equal to the user's Name field
    var user = await session.LoadAsync<User>("users/1-A", 
                                             includes => includes.IncludeCompareExchangeValue(
                                                 x => x.Name));

    // Getting the compare exchange value does not require
    // another call to the server
    var value = await session.Advanced.ClusterTransaction
                                      .GetCompareExchangeValueAsync<string>(user.Name);
}
`}
</CodeBlock>
</TabItem>
<TabItem value="Query" label="Query">
<CodeBlock language="csharp">
{`var users = session.Query<User>()
    .Include(builder => builder.IncludeCompareExchangeValue(x => x.Name))
    .ToList();

List<CompareExchangeValue<string>> compareExchangeValues = null;

// Getting the compare exchange values does not require
// additional calls to the server
foreach (User u in users){
    compareExchangeValues.Add(session.Advanced.ClusterTransaction
                                  .GetCompareExchangeValue<string>(u.Name));
}
`}
</CodeBlock>
</TabItem>
<TabItem value="RawQuery(RQL)" label="RawQuery(RQL)">
<CodeBlock language="csharp">
{`// First method: from body of query
var users1 = session.Advanced
    .RawQuery<User>(@"
        from Users as u
        select u
        include cmpxchg(u.Name)"
    )
    .ToList();

List<CompareExchangeValue<string>> compareExchangeValues1 = null;

// Getting the compare exchange values does not require
// additional calls to the server
foreach (User u in users1){
    compareExchangeValues1.Add(session.Advanced.ClusterTransaction
                               .GetCompareExchangeValue<string>(u.Name));
}


// Second method: from a JavaScript function
var users2 = session.Advanced
    .RawQuery<User>(@"
        declare function includeCEV(user) {
            includes.cmpxchg(user.Name);
            return user;
        }

        from Users as u
        select includeCEV(u)"
    )
    .ToList();
// Note that includeCEV() returns the same User 
// entity it received, without modifying it

List<CompareExchangeValue<string>> compareExchangeValues2 = null;

// Does not require calls to the server
foreach (User u in users2){
    compareExchangeValues2.Add(session.Advanced.ClusterTransaction
                               .GetCompareExchangeValue<string>(u.Name));
}
`}
</CodeBlock>
</TabItem>
</Tabs>




</LanguageContent>
<LanguageContent language="nodejs">

<Admonition type="note" title="Note">

* Compare-Exchange items can be included when [loading entities](../../../client-api/session/loading-entities.mdx) 
  and when making [queries](../../../client-api/session/querying/how-to-query.mdx).

* The Session [tracks](../../../client-api/session/what-is-a-session-and-how-does-it-work.mdx#tracking-changes) 
  the included Compare Exchange items which means their value can be accessed  
  in that Session without making an additional call to the server.

* In this page:
    * [Sample data](../../../client-api/operations/compare-exchange/include-compare-exchange.mdx#sample-data)
    * [Include CmpXchg items when loading](../../../client-api/operations/compare-exchange/include-compare-exchange.mdx#include-cmpxchg-items-when-loading)
    * [Include CmpXchg items when querying](../../../client-api/operations/compare-exchange/include-compare-exchange.mdx#include-cmpxchg-items-when-querying)
    * [Syntax](../../../client-api/operations/compare-exchange/include-compare-exchange.mdx#syntax)

</Admonition>
## Sample data

* The examples in this article are based on the following __sample data__:

<Tabs groupId='languageSyntax'>
<TabItem value="Sample_data" label="Sample_data">
<CodeBlock language="js">
{`{
    // Create some company documents:
    // ==============================

    const session = documentStore.openSession();

    const company1 = new Company();
    company1.id = "companies/1";
    company1.name = "Apple";
    company1.supplier = "suppliers/1";
    company1.workers = ["employees/1", "employees/2"];

    const company2 = new Company("companies/2", "Google", "suppliers/2", ["employees/3", "employees/4"]);
    const company3 = new Company("companies/3", "Microsoft", "suppliers/3", ["employees/6", "employees/5"]);

    await session.store(company1);
    await session.store(company2);
    await session.store(company3);

    await session.saveChanges();
}
{
    // Create some CmpXchg items:
    // ==========================

    // Open a session with cluster-wide mode so that we can call 'createCompareExchangeValue'
    const session = documentStore.openSession({
        transactionMode: "ClusterWide"
    });

    session.advanced.clusterTransaction.createCompareExchangeValue("employee/1", "content for employee 1 ..");
    session.advanced.clusterTransaction.createCompareExchangeValue("employee/2", "content for employee 2 ..");
    session.advanced.clusterTransaction.createCompareExchangeValue("employee/3", "content for employee 3 ..");

    session.advanced.clusterTransaction.createCompareExchangeValue("suppliers/1", "content for supplier 1 ..");
    session.advanced.clusterTransaction.createCompareExchangeValue("suppliers/2", "content for supplier 2 ..");
    session.advanced.clusterTransaction.createCompareExchangeValue("suppliers/3", "content for supplier 3 ..");
    
    await session.saveChanges();
}
`}
</CodeBlock>
</TabItem>
<TabItem value="Company_class" label="Company_class">
<CodeBlock language="js">
{`class Company {
    constructor(
        id = null,
        name = "",
        supplier = "",
        workers = []

    ) {
        Object.assign(this, {
            id,
            name,
            supplier,
            workers
        });
    }
}
`}
</CodeBlock>
</TabItem>
</Tabs>



## Include CmpXchg items when loading

<Admonition type="note" title="Note">

__Include single item__:
<TabItem value="include_1" label="include_1">
<CodeBlock language="js">
{`// Open a session with cluster-wide mode to enable calling 'includeCompareExchangeValue'
const session = documentStore.openSession(\{
    transactionMode: "ClusterWide"
\});

// Load a company document + include a CmpXchg item:
// =================================================

// Call 'includeCompareExchangeValue' within the 'load' options,
// pass the PATH of the document property that contains the key of the CmpXchg item to include
const company1 = await session.load("companies/1", \{
    documentType: Company,
    // "supplier" is the document property that holds the cmpXchg key 
    includes: i => i.includeCompareExchangeValue("supplier")
\});

// Calling 'load' has triggered a server call
const numberOfRequests = session.advanced.numberOfRequests;
assert.equal(numberOfRequests, 1);

// Access the included CmpXchg item:
// =================================

// Call 'getCompareExchangeValue' to access the content of the included CmpXchg item,
// pass the cmpXchg item KEY. This will NOT trigger another server call.
const item = await session.advanced.clusterTransaction
    .getCompareExchangeValue(company1.supplier);

// You can assert that no further server calls were made
assert.equal(session.advanced.numberOfRequests, numberOfRequests);

// The cmpXchg item value is available
const value = item.value;
`}
</CodeBlock>
</TabItem>

</Admonition>

<Admonition type="note" title="Note">

__Include multiple items__:
<TabItem value="include_2" label="include_2">
<CodeBlock language="js">
{`const session = documentStore.openSession(\{
    transactionMode: "ClusterWide"
\});

// Load a company document + include multiple CmpXchg items:
// =========================================================

// Call 'includeCompareExchangeValue' within the 'load' options,
// pass the PATH of the document property that contains the list keys of the CmpXchg items to include
const company1 = await session.load("companies/1", \{
    documentType: Company,
    // "workers" is the document property that holds the list of keys 
    includes: i => i.includeCompareExchangeValue("workers")
\});

const numberOfRequests = session.advanced.numberOfRequests;
assert.equal(numberOfRequests, 1);

// Access the included CmpXchg items:
// ==================================

// Call 'getCompareExchangeValues' to access the content of the included CmpXchg items, 
// pass the list of KEYS. This will NOT trigger another server call.
const items = await session.advanced.clusterTransaction
    .getCompareExchangeValues(company1.workers);

assert.equal(session.advanced.numberOfRequests, numberOfRequests);

// The value of each item is available
const value1 = items["employees/1"].value;
const value2 = items["employees/2"].value;
`}
</CodeBlock>
</TabItem>

</Admonition>



## Include CmpXchg items when querying

<Admonition type="note" title="Note">

__dynamic query__:
<Tabs groupId='languageSyntax'>
<TabItem value="Query" label="Query">
<CodeBlock language="js">
{`// Open a session with cluster-wide mode to enable calling 'includeCompareExchangeValue'
const session = documentStore.openSession({
    transactionMode: "ClusterWide"
});

// Make a dynamic query + include CmpXchg items:
// =============================================

const companies = await session.query({ collection: "companies" })
    // Call 'include' with 'includeCompareExchangeValue'
    // pass the PATH of the document property that contains the key of the CmpXchg item to include  
    .include(x => x.includeCompareExchangeValue("supplier"))
    .all();

// Making the query has triggered a server call
const numberOfRequests = session.advanced.numberOfRequests;
assert.equal(numberOfRequests, 1);

// Access the included CmpXchg items:
// ==================================

const cmpXchgItems = [];

for (let i = 0; i < companies.length; i++) {
    // Call 'getCompareExchangeValues' to access the content of the included CmpXchg items,
    // pass the KEY. This will NOT trigger another server call.
    const item = await session.advanced.clusterTransaction
        .getCompareExchangeValue(companies[i].supplier);

    cmpXchgItems.push(item);
}

// You can assert that no further server calls were made
assert.equal(session.advanced.numberOfRequests, numberOfRequests);
`}
</CodeBlock>
</TabItem>
<TabItem value="RawQuery_using_RQL" label="RawQuery_using_RQL">
<CodeBlock language="js">
{`// Open a session with cluster-wide mode to enable calling 'include cmpxchg'
const session = documentStore.openSession({
    transactionMode: "ClusterWide"
});

// Make a raw query + include CmpXchg items:
// =========================================

// In the provided RQL:
// * Call 'include' with 'cmpxchg'
// * Pass the PATH of the document property that contains the key of the CmpXchg item to include  
const companies = await session.advanced
    .rawQuery(\`from companies as c
               select c
               include cmpxchg(c.supplier)\`)
    .all();

const numberOfRequests = session.advanced.numberOfRequests;
assert.equal(numberOfRequests, 1);

// Access the included CmpXchg items:
// ==================================

const cmpXchgItems = [];

for (let i = 0; i < companies.length; i++) {
    // Call 'getCompareExchangeValues' to access the content of the included CmpXchg items, pass the KEY,
    // this will NOT trigger another server call
    const item = await session.advanced.clusterTransaction
        .getCompareExchangeValue(companies[i].supplier);

    cmpXchgItems.push(item);
}

assert.equal(session.advanced.numberOfRequests, numberOfRequests);
`}
</CodeBlock>
</TabItem>
<TabItem value="RawQuery_using_JS_function" label="RawQuery_using_JS_function">
<CodeBlock language="js">
{`// Open a session with cluster-wide mode to enable calling 'includes.cmpxchg'
const session = documentStore.openSession({
    transactionMode: "ClusterWide"
});

// Make a raw query + include CmpXchg items using Javascript method:
// =================================================================

// In the provided RQL:
// * Call 'includes.cmpxchg'
// * Pass the PATH of the document property that contains the key of the CmpXchg item to include  
const companies = await session.advanced
    .rawQuery(\`declare function includeCmpXchg(company) {
                  includes.cmpxchg(company.supplier);
                  return company;
             }
             
            from companies as c
            select includeCmpXchg(c)\`)
    .all();

const numberOfRequests = session.advanced.numberOfRequests;
assert.equal(numberOfRequests, 1);

// Access the included CmpXchg items:
// ==================================

const cmpXchgItems = [];

for (let i = 0; i < companies.length; i++) {
    // Call 'getCompareExchangeValues' to access the content of the included CmpXchg items,
    // pass the KEY. This will NOT trigger another server call
    const item = await session.advanced.clusterTransaction
        .getCompareExchangeValue(companies[i].supplier);

    cmpXchgItems.push(item);
}

assert.equal(session.advanced.numberOfRequests, numberOfRequests);
`}
</CodeBlock>
</TabItem>
</Tabs>

</Admonition>

<Admonition type="note" title="Note">

__Index query__:
<Tabs groupId='languageSyntax'>
<TabItem value="Query" label="Query">
<CodeBlock language="js">
{`const session = documentStore.openSession({
    transactionMode: "ClusterWide"
});

// Make an index query + include CmpXchg items:
// ============================================

// Call 'include' with 'includeCompareExchangeValue'
// pass the PATH of the document property that contains the key of the CmpXchg item to include
const companies = await session.query({ indexName: "Companies/ByName" })
    .include(x => x.includeCompareExchangeValue("supplier"))
    .all();

const numberOfRequests = session.advanced.numberOfRequests;
assert.equal(numberOfRequests, 1);

// Access the included CmpXchg items:
// ==================================

const cmpXchgItems = [];

for (let i = 0; i < companies.length; i++) {
    // Call 'getCompareExchangeValues' to access the content of the included CmpXchg items,
    // pass the KEY. This will NOT trigger another server call
    const item = await session.advanced.clusterTransaction
        .getCompareExchangeValue(companies[i].supplier);

    cmpXchgItems.push(item);
}

assert.equal(session.advanced.numberOfRequests, numberOfRequests);
`}
</CodeBlock>
</TabItem>
<TabItem value="Index" label="Index">
<CodeBlock language="js">
{`class Companies_ByName extends AbstractJavaScriptIndexCreationTask {
    constructor() {
        super();

        this.map('companies', company => {
            return {
                name: company.name
            };
        });
    }
}
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`// RQL that can be used with a Raw Query:
// ======================================

from index "Companies/ByName"
include cmpxchg("supplier")

// Using JS method:
// ================

declare function includeCmpXchg(company) {
    includes.cmpxchg(company.supplier);
    return company;
}

from index "Companies/ByName" as c
select includeCmpXchg(c)
`}
</CodeBlock>
</TabItem>
</Tabs>

* Note:  
  Similar to the above dynamic query example, you can query the index with a [raw query](../../../indexes/querying/query-index.mdx#sessionadvancedrawquery) using the provided RQL.

</Admonition>



## Syntax

<Admonition type="note" title="Note">

__When loading entities or making queries__:  

* Use method `includeCompareExchangeValue()` to include compare-exchange items along with `session.load()` or with queries.  

<TabItem value="syntax_1" label="syntax_1">
<CodeBlock language="js">
{`includeCompareExchangeValue(path);
`}
</CodeBlock>
</TabItem>

| Parameter | Type      | Description                                                                                                |
|-----------|-----------|------------------------------------------------------------------------------------------------------------|
| __path__  | `string`  | The path of the document property that contains the key (or list of keys) of the CmpXchg items to include  |

</Admonition>
<Admonition type="note" title="Note">

__When querying with RQL__:  

* Use the [include](../../../client-api/session/querying/what-is-rql.mdx#include) keyword followed by `cmpxchg()` to include a compare-exchange item.  

<TabItem value="sql" label="sql">
<CodeBlock language="sql">
{`include cmpxchg(key)
`}
</CodeBlock>
</TabItem>

</Admonition>
<Admonition type="note" title="Note">

__When using javascript functions within RQL__:

* Use `includes.cmpxchg()` In [javascript functions](../../../client-api/session/querying/what-is-rql.mdx#declare) within RQL queries. 

<TabItem value="javascript" label="javascript">
<CodeBlock language="javascript">
{`includes.cmpxchg(key);
`}
</CodeBlock>
</TabItem>

| Parameter | Type      | Description                                                                      |
|-----------|-----------|----------------------------------------------------------------------------------|
| __key__   | `string`  | The key of the compare exchange value you want to include, or a path to the key. |

</Admonition>



</LanguageContent>

<!---
### Client API
- [Session Change Tracking](../../../client-api/session/what-is-a-session-and-how-does-it-work#tracking-changes)
- [How to: Handle Document Relationships](../../../client-api/how-to/handle-document-relationships)
- [Compare Exchange Overview](../../../client-api/operations/compare-exchange/overview)

### Indexes
- [Indexing Compare Exchange Values](../../../indexes/indexing-compare-exchange-values)


-->