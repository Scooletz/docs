---
title: "Consume Subscriptions API"
sidebar_label: API Overview
sidebar_position: 2
hide_table_of_contents: true
---

import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';
import LanguageSwitcher from "@site/src/components/LanguageSwitcher";
import LanguageContent from "@site/src/components/LanguageContent";

export const supportedLanguages = ["csharp", "java", "python", "nodejs"];


# Consume Subscriptions API 
<LanguageSwitcher supportedLanguages={supportedLanguages} />
<LanguageContent language="csharp">

<Admonition type="note" title="Note">

* In this page:  
   * [Create the subscription worker](../../../client-api/data-subscriptions/consumption/api-overview#create-the-subscription-worker)  
   * [SubscriptionWorkerOptions](../../../client-api/data-subscriptions/consumption/api-overview#subscriptionworkeroptions)  
   * [Run the subscription worker](../../../client-api/data-subscriptions/consumption/api-overview#run-the-subscription-worker)  
   * [SubscriptionBatch&lt;T&gt;](../../../client-api/data-subscriptions/consumption/api-overview#subscriptionbatch&lt;t&gt;)  
   * [SubscriptionBatch&lt;T&gt;.Item](../../../client-api/data-subscriptions/consumption/api-overview#subscriptionbatch&lt;t&gt;.item)  
   * [SubscriptionWorker&lt;T&gt;](../../../client-api/data-subscriptions/consumption/api-overview#subscriptionworker&lt;t&gt;)  

</Admonition>
## Create the subscription worker

A subscription worker can be created using the following `GetSubscriptionWorker` methods available through the `Subscriptions` property of the `DocumentStore`.

Note: Simply creating the worker is insufficient;  
after creating the worker, you need to [run the subscription worker](../../../client-api/data-subscriptions/consumption/api-overview#run-the-subscription-worker) to initiate document processing.

<TabItem value="something" label="subscriptionWorkerGeneration">
<CodeBlock language="csharp">
{`SubscriptionWorker<dynamic> GetSubscriptionWorker(
    string subscriptionName, string database = null);

SubscriptionWorker<dynamic> GetSubscriptionWorker(
    SubscriptionWorkerOptions options, string database = null);

SubscriptionWorker<T> GetSubscriptionWorker<T>(
    string subscriptionName, string database = null) where T : class;

SubscriptionWorker<T> GetSubscriptionWorker<T>(
    SubscriptionWorkerOptions options, string database = null) where T : class;
`}
</CodeBlock>
</TabItem>

| Parameter            | Type                        | Description                                                                                                                                |
|----------------------|-----------------------------|--------------------------------------------------------------------------------------------------------------------------------------------|
| **subscriptionName** | `string`                    | The name of the subscription to which the worker will connect.                                                                             |
| **options**          | `SubscriptionWorkerOptions` | Options that affect how the worker interacts with the subscription. These options do not alter the definition of the subscription itself.  |
| **database**         | `string`                    | The name of the database where the subscription task resides.<br/>If `null`, the default database configured in DocumentStore will be used. |

| Return value         |                                                                                                                                                     |
|----------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------|
| `SubscriptionWorker` | The subscription worker that has been created.<br/>Initially, it is idle and will only start processing documents when the `Run` function is called. |



## SubscriptionWorkerOptions

<TabItem value="something" label="worker_options">
<CodeBlock language="csharp">
{`public class SubscriptionWorkerOptions
\{
    public string SubscriptionName \{ get; \}
    public int MaxDocsPerBatch \{ get; set; \}
    public int SendBufferSizeInBytes \{ get; set; \}
    public int ReceiveBufferSizeInBytes \{ get; set; \}
    public bool IgnoreSubscriberErrors \{ get; set; \}
    public bool CloseWhenNoDocsLeft \{ get; set; \}
    public TimeSpan TimeToWaitBeforeConnectionRetry \{ get; set; \}
    public TimeSpan ConnectionStreamTimeout \{ get; set; \}
    public TimeSpan MaxErroneousPeriod \{ get; set; \}
    public SubscriptionOpeningStrategy Strategy \{ get; set; \}
\}
`}
</CodeBlock>
</TabItem>

When creating a worker with `SubscriptionWorkerOptions`, the only mandatory property is `SubscriptionName`.  
All other parameters are optional and will default to their respective default values if not specified.

| Member                              | Type                          | Description                                                                                                                                                                                                                                                                                                                                                                                                       |
|-------------------------------------|-------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------| 
| **SubscriptionName**                | `string`                      | The name of the subscription to which the worker will connect.                                                                                                                                                                                                                                                                                                                                                    |
| **MaxDocsPerBatch**                 | `int`                         | The maximum number of documents that the server will try to retrieve and send to the client in a batch. If the server doesn't find as many documents as specified, it will send the documents it has found without waiting. Default: 4096.                                                                                                                                                                        |
| **SendBufferSizeInBytes**           | `int`                         | The size in bytes of the TCP socket buffer used for _sending_ data.<br/>Default: 32,768 bytes (32 KiB).                                                                                                                                                                                                                                                                                                            |
| **ReceiveBufferSizeInBytes**        | `int`                         | The size in bytes of the TCP socket buffer used for _receiving_ data.<br/>Default: 4096 (4 KiB).                                                                                                                                                                                                                                                                                                                   |
| **IgnoreSubscriberErrors**          | `bool`                        | Determines if subscription processing is aborted when the worker's batch-handling code throws an unhandled exception.<br/><br/>`true` – subscription processing will continue.<br/><br/>`false` (Default) – subscription processing will be aborted.                                                                                                                                                                  |
| **CloseWhenNoDocsLeft**             | `bool`                        | Determines whether the subscription connection closes when no new documents are available.<br/><br/>`true` – The subscription worker processes all available documents and stops when none remain, at which point the `Run` method throws a `SubscriptionClosedException`.<br/>Useful for ad-hoc, one-time processing.<br/><br/>`false` (Default) – The subscription worker remains active, waiting for new documents. |
| **TimeToWaitBeforeConnectionRetry** | `TimeSpan`                    | The time to wait before attempting to reconnect after a non-aborting failure during subscription processing. Default: 5 seconds.                                                                                                                                                                                                                                                                                  |
| **MaxErroneousPeriod**              | `TimeSpan`                    | The maximum amount of time a subscription connection can remain in an erroneous state before it is terminated. Default: 5 minutes.                                                                                                                                                                                                                                                                                |
| **Strategy**                        | `SubscriptionOpeningStrategy` | This enum configures how the server handles connection attempts from workers to a specific subscription task.<br/>Default: `OpenIfFree`.                                                                                                                             |

Learn more about `SubscriptionOpeningStrategy` in [worker strategies](../../../client-api/data-subscriptions/consumption/how-to-consume-data-subscription#worker-strategies).

<TabItem value="something" label="strategy_enum">
<CodeBlock language="csharp">
{`public enum SubscriptionOpeningStrategy
\{
    // Connect if no other worker is connected 
    OpenIfFree,
    
    // Take over the connection 
    TakeOver,
    
    // Wait for currently connected worker to disconnect 
    WaitForFree,
    
    // Connect concurrently  
    Concurrent
\}
`}
</CodeBlock>
</TabItem>



## Run the subscription worker

After [creating](../../../client-api/data-subscriptions/consumption/api-overview#create-the-subscription-worker) a subscription worker, the subscription worker is still not processing any documents.  
To start processing, you need to call the `Run` method of the [SubscriptionWorker](../../../client-api/data-subscriptions/consumption/api-overview#subscriptionworker&lt;t&gt;).  

The `Run` function takes a delegate, which is your client-side code responsible for processing the received document batches.

<TabItem value="something" label="subscriptionWorkerRunning">
<CodeBlock language="csharp">
{`Task Run(Action<SubscriptionBatch<T>> processDocuments,
    CancellationToken ct = default(CancellationToken));

Task Run(Func<SubscriptionBatch<T>, Task> processDocuments,
    CancellationToken ct = default(CancellationToken));
`}
</CodeBlock>
</TabItem>

| Parameter            | Type                               | Description                                                    |
|----------------------|------------------------------------|----------------------------------------------------------------|
| **processDocuments** | `Action<SubscriptionBatch<T>>`     | Delegate for sync batches processing.                          |
| **processDocuments** | `Func<SubscriptionBatch<T>, Task>` | Delegate for async batches processing.                         |
| **ct**               | `CancellationToken`                | Cancellation token used in order to halt the worker operation. |

| Return value  |                                                                                                                                                             |
|---------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `Task`        | Task that is alive as long as the subscription worker is processing or tries processing.<br/>If the processing is aborted, the task exits with an exception. |



## SubscriptionBatch&lt;T&gt;

| Member                   | Type                              | Description                                                                                                                                                            |
|--------------------------|-----------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Items**                | `List<SubscriptionBatch<T>.Item>` | List of items in the batch.<br/>See [SubscriptionBatch&lt;T&gt;.Item](../../../client-api/data-subscriptions/consumption/api-overview#subscriptionbatch&lt;t&gt;.item) below. |
| **NumberOfItemsInBatch** | `int`                             | Number of items in the batch.                                                                                                                                          |

| Method Signature       | Return value            | Description                                                                                                       |
|------------------------|-------------------------|-------------------------------------------------------------------------------------------------------------------|
| **OpenSession()**      | `IDocumentSession`      | Open a new document session that tracks all items and their included items within the current batch.              |
| **OpenAsyncSession()** | `IAsyncDocumentSession` | Open a new asynchronous document session that tracks all items and their included items within the current batch. |

<Admonition type="info" title="Info">

##### Subscription worker connectivity

As long as there is no exception, the worker will continue addressing the same server that the first batch was received from.  
If the worker fails to reach that node, it will try to [failover](../../../client-api/configuration/load-balance/overview) to another node from the session's topology list.  
The node that the worker succeeded connecting to, will inform the worker which node is currently responsible for data subscriptions.  

</Admonition>



## SubscriptionBatch&lt;T&gt;.Item

This class represents a single item in a subscription batch results.

<TabItem value="something" label="batch_item">
<CodeBlock language="csharp">
{`public struct Item
\{
    public T Result \{ get; internal set; \}
    public string ExceptionMessage \{ get; internal set; \}
    public string Id \{ get; internal set; \}
    public string ChangeVector \{ get; internal set; \}
    public bool Projection \{ get; internal set; \}
    public bool Revision \{ get; internal set; \}
    public BlittableJsonReaderObject RawResult \{ get; internal set; \}
    public BlittableJsonReaderObject RawMetadata \{ get; internal set; \}
    public IMetadataDictionary Metadata \{ get; internal set; \}
\}
`}
</CodeBlock>
</TabItem>

| Member               | Type                        | Description                                                                                           |
|----------------------|-----------------------------|-------------------------------------------------------------------------------------------------------| 
| **Result**           | `T`                         | The current batch item.<br/>If `T` is `BlittableJsonReaderObject`, no deserialization will take place. |
| **ExceptionMessage** | `string`                    | The exception message thrown during current document processing in the server side.                   |
| **Id**               | `string`                    | The document ID of the underlying document for the current batch item.                                |
| **ChangeVector**     | `string`                    | The change vector of the underlying document for the current batch item.                              |
| **RawResult**        | `BlittableJsonReaderObject` | Current batch item before serialization to `T`.                                                       |
| **RawMetadata**      | `BlittableJsonReaderObject` | Current batch item's underlying document metadata.                                                    |
| **Metadata**         | `IMetadataDictionary`       | Current batch item's underlying metadata values.                                                      |

<Admonition type="warning" title="Warning">
This class should only be used within the subscription's `Run` delegate.  
Using it outside this scope may cause unexpected behavior.
</Admonition>



## SubscriptionWorker&lt;T&gt;

<Admonition type="note" title="Note">

##### Methods

| Method Signature                               | Return Type   | Description                                                                                                                                                                                                             |
|------------------------------------------------|---------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------| 
| **Dispose()**                                  | `void`        | Aborts subscription worker operation ungracefully by waiting for the task returned by the `Run` function to finish running.                                                                                             |
| **DisposeAsync()**                             | `Task`        | Async version of `Dispose()`.                                                                                                                                                                                           |
| **Dispose(bool waitForSubscriptionTask)**      | `void`        | Aborts the subscription worker, but allows deciding whether to wait for the `Run` function task or not.                                                                                                                 |
| **DisposeAsync(bool waitForSubscriptionTask)** | `Task`        | Async version of `DisposeAsync(bool waitForSubscriptionTask)`.                                                                                                                                                          |
| **Run (multiple overloads)**                   | `Task`        | Call `Run` to begin the worker's batch processing.<br/>Pass the batch processing delegates to this method<br/>(see [above](../../../client-api/data-subscriptions/consumption/api-overview#run-the-subscription-worker)). |

</Admonition>

<Admonition type="note" title="Note">

##### Events

| Event                             | Event type                      | Description                                                                                                                                                                     |
|-----------------------------------|:--------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------| 
| **AfterAcknowledgment**           | `AfterAcknowledgmentAction`     | Triggered after each time the server acknowledges the progress of batch processing.                                                                                             |
| **OnSubscriptionConnectionRetry** | `Action<Exception>`             | Triggered when the subscription worker attempts to reconnect to the server after a failure.<br/>The event receives as a parameter the exception that interrupted the processing. |
| **OnDisposed**                    | `Action<SubscriptionWorker<T>>` | Triggered after the subscription worker is disposed.                                                                                                                            |

<Admonition type="info" title="Info">

##### AfterAcknowledgmentAction

| Parameter   |                        |                                          |
|-------------|------------------------|------------------------------------------|
| **batch**   | `SubscriptionBatch<T>` | The batch process which was acknowledged |

| Return value   |                                                                                                         |
|----------------|---------------------------------------------------------------------------------------------------------|
| `Task`         | Task for which the worker will wait for the event processing to be finished (for async functions, etc.) |

</Admonition>

</Admonition>

<Admonition type="note" title="Note">

##### Properties

| Member                        | Type     | Description                                                           |
|-------------------------------|----------|-----------------------------------------------------------------------| 
| **CurrentNodeTag**            | `string` | The node tag of the current RavenDB server handling the subscription. |
| **SubscriptionName**          | `string` | The name of the currently processed subscription.                     |
| **WorkerId**                  | `string` | The worker ID.                                                        |

</Admonition>




</LanguageContent>
<LanguageContent language="java">

<Admonition type="note" title="Note">

* In this page:  
   * [Create the subscription worker](../../../client-api/data-subscriptions/consumption/api-overview#create-the-subscription-worker)
   * [SubscriptionWorkerOptions](../../../client-api/data-subscriptions/consumption/api-overview#subscriptionworkeroptions)  
   * [Run the subscription worker](../../../client-api/data-subscriptions/consumption/api-overview#run-the-subscription-worker)  
   * [SubscriptionBatch&lt;T&gt;](../../../client-api/data-subscriptions/consumption/api-overview#subscriptionbatch&lt;t&gt;)  
   * [SubscriptionWorker&lt;T&gt;](../../../client-api/data-subscriptions/consumption/api-overview#subscriptionworker&lt;t&gt;)  

</Admonition>
## Create the subscription worker

Subscription worker generation is accessible through the `DocumentStore`'s `subscriptions()` method, of type `DocumentSubscriptions`:
<TabItem value="something-something" label="subscriptionWorkerGeneration">
<CodeBlock language="java">
{`SubscriptionWorker<ObjectNode> getSubscriptionWorker(SubscriptionWorkerOptions options);
SubscriptionWorker<ObjectNode> getSubscriptionWorker(SubscriptionWorkerOptions options, String database);

SubscriptionWorker<ObjectNode> getSubscriptionWorker(String subscriptionName);
SubscriptionWorker<ObjectNode> getSubscriptionWorker(String subscriptionName, String database);

<T> SubscriptionWorker<T> getSubscriptionWorker(Class<T> clazz, SubscriptionWorkerOptions options);
<T> SubscriptionWorker<T> getSubscriptionWorker(Class<T> clazz, SubscriptionWorkerOptions options, String database);

<T> SubscriptionWorker<T> getSubscriptionWorker(Class<T> clazz, String subscriptionName);
<T> SubscriptionWorker<T> getSubscriptionWorker(Class<T> clazz, String subscriptionName, String database);

<T> SubscriptionWorker<Revision<T>> getSubscriptionWorkerForRevisions(Class<T> clazz, SubscriptionWorkerOptions options);
<T> SubscriptionWorker<Revision<T>> getSubscriptionWorkerForRevisions(Class<T> clazz, SubscriptionWorkerOptions options, String database);

<T> SubscriptionWorker<Revision<T>> getSubscriptionWorkerForRevisions(Class<T> clazz, String subscriptionName);
<T> SubscriptionWorker<Revision<T>> getSubscriptionWorkerForRevisions(Class<T> clazz, String subscriptionName, String database);
`}
</CodeBlock>
</TabItem>

| Parameter            |                             |                                                                                                                                                                                                |
|----------------------|-----------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **subscriptionName** | `String`                    | The subscription's name. This parameter appears in more simple overloads allowing to start processing without creating a `SubscriptionCreationOptions` instance, relying on the default values |
| **options**          | `SubscriptionWorkerOptions` | Options that affect how the worker interacts with the subscription. These options do not alter the definition of the subscription itself.                                                      |
| **database**         | `String`                    | The name of the database where the subscription task resides. If `null`, the default database configured in DocumentStore will be used.                                                        |

| Return value         |                                                                                                                                                     |
|----------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------|
| `SubscriptionWorker` | The subscription worker that has been created.<br/>Initially, it is idle and will only start processing documents when the `run` function is called. |




## SubscriptionWorkerOptions

When creating a worker with `SubscriptionWorkerOptions`, the only mandatory property is `subscriptionName`.  
All other parameters are optional and will default to their respective default values if not specified.


| Member                              | Type                                    | Description                                                                                                                                                                                                                                                                                                                                                                                                       |
|-------------------------------------|-----------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------| 
| **subscriptionName**                | `String`                                | The name of the subscription to which the worker will connect.                                                                                                                                                                                                                                                                                                                                                    |
| **timeToWaitBeforeConnectionRetry** | `Duration`                              | The time to wait before attempting to reconnect after a non-aborting failure during subscription processing. Default: 5 seconds.                                                                                                                                                                                                                                                                                  |
| **ignoreSubscriberErrors**          | `boolean`                               | Determines if subscription processing is aborted when the worker's batch-handling code throws an unhandled exception.<br/><br/>`true` – subscription processing will continue.<br/><br/>`false` (Default) – subscription processing will be aborted.                                                                                                                                                                  |
| **strategy**                        | `SubscriptionOpeningStrategy`<br/>(enum) | Configures how the server handles connection attempts from workers to a specific subscription task.<br/>Learn more in [worker strategies](../../../client-api/data-subscriptions/consumption/how-to-consume-data-subscription#worker-strategies).<br/>Default: `OPEN_IF_FREE`.                                                                                                                                      |
| **maxDocsPerBatch**                 | `int`                                   | The maximum number of documents that the server will try to retrieve and send to the client in a batch. If the server doesn't find as many documents as specified, it will send the documents it has found without waiting. Default: 4096.                                                                                                                                                                        |
| **closeWhenNoDocsLeft**             | `boolean`                               | Determines whether the subscription connection closes when no new documents are available.<br/><br/>`true` – The subscription worker processes all available documents and stops when none remain, at which point the `run` method throws a `SubscriptionClosedException`.<br/>Useful for ad-hoc, one-time processing.<br/><br/>`false` (Default) – The subscription worker remains active, waiting for new documents. |
| **sendBufferSizeInBytes**           | `int`                                   | The size in bytes of the TCP socket buffer used for _sending_ data.<br/>Default: 32,768 bytes (32 KiB).                                                                                                                                                                                                                                                                                                            |
| **receiveBufferSizeInBytes**        | `int`                                   | The size in bytes of the TCP socket buffer used for _receiving_ data.<br/>Default: 4096 (4 KiB).                                                                                                                                                                                                                                                                                                                   |



## Run the subscription worker

After [creating](../../../client-api/data-subscriptions/consumption/api-overview#create-the-subscription-worker) a subscription worker, the subscription worker is still not processing any documents.  
To start processing, you need to call the `run` method of the [SubscriptionWorker](../../../client-api/data-subscriptions/consumption/api-overview#subscriptionworker&lt;t&gt;).

The `run` function takes a delegate, which is your client-side code responsible for processing the received document batches.

<TabItem value="something-something" label="subscriptionWorkerRunning">
<CodeBlock language="java">
{`CompletableFuture<Void> run(Consumer<SubscriptionBatch<T>> processDocuments);
`}
</CodeBlock>
</TabItem>

| Parameter            |                                  |                                      |
|----------------------|----------------------------------|--------------------------------------|
| **processDocuments** | `Consumer<SubscriptionBatch<T>>` | Delegate for sync batches processing |

| Return value              |                                                                                                                                                           |
|---------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------|
| `CompletableFuture<Void>` | Task that is alive as long as the subscription worker is processing or tries processing. If the processing is aborted, the future exits with an exception | 




## SubscriptionBatch&lt;T&gt;

| Member                   | Type                              | Description                   |
|--------------------------|-----------------------------------|-------------------------------| 
| **items**                | `List<SubscriptionBatch<T>.Item>` | List of items in the batch.   |
| **numberOfItemsInBatch** | `int`                             | Number of items in the batch. |

| Method Signature   | Return value       | Description                                                                          |
|--------------------|--------------------|--------------------------------------------------------------------------------------|
| **openSession()**  | `IDocumentSession` | New document session, that tracks all items and included items of the current batch. |


<Admonition type="note" title="Subscription worker connectivity" id="subscription-worker-connectivity" href="#subscription-worker-connectivity">

As long as there is no exception, the worker will continue addressing the same 
server that the first batch was received from.  
If the worker fails to reach that node, it will try to failover to another node 
from the session's topology list.  
The node that the worker succeeded connecting to, will inform the worker which 
node is currently responsible for data subscriptions.  

</Admonition>


<Admonition type="info" title="SubscriptionBatch&lt;T&gt;.Item" id="subscriptionbatch-lt-t-gt-item" href="#subscriptionbatch-lt-t-gt-item">

<Admonition type="note" title="Note">
if T is `ObjectNode`, no deserialization will take place
</Admonition>

| Member               | Type                  | Description                                                                            |
|----------------------|-----------------------|----------------------------------------------------------------------------------------| 
| **result**           | `T`                   | Current batch item.                                                                    |
| **exceptionMessage** | `String`              | Message of the exception thrown during current document processing in the server side. |
| **id**               | `String`              | Current batch item's underlying document ID.                                           |
| **changeVector**     | `String`              | Current batch item's underlying document change vector of the current document.        |
| **rawResult**        | `ObjectNode`          | Current batch item before serialization to `T`.                                        |
| **rawMetadata**      | `ObjectNode`          | Current batch item's underlying document metadata.                                     |
| **metadata**         | `IMetadataDictionary` | Current batch item's underlying metadata values.                                       |

</Admonition>



## SubscriptionWorker&lt;T&gt;

<Admonition type="note" title="Methods" id="methods" href="#methods">

| Method Signature             | Return Type               | Description                                                                                                                                                                                                             |
|------------------------------|---------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------| 
| **close()**                  | `void`                    | Aborts subscription worker operation ungracefully by waiting for the task returned by the `run` function to finish running.                                                                                             |
| **run (multiple overloads)** | `CompletableFuture<Void>` | Call `run` to begin the worker's batch processing.<br/>Pass the batch processing delegates to this method<br/>(see [above](../../../client-api/data-subscriptions/consumption/api-overview#run-the-subscription-worker)). |

</Admonition>

<Admonition type="note" title="Events" id="events" href="#events">

| Event                              | Type\Return type                          | Description                                                                                                                                                                         |
|------------------------------------|-------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------| 
| **addAfterAcknowledgmentListener** | `Consumer<SubscriptionBatch<T>>` (event)  | Event that is risen after each the server acknowledges batch processing progress.                                                                                                   |
| **onSubscriptionConnectionRetry**  | `Consumer<Exception>` (event)             | Event that is fired when the subscription worker tries to reconnect to the server after a failure. The event receives as a parameter the exception that interrupted the processing. |
| **onClosed**                       | `Consumer<SubscriptionWorker<T>>` (event) | Event that is fired after the subscription worker was disposed.                                                                                                                     |

</Admonition>

<Admonition type="note" title="Properties" id="properties" href="#properties">

| Member               | Type\Return type   | Description                                                           |
|----------------------|--------------------|-----------------------------------------------------------------------| 
| **currentNodeTag**   | `String`           | The node tag of the current RavenDB server handling the subscription. |
| **subscriptionName** | `String`           | The name of the currently processed subscription.                     |

</Admonition>




</LanguageContent>
<LanguageContent language="python">

<Admonition type="note" title="Note">

* In this page:  
   * [Create the subscription worker](../../../client-api/data-subscriptions/consumption/api-overview#create-the-subscription-worker)
   * [`SubscriptionWorkerOptions`](../../../client-api/data-subscriptions/consumption/api-overview#subscriptionworkeroptions)  
   * [Run the subscription worker](../../../client-api/data-subscriptions/consumption/api-overview#run-the-subscription-worker)  
   * [`SubscriptionBatch[_T]`](../../../client-api/data-subscriptions/consumption/api-overview#subscriptionbatch[_t])  
   * [`SubscriptionWorker[_T]`](../../../client-api/data-subscriptions/consumption/api-overview#subscriptionworker[_t])  

</Admonition>
## Create the subscription worker

Create a subscription worker using `get_subscription_worker` or `get_subscription_worker_by_name`.  

* Use the `get_subscription_worker` method to specify the subscription options while creating the worker.  
* Use the `get_subscription_worker_by_name` method to create the worker using the default options.  

<TabItem value="something-something" label="subscriptionWorkerGeneration">
<CodeBlock language="python">
{`def get_subscription_worker(
    self, options: SubscriptionWorkerOptions, object_type: Optional[Type[_T]] = None, database: Optional[str] = None
) -> SubscriptionWorker[_T]: ...

def get_subscription_worker_by_name(
    self,
    subscription_name: Optional[str] = None,
    object_type: Optional[Type[_T]] = None,
    database: Optional[str] = None,
) -> SubscriptionWorker[_T]: ...
`}
</CodeBlock>
</TabItem>

| Parameter                        |                             |                                                                                                                                                      |
|----------------------------------|-----------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------|
| **options**                      | `SubscriptionWorkerOptions` | Options that affect how the worker interacts with the subscription. These options do not alter the definition of the subscription itself.            |
| **object_type** (Optional)       | `Type[_T]`                  | Defines the object type (class) for the items that will be included in the received `SubscriptionBatch` object.                                      |
| **database** (Optional)          | `str`                       | The name of the database where the subscription task resides. If `None`, the default database configured in DocumentStore will be used.              |
| **subscription_name** (Optional) | `str`                       | The subscription's name. Used when the worker is generated without creating a `SubscriptionCreationOptions` instance, relying on the default values. |

| Return value         |                                                                                                                                                     |
|----------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------|
| `SubscriptionWorker` | The subscription worker that has been created.<br/>Initially, it is idle and will only start processing documents when the `run` function is called. |



## `SubscriptionWorkerOptions`

When creating a worker with `SubscriptionWorkerOptions`, the only mandatory property is `subscription_name`.  
All other parameters are optional and will default to their respective default values if not specified.

| Member                                   | Type                                    | Description                                                                                                                                                                                                                                                                                                                                                                                                       |
|------------------------------------------|-----------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------| 
| **subscription_name**                    | `str`                                   | The name of the subscription to which the worker will connect.                                                                                                                                                                                                                                                                                                                                                    |
| **time_to_wait_before_connection_retry** | `timedelta`                             | The time to wait before attempting to reconnect after a non-aborting failure during subscription processing. Default: 5 seconds.                                                                                                                                                                                                                                                                                  |
| **ignore_subscriber_errors**             | `bool`                                  | Determines if subscription processing is aborted when the worker's batch-handling code throws an unhandled exception.<br/><br/>`True` – subscription processing will continue.<br/><br/>`False` (Default) – subscription processing will be aborted.                                                                                                                                                                  |
| **max_docs_per_batch**                   | `int`                                   | The maximum number of documents that the server will try to retrieve and send to the client in a batch. If the server doesn't find as many documents as specified, it will send the documents it has found without waiting. Default: 4096.                                                                                                                                                                        |
| **close_when_no_docs_left**              | `bool`                                  | Determines whether the subscription connection closes when no new documents are available.<br/><br/>`True` – The subscription worker processes all available documents and stops when none remain, at which point the `run` method throws a `SubscriptionClosedException`.<br/>Useful for ad-hoc, one-time processing.<br/><br/>`False` (Default) – The subscription worker remains active, waiting for new documents. |
| **send_buffer_size_in_bytes**            | `int`                                   | The size in bytes of the TCP socket buffer used for _sending_ data.<br/>Default: 32,768 bytes (32 KiB).                                                                                                                                                                                                                                                                                                            |
| **receive_buffer_size_in_bytes**         | `int`                                   | The size in bytes of the TCP socket buffer used for _receiving_ data.<br/>Default: 4096 (4 KiB).                                                                                                                                                                                                                                                                                                                   |
| **strategy**                             | `SubscriptionOpeningStrategy`<br/>(enum) | Configures how the server handles connection attempts from workers to a specific subscription task.<br/>Learn more in [worker strategies](../../../client-api/data-subscriptions/consumption/how-to-consume-data-subscription#worker-strategies).<br/>Default: `OPEN_IF_FREE`.                                                                                                                                      |

<Admonition type="note" title="Note">

Learn more about `SubscriptionOpeningStrategy` in [worker strategies](../../../client-api/data-subscriptions/consumption/how-to-consume-data-subscription#worker-strategies).

| `SubscriptionOpeningStrategy`   |                                                   |
|---------------------------------|---------------------------------------------------|
| `OPEN_IF_FREE`                  | Connect if no other worker is connected           |
| `WAIT_FOR_FREE`                 | Wait for currently connected worker to disconnect |
| `TAKE_OVER`                     | Take over the connection                          |
| `CONCURRENT`                    | Connect concurrently                              |

</Admonition>



## Run the subscription worker

After [creating](../../../client-api/data-subscriptions/consumption/api-overview#create-the-subscription-worker) a subscription worker, the subscription worker is still not processing any documents.  
To start processing, you need to call the `run` function of the [SubscriptionWorker](../../../client-api/data-subscriptions/consumption/api-overview#subscriptionworker[_t]).

The `run` function receives the client-side code as a function that will process the received document batches.

<TabItem value="something-something" label="subscriptionWorkerRunning">
<CodeBlock language="python">
{`def run(self, process_documents: Optional[Callable[[SubscriptionBatch[_T]], Any]]) -> Future: ...
`}
</CodeBlock>
</TabItem>

| Parameter                        |                                            |                                   |
|----------------------------------|--------------------------------------------|-----------------------------------|
| **process_documents** (Optional) | `[Callable[[SubscriptionBatch[_T]], Any]]` | Delegate to sync batch processing |




## `SubscriptionBatch[_T]`

| Member                       | Type                               | Description                  |
|------------------------------|------------------------------------|------------------------------| 
| **items**                    | `SubscriptionBatch[_T].Item` array | List of items in the batch   |
| **number_of_items_in_batch** | `int`                              | Number of items in the batch |

<TabItem value="something-something" label="number_of_items_in_batch_definition">
<CodeBlock language="python">
{`def number_of_items_in_batch(self) -> int:
    return 0 if self.items is None else len(self.items)
`}
</CodeBlock>
</TabItem>


<Admonition type="note" title="Subscription worker connectivity" id="subscription-worker-connectivity" href="#subscription-worker-connectivity">
As long as there is no exception, the worker will continue addressing the same 
server that the first batch was received from.  
If the worker fails to reach that node, it will try to 
[failover](../../../client-api/configuration/load-balance/overview) to another node 
from the session's topology list.  
The node that the worker succeeds connecting to, will inform the worker which 
node is currently responsible for data subscriptions.  
</Admonition>

<TabItem value="something-something" label="Item_definition">
<CodeBlock language="python">
{`class Item(Generic[_T_Item]):
    """
    Represents a single item in a subscription batch results.
    This class should be used only inside the subscription's run delegate,
    using it outside this scope might cause unexpected behavior.
    """
`}
</CodeBlock>
</TabItem>
<TabItem value="something-something" label="SubscriptionBatch_definition">
<CodeBlock language="python">
{`class SubscriptionBatch(Generic[_T]):

def __init__(self):
    self._result: Optional[_T_Item] = None
    self._exception_message: Optional[str] = None
    self._key: Optional[str] = None
    self._change_vector: Optional[str] = None
    self._projection: Optional[bool] = None
    self._revision: Optional[bool] = None
    self.raw_result: Optional[Dict] = None
    self.raw_metadata: Optional[Dict] = None
    self._metadata: Optional[MetadataAsDictionary] = None
`}
</CodeBlock>
</TabItem>

| `SubscriptionBatch[_T].item` Member   | Type                   | Description                                                                           |
|---------------------------------------|------------------------|---------------------------------------------------------------------------------------| 
| **\_result** (Optional)               | `_T_Item`              | Current batch item                                                                    |
| **\_exception_message** (Optional)    | `str`                  | Message of the exception thrown during current document processing in the server side |
| **\_key** (Optional)                  | `str`                  | Current batch item underlying document ID                                             |
| **\_change_vector** (Optional)        | `str`                  | Current batch item underlying document change vector of the current document          |
| **\_projection** (Optional)           | `bool`                 | indicates whether the value id a projection                                           |
| **raw_result** (Optional)             | `Dict`                 | Current batch item before serialization to `T`                                        |
| **raw_metadata** (Optional)           | `Dict`                 | Current batch item underlying document metadata                                       |
| **\_metadata** (Optional)             | `MetadataAsDictionary` | Current batch item underlying metadata values                                         |

<Admonition type="warning" title="Warning">
Usage of `raw_result`, `raw_metadata`, and `_metadata` values outside of the document processing delegate 
is not supported.
</Admonition>



## `SubscriptionWorker[_T]`
### Methods:

| Method                                          | Return Type    | Description                                                                                                                                                                                                             |
|-------------------------------------------------|----------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------| 
| `close(bool wait_for_subscription_task = True)` | `void`         | Aborts subscription worker operation ungracefully by waiting for the task returned by the `run` function to finish running.                                                                                             |
| `run`                                           | `Future[None]` | Call `run` to begin the worker's batch processing.<br/>Pass the batch processing delegates to this method<br/>(see [above](../../../client-api/data-subscriptions/consumption/api-overview#run-the-subscription-worker)). |
### Events:

| Event                     | Type\Return type                          | Description                                                                      |
|---------------------------|-------------------------------------------|----------------------------------------------------------------------------------| 
| **after\_acknowledgment** | `Callable[[SubscriptionBatch[_T]], None]` | Event invoked after each time the server acknowledges batch processing progress. |

| `after_acknowledgment` Parameters  |                         |                                          |
|------------------------------------|-------------------------|------------------------------------------|
| **batch**                          | `SubscriptionBatch[_T]` | The batch process which was acknowledged |

| Return value   |                                                              |
|----------------|--------------------------------------------------------------|
| `Future[None]` | The worker waits for the task to finish the event processing |

### Properties:

| Member                | Type    | Description                                                           |
|-----------------------|---------|-----------------------------------------------------------------------| 
| **current_node_tag**  | `str`   | The node tag of the current RavenDB server handling the subscription. |
| **subscription_name** | `str`   | The name of the currently processed subscription.                     |




</LanguageContent>
<LanguageContent language="nodejs">

<Admonition type="note" title="Note">

* In this page:  
  * [Create the subscription worker](../../../client-api/data-subscriptions/consumption/api-overview#create-the-subscription-worker)  
  * [Subscription worker options](../../../client-api/data-subscriptions/consumption/api-overview#subscription-worker-options)  
  * [Run the subscription worker](../../../client-api/data-subscriptions/consumption/api-overview#run-the-subscription-worker)  
  * [Subscription batch](../../../client-api/data-subscriptions/consumption/api-overview#subscription-batch)  
  * [Subscription batch item](../../../client-api/data-subscriptions/consumption/api-overview#subscription-batch-item)  
  * [Subscription worker](../../../client-api/data-subscriptions/consumption/api-overview#subscription-worker)  

</Admonition>
## Create the subscription worker

A subscription worker can be created using the following `getSubscriptionWorker` methods available through the `subscriptions` property of the `documentStore`.

Note: Simply creating the worker is insufficient;  
after creating the worker, you need to [run the subscription worker](../../../client-api/data-subscriptions/consumption/api-overview#run-the-subscription-worker) to initiate document processing.

<TabItem value="something-something" label="consume_syntax_1">
<CodeBlock language="nodejs">
{`await documentStore.subscriptions.getSubscriptionWorker(subscriptionName);
await documentStore.subscriptions.getSubscriptionWorker(subscriptionName, database);

await documentStore.subscriptions.getSubscriptionWorker(options);
await documentStore.subscriptions.getSubscriptionWorker(options, database);
`}
</CodeBlock>
</TabItem>

| Parameter            | Type     | Description                                                                                                                                                                                                                                                         |
|----------------------|----------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **subscriptionName** | `string` | The name of the subscription to which the worker will connect.                                                                                                                                                                                                      |
| **database**         | `string` | The name of the database where the subscription task resides.<br/>If `null`, the default database configured in DocumentStore will be used.                                                                                                                          |
| **options**          | `object` | [Subscription worker options](../../../client-api/data-subscriptions/consumption/api-overview#subscription-worker-options) object that affect how the worker interacts with the subscription. These options do not alter the definition of the subscription itself. |

| Return value         |                                                                                                                                                                                                                                                                       |
|----------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `SubscriptionWorker` | The [subscription worker](../../../client-api/data-subscriptions/consumption/api-overview#subscription-worker) that has been created.<br/>The worker will start processing documents once you define the worker's `on` method,<br/> which listens to the `batch` event. |



## Subscription worker options

<TabItem value="something-something" label="consume_syntax_2">
<CodeBlock language="nodejs">
{`// The SubscriptionWorkerOptions object:
// =====================================
\{
    subscriptionName;
    documentType;
    ignoreSubscriberErrors;
    closeWhenNoDocsLeft;
    maxDocsPerBatch;
    timeToWaitBeforeConnectionRetry;
    maxErroneousPeriod;            
    strategy;
\}
`}
</CodeBlock>
</TabItem>

When creating a worker with subscription worker options, the only mandatory property is `subscriptionName`.  
All other parameters are optional and will default to their respective default values if not specified.

| Member                              | Type      | Description                                                                                                                                                                                                                                                                                                                                                                                                |
|-------------------------------------|-----------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------| 
| **subscriptionName**                | `string`  | The name of the subscription to which the worker will connect.                                                                                                                                                                                                                                                                                                                                             |
| **documentType**                    | `object`  | The class type of the subscription documents.                                                                                                                                                                                                                                                                                                                                                              |
| **ignoreSubscriberErrors**          | `boolean` | Determines if subscription processing is aborted when the worker's batch-handling code throws an unhandled exception.<br/><br/>`true` – subscription processing will continue.<br/><br/>`false` (default) – subscription processing will be aborted.                                                                                                                                                           |
| **closeWhenNoDocsLeft**             | `boolean` | Determines whether the subscription connection closes when no new documents are available.<br/><br/>`true` – The subscription worker processes all available documents and stops when none remain, at which point the `SubscriptionClosedException` will be thrown.<br/>Useful for ad-hoc, one-time processing.<br/><br/>`false` (default) – The subscription worker remains active, waiting for new documents. |
| **maxDocsPerBatch**                 | `number`  | The maximum number of documents that the server will try to retrieve and send to the client in a batch. If the server doesn't find as many documents as specified, it will send the documents it has found without waiting. Default: 4096.                                                                                                                                                                 |
| **timeToWaitBeforeConnectionRetry** | `number`  | The time (in ms) to wait before attempting to reconnect after a non-aborting failure during subscription processing. Default: 5 seconds.                                                                                                                                                                                                                                                                   |
| **maxErroneousPeriod**              | `number`  | The maximum amount of time (in ms) a subscription connection can remain in an erroneous state before it is terminated. Default: 5 minutes.                                                                                                                                                                                                                                                                 |
| **strategy**                        | `string`  | The strategy configures how the server handles connection attempts from workers to a specific subscription task.<br/><br/>Available options:<br/>`OpenIfFree` (default), `TakeOver`, `WaitForFree`, or `Concurrent`.<br/><br/>Learn more in [worker strategies](../../../client-api/data-subscriptions/consumption/how-to-consume-data-subscription#worker-strategies).                                         |



## Run the subscription worker

After [creating](../../../client-api/data-subscriptions/consumption/api-overview#create-the-subscription-worker) a subscription worker, the subscription worker is still not processing any documents.  
To initiate processing, you need to define an event handler and attach it to the worker's `batch` event listener.  

This handler contains your client-side code responsible for processing the document batches received from the server. 
Whenever a new batch of documents is ready, the provided handler will be triggered.

<TabItem value="something-something" label="consume_syntax_3">
<CodeBlock language="nodejs">
{`subscriptionWorker.on("batch", (batch, callback) => \{
    // Process incoming items:
    // =======================
    
    // 'batch': 
    // Contains the documents to be processed.
    
    // callback(): 
    // Needs to be called after processing the batch 
    // to notify the worker that you're done processing.
\});
`}
</CodeBlock>
</TabItem>



## Subscription batch

The subscription batch class contains the following public properties & methods:

| Property                      | Type       | Description                                                                                                                                            |
|-------------------------------|------------|--------------------------------------------------------------------------------------------------------------------------------------------------------| 
| **items**                     | `Item[]`   | List of items in the batch.<br/>See [subscription batch item](../../../client-api/data-subscriptions/consumption/api-overview#subscription-batch-item). |

| Method                        | Return type | Description                                                                                                              |
|-------------------------------|-------------|--------------------------------------------------------------------------------------------------------------------------| 
| **getNumberOfItemsInBatch()** | `number`    | Get the number of items in the batch.                                                                                    |
| **getNumberOfIncludes()**     | `number`    | Get the number of included documents in the batch.                                                                       |
| **openSession()**             | `object`    | Open a new document session that tracks all items and their included items within the current batch.                     |
| **openSession(options)**      | `object`    | Open a new document session - can pass [session options](../../../client-api/session/opening-a-session#session-options). |

<Admonition type="info" title="Info">

##### Subscription worker connectivity

As long as there is no exception, the worker will continue addressing the same server that the first batch was received from.  
If the worker fails to reach that node, it will try to [failover](../../../client-api/configuration/load-balance/overview) to another node from the session's topology list.  
The node that the worker succeeded connecting to, will inform the worker which node is currently responsible for data subscriptions.

</Admonition>



## Subscription batch item

This class represents a single item in a subscription batch result.

<TabItem value="something-something" label="consume_syntax_4">
<CodeBlock language="nodejs">
{`class Item
\{
    result;
    exceptionMessage;
    id;
    changeVector;
    projection;
    revision;
    rawResult;
    rawMetadata;
    metadata;
\}
`}
</CodeBlock>
</TabItem>

| Member               | Type      | Description                                                                         |
|----------------------|-----------|-------------------------------------------------------------------------------------| 
| **result**           | `object`  | The current batch item.                                                             |
| **exceptionMessage** | `string`  | The exception message thrown during current document processing in the server side. |
| **id**               | `string`  | The document ID of the underlying document for the current batch item.              |
| **changeVector**     | `string`  | The change vector of the underlying document for the current batch item.            |
| **rawResult**        | `object`  | Current batch item - no types reconstructed.                                        |
| **rawMetadata**      | `object`  | Current batch item's underlying document metadata.                                  |
| **metadata**         | `object`  | Current batch item's underlying metadata values.                                    |



## Subscription worker

<Admonition type="note" title="Note">

##### Methods

| Method            | Return type   | Description                                       |
|-------------------|---------------|---------------------------------------------------| 
| **dispose()**     | `void`        | Aborts subscription worker operation.             |
| **on()**          | `object`      | Method used to set up event listeners & handlers. |
| **getWorkerId()** | `string`      | Get the worker ID.                                |

</Admonition>

<Admonition type="note" title="Note">

##### Events

| Event                             | Listener signature          | Description                                                                                                                                                                   |
|-----------------------------------|-----------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **"batch"**                       | `(batch, callback) => void` | Emitted when a batch of documents is sent from the server to the client.<br/><br/>Once processing is done, `callback` *must  be called* in order to continue batches' emission. |
| **"afterAcknowledgment"**         | `(batch, callback) => void` | Emitted after each time the server acknowledges the progress of batch processing.                                                                                             |
| **"connectionRetry"**             | `(error) => void`           | Emitted when the worker attempts to reconnect to the server after a failure.                                                                                                  |
| **"error"**                       | `(error) => void`           | Emitted on subscription errors.                                                                                                                                               |
| **"end"**                         | `(error) => void`          | Emitted when subscription is finished.<br/>No more batches are going to be emitted.                                                                                            |

</Admonition>

<Admonition type="note" title="Note">

##### Properties

| Member               | Type     | Description                                                           |
|----------------------|----------|-----------------------------------------------------------------------| 
| **currentNodeTag**   | `string` | The node tag of the current RavenDB server handling the subscription. |
| **subscriptionName** | `string` | The name of the currently processed subscription.                     |

</Admonition>




</LanguageContent>

<!---
### Data Subscriptions:
- [What are Data Subscriptions](../../../client-api/data-subscriptions/what-are-data-subscriptions)
- [How to Create a Data Subscription](../../../client-api/data-subscriptions/creation/how-to-create-data-subscription)
- [How to Consume a Data Subscription](../../../client-api/data-subscriptions/consumption/how-to-consume-data-subscription)


-->