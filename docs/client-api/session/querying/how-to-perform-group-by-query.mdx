---
title: "Perform Dynamic Group By Query"
hide_table_of_contents: true
sidebar_label: Perform Group By Query
sidebar_position: 7
---

import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';
import LanguageSwitcher from "@site/src/components/LanguageSwitcher";
import LanguageContent from "@site/src/components/LanguageContent";

export const supportedLanguages = ["csharp", "java", "python", "php", "nodejs"];


# Perform Dynamic Group By Query
<LanguageSwitcher supportedLanguages={supportedLanguages} />
<LanguageContent language="csharp">


Since RavenDB 4.0, the query optimizer supports dynamic group by queries and automatically creates auto map-reduce indexes.

You can create a dynamic query that does an aggregation by using the LINQ `GroupBy()` method or `group by into` syntax.

The supported aggregation operations are:

- `Count`
- `Sum`

&lt;br /&gt;

## Group By Single Field

<Tabs groupId='languageSyntax'>
<TabItem value="Sync" label="Sync">
<CodeBlock language="csharp">
{`var results = (from o in session.Query<Order>()
        group o by o.ShipTo.Country
        into g
        select new
        {
            Country = g.Key,
            OrderedQuantity = g.Sum(order => order.Lines.Sum(line => line.Quantity))
        })
    .ToList();
`}
</CodeBlock>
</TabItem>
<TabItem value="Async" label="Async">
<CodeBlock language="csharp">
{`var results = await (from o in asyncSession.Query<Order>()
        group o by o.ShipTo.Country
        into g
        select new
        {
            Country = g.Key,
            OrderedQuantity = g.Sum(order => order.Lines.Sum(line => line.Quantity))
        })
    .ToListAsync();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders
group by ShipTo.City
select ShipTo.City as Country, sum(Lines[].Quantity) as TotalQuantity
`}
</CodeBlock>
</TabItem>
</Tabs>



## Group By Multiple Fields

<Tabs groupId='languageSyntax'>
<TabItem value="Sync" label="Sync">
<CodeBlock language="csharp">
{`var results = session.Query<Order>()
    .GroupBy(x => new
    {
        x.Employee,
        x.Company
    })
    .Select(x => new
    {
        EmployeeIdentifier = x.Key.Employee,
        x.Key.Company,
        Count = x.Count()
    })
    .ToList();
`}
</CodeBlock>
</TabItem>
<TabItem value="Async" label="Async">
<CodeBlock language="csharp">
{`var results = await asyncSession.Query<Order>()
    .GroupBy(x => new
    {
        x.Employee,
        x.Company
    })
    .Select(x => new
    {
        EmployeeIdentifier = x.Key.Employee,
        x.Key.Company,
        Count = x.Count()
    })
    .ToListAsync();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders
group by Employee, Company
select Employee as EmployeeIdentifier, Company, count()
`}
</CodeBlock>
</TabItem>
</Tabs>



## Select Composite GroupBy Key

<Tabs groupId='languageSyntax'>
<TabItem value="Sync" label="Sync">
<CodeBlock language="csharp">
{`var results = session.Query<Order>()
    .GroupBy(x => new EmployeeAndCompany
    {
        Employee = x.Employee,
        Company = x.Company
    })
    .Select(x => new CountOfEmployeeAndCompanyPairs
    {
        EmployeeCompanyPair = x.Key,
        Count = x.Count()
    })
    .ToList();
`}
</CodeBlock>
</TabItem>
<TabItem value="Async" label="Async">
<CodeBlock language="csharp">
{`var results = await asyncSession.Query<Order>()
    .GroupBy(x => new EmployeeAndCompany
    {
        Employee = x.Employee,
        Company = x.Company
    })
    .Select(x => new CountOfEmployeeAndCompanyPairs
    {
        EmployeeCompanyPair = x.Key,
        Count = x.Count()
    })
    .ToListAsync();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by Employee, Company
select key() as EmployeeCompanyPair, count()
`}
</CodeBlock>
</TabItem>
</Tabs>



## Group By Array

### By Array Values

In order to group by values of array, you need to use `GroupByArrayValues`. The following query will group by `Product` property from `Lines` collection 
and calculate the count per ordered products. Underneath a fanout, an auto map-reduce index will be created to handle such query. 

<Tabs groupId='languageSyntax'>
<TabItem value="Sync" label="Sync">
<CodeBlock language="csharp">
{`var results = session.Query<Order>()
    .GroupByArrayValues(x => x.Lines.Select(y => y.Product))
    .Select(x => new
    {
        Count = x.Count(),
        Product = x.Key
    })
    .ToList();
`}
</CodeBlock>
</TabItem>
<TabItem value="Async" label="Async">
<CodeBlock language="csharp">
{`var results = await asyncSession.Query<Order>()
    .GroupByArrayValues(x => x.Lines.Select(y => y.Product))
    .Select(x => new
    {
        Count = x.Count(),
        Product = x.Key
    })
    .ToListAsync();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by Lines[].Product
select Lines[].Product, count()
`}
</CodeBlock>
</TabItem>
</Tabs>

Inside a single group by statement you can mix collection values and value of another property. That's supported by `DocumentQuery` only:

<Tabs groupId='languageSyntax'>
<TabItem value="Sync" label="Sync">
<CodeBlock language="csharp">
{`var results = session.Advanced.DocumentQuery<Order>()
    .GroupBy("Lines[].Product", "ShipTo.Country")
    .SelectKey("Lines[].Product", "Product")
    .SelectKey("ShipTo.Country", "Country")
    .SelectCount()
    .OfType<ProductInfo>()
    .ToList();
`}
</CodeBlock>
</TabItem>
<TabItem value="Async" label="Async">
<CodeBlock language="csharp">
{`var results = await asyncSession.Advanced.AsyncDocumentQuery<Order>()
    .GroupBy("Lines[].Product", "ShipTo.Country")
    .SelectKey("Lines[].Product", "Product")
    .SelectKey("ShipTo.Country", "Country")
    .SelectCount()
    .OfType<ProductInfo>()
    .ToListAsync();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by Lines[].Product, ShipTo.Country 
select Lines[].Product as Product, ShipTo.Country as Country, count()
`}
</CodeBlock>
</TabItem>
</Tabs>

Grouping by multiple values from **the same** collection is supported as well:

<Tabs groupId='languageSyntax'>
<TabItem value="Sync" label="Sync">
<CodeBlock language="csharp">
{`var results = session.Query<Order>()
    .GroupByArrayValues(x => x.Lines.Select(y => new
    {
        y.Product,
        y.Quantity
    }))
    .Select(x => new ProductInfo
    {
        Count = x.Count(),
        Product = x.Key.Product,
        Quantity = x.Key.Quantity
    })
    .ToList();
`}
</CodeBlock>
</TabItem>
<TabItem value="Async" label="Async">
<CodeBlock language="csharp">
{`var results = await asyncSession.Query<Order>()
    .GroupByArrayValues(x => x.Lines.Select(y => new
    {
        y.Product,
        y.Quantity
    }))
    .Select(x => new ProductInfo
    {
        Count = x.Count(),
        Product = x.Key.Product,
        Quantity = x.Key.Quantity
    })
    .ToListAsync();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by Lines[].Product, Lines[].Quantity 
select Lines[].Product as Product, Lines[].Quantity as Quantity, count()
`}
</CodeBlock>
</TabItem>
</Tabs>

### By Array Content

Another option is to group by array content. The reduction key will be calculated based on all values of a collection specified in `GroupBy`.
The client API exposes the `GroupByArrayContent` extension method for that purpose.

<Tabs groupId='languageSyntax'>
<TabItem value="Sync" label="Sync">
<CodeBlock language="csharp">
{`var results = session.Query<Order>()
    .GroupByArrayContent(x => x.Lines.Select(y => y.Product))
    .Select(x => new ProductsInfo
    {
        Count = x.Count(),
        Products = x.Key
    })
    .ToList();
`}
</CodeBlock>
</TabItem>
<TabItem value="Async" label="Async">
<CodeBlock language="csharp">
{`var results = await asyncSession.Query<Order>()
    .GroupByArrayContent(x => x.Lines.Select(y => y.Product))
    .Select(x => new ProductsInfo
    {
        Count = x.Count(),
        Products = x.Key
    })
    .ToListAsync();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders
group by array(Lines[].Product)
select key() as Products, count()
`}
</CodeBlock>
</TabItem>
</Tabs>

Grouping by array content and a value of another property is supported by `DocumentQuery`:

<Tabs groupId='languageSyntax'>
<TabItem value="Sync" label="Sync">
<CodeBlock language="csharp">
{`var results = session.Advanced.DocumentQuery<Order>()
    .GroupBy(("Lines[].Product", GroupByMethod.Array), ("ShipTo.Country", GroupByMethod.None))
    .SelectKey("Lines[].Product", "Products")
    .SelectKey("ShipTo.Country", "Country")
    .SelectCount()
    .OfType<ProductsInfo>()
    .ToList();
`}
</CodeBlock>
</TabItem>
<TabItem value="Async" label="Async">
<CodeBlock language="csharp">
{`var results = await asyncSession.Advanced.AsyncDocumentQuery<Order>()
    .GroupBy(("Lines[].Product", GroupByMethod.Array), ("ShipTo.Country", GroupByMethod.None))
    .SelectKey("Lines[].Product", "Products")
    .SelectKey("ShipTo.Country", "Country")
    .SelectCount()
    .OfType<ProductsInfo>()
    .ToListAsync();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by array(Lines[].Product), ShipTo.Country 
select Lines[].Product as Products, ShipTo.Country as Country, count()
`}
</CodeBlock>
</TabItem>
</Tabs>

Grouping by multiple values from **the same** collection is also supported by `DocumentQuery`:

<Tabs groupId='languageSyntax'>
<TabItem value="Sync" label="Sync">
<CodeBlock language="csharp">
{`var results = session.Advanced.DocumentQuery<Order>()
    .GroupBy(("Lines[].Product", GroupByMethod.Array), ("Lines[].Quantity", GroupByMethod.Array))
    .SelectKey("Lines[].Product", "Products")
    .SelectKey("Lines[].Quantity", "Quantities")
    .SelectCount()
    .OfType<ProductsInfo>()
    .ToList();
`}
</CodeBlock>
</TabItem>
<TabItem value="Async" label="Async">
<CodeBlock language="csharp">
{`var results = await asyncSession.Advanced.AsyncDocumentQuery<Order>()
    .GroupBy(("Lines[].Product", GroupByMethod.Array), ("Lines[].Quantity", GroupByMethod.Array))
    .SelectKey("Lines[].Product", "Products")
    .SelectKey("Lines[].Quantity", "Quantities")
    .SelectCount()
    .OfType<ProductsInfo>()
    .ToListAsync();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by array(Lines[].Product), array(Lines[].Quantity) 
select Lines[].Product as Products, Lines[].Quantity as Quantities, count()
`}
</CodeBlock>
</TabItem>
</Tabs>

<Admonition type="note" title="Note" id="note" href="#note">
In order to use the above extension methods you need to add the following **using** statement:

<TabItem value="group_by_using" label="group_by_using">
<CodeBlock language="csharp">
{`using Raven.Client.Documents;
`}
</CodeBlock>
</TabItem>
</Admonition>



## Sorting

Results of dynamic group by queries can be sorted by an aggregation function used in the query. As the available aggregation operations are `Count` and `Sum` you can use them to
order the results.

#### By Count

<Tabs groupId='languageSyntax'>
<TabItem value="Sync" label="Sync">
<CodeBlock language="csharp">
{`var results = session.Query<Order>()
    .GroupBy(x => x.Employee)
    .Select(x => new
    {
        Employee = x.Key,
        Count = x.Count()
    })
    .OrderBy(x => x.Count)
    .ToList();
`}
</CodeBlock>
</TabItem>
<TabItem value="Async" label="Async">
<CodeBlock language="csharp">
{`var results = await asyncSession.Query<Order>()
    .GroupBy(x => x.Employee)
    .Select(x => new
    {
        Employee = x.Key,
        Count = x.Count()
    })
    .OrderBy(x => x.Count)
    .ToListAsync();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by Employee 
order by count() as long 
select Employee, count()
`}
</CodeBlock>
</TabItem>
</Tabs>

#### By Sum

<Tabs groupId='languageSyntax'>
<TabItem value="Sync" label="Sync">
<CodeBlock language="csharp">
{`var results = session.Query<Order>()
    .GroupBy(x => x.Employee)
    .Select(x => new
    {
        Employee = x.Key,
        Sum = x.Sum(y => y.Freight)
    })
    .OrderBy(x => x.Sum)
    .ToList();
`}
</CodeBlock>
</TabItem>
<TabItem value="Async" label="Async">
<CodeBlock language="csharp">
{`var results = await asyncSession.Query<Order>()
    .GroupBy(x => x.Employee)
    .Select(x => new
    {
        Employee = x.Key,
        Count = x.Count()
    })
    .OrderBy(x => x.Count)
    .ToListAsync();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by Employee 
order by sum(Freight) as double 
select key() as Employee, sum(Freight) as Sum
`}
</CodeBlock>
</TabItem>
</Tabs>




</LanguageContent>
<LanguageContent language="java">


Since RavenDB 4.0, the query optimizer supports dynamic group by queries and automatically creates auto map-reduce indexes.

You can create a dynamic query that does an aggregation by using the `groupBy()` method.

The supported aggregation operations are:

- `count`
- `sum`

&lt;br /&gt;

## Group By Single Field

<Tabs groupId='languageSyntax'>
<TabItem value="Java" label="Java">
<CodeBlock language="java">
{`List<CountryAndQuantity> orders = session.query(Order.class)
    .groupBy("ShipTo.Country")
    .selectKey("ShipTo.Country", "Country")
    .selectSum(new GroupByField("Lines[].Quantity", "OrderedQuantity"))
    .ofType(CountryAndQuantity.class)
    .toList();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders
group by ShipTo.City
select ShipTo.City as Country, sum(Lines[].Quantity) as TotalQuantity
`}
</CodeBlock>
</TabItem>
</Tabs>



## Group By Multiple Fields

<Tabs groupId='languageSyntax'>
<TabItem value="Java" label="Java">
<CodeBlock language="java">
{`List<CountByCompanyAndEmployee> results = session.query(Order.class)
    .groupBy("Employee", "Company")
    .selectKey("Employee", "EmployeeIdentifier")
    .selectKey("Company")
    .selectCount()
    .ofType(CountByCompanyAndEmployee.class)
    .toList();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders
group by Employee, Company
select Employee as EmployeeIdentifier, Company, count()
`}
</CodeBlock>
</TabItem>
</Tabs>



## Select Composite GroupBy Key

<Tabs groupId='languageSyntax'>
<TabItem value="Java" label="Java">
<CodeBlock language="java">
{`List<CountOfEmployeeAndCompanyPairs> orders = session.query(Order.class)
    .groupBy("Employee", "Company")
    .selectKey("key()", "EmployeeCompanyPair")
    .selectCount("Count")
    .ofType(CountOfEmployeeAndCompanyPairs.class)
    .toList();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by Employee, Company
select key() as EmployeeCompanyPair, count()
`}
</CodeBlock>
</TabItem>
</Tabs>



## Group By Array

### By Array Values

In order to group by values of array, you need to use `groupBy(array(...))`. The following query will group by `product` field from `Lines` collection 
and calculate the count per ordered products. Underneath a fanout, an auto map-reduce index will be created to handle such query. 

<Tabs groupId='languageSyntax'>
<TabItem value="Java" label="Java">
<CodeBlock language="java">
{`List<ProductsInfo> products = session.query(Order.class)
    .groupBy(array("Lines[].Product"))
    .selectKey("key()", "Products")
    .selectCount()
    .ofType(ProductsInfo.class)
    .toList();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by Lines[].Product
select Lines[].Product, count()
`}
</CodeBlock>
</TabItem>
</Tabs>

Inside a single group by statement you can mix collection values and value of another property. That's supported by `DocumentQuery` only:

<Tabs groupId='languageSyntax'>
<TabItem value="Java" label="Java">
<CodeBlock language="java">
{`List<ProductInfo> results = session.advanced().documentQuery(Order.class)
    .groupBy("Lines[].Product", "ShipTo.Country")
    .selectKey("Lines[].Product", "Product")
    .selectKey("ShipTo.Country", "Country")
    .selectCount()
    .ofType(ProductInfo.class)
    .toList();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by Lines[].Product, ShipTo.Country 
select Lines[].Product as Product, ShipTo.Country as Country, count()
`}
</CodeBlock>
</TabItem>
</Tabs>

Grouping by multiple values from **the same** collection is supported as well:

<Tabs groupId='languageSyntax'>
<TabItem value="Java" label="Java">
<CodeBlock language="java">
{`List<ProductInfo> results = session.query(Order.class)
    .groupBy(array("Lines[].Product"), array("Lines[].Quantity"))
    .selectKey("Lines[].Product", "Product")
    .selectKey("Lines[].Quantity", "Quantity")
    .selectCount()
    .ofType(ProductInfo.class)
    .toList();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by Lines[].Product, Lines[].Quantity 
select Lines[].Product as Product, Lines[].Quantity as Quantity, count()
`}
</CodeBlock>
</TabItem>
</Tabs>

### By Array Content

Another option is to group by array content. The reduction key will be calculated based on all values of a collection specified in `GroupBy`.
The client API exposes the `GroupByArrayContent` extension method for that purpose.

<Tabs groupId='languageSyntax'>
<TabItem value="Java" label="Java">
<CodeBlock language="java">
{`List<ProductsInfo> results = session.query(Order.class)
    .groupBy(array("Lines[].Product"))
    .selectKey("key()", "Products")
    .selectCount()
    .ofType(ProductsInfo.class)
    .toList();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders
group by array(Lines[].Product)
select key() as Products, count()
`}
</CodeBlock>
</TabItem>
</Tabs>

Grouping by array content and a value of another property is supported by `DocumentQuery`:

<Tabs groupId='languageSyntax'>
<TabItem value="Java" label="Java">
<CodeBlock language="java">
{`List<ProductsInfo> results = session.query(Order.class)
    .groupBy(array("Lines[].Product"), field("ShipTo.Country"))
    .selectKey("Lines[].Product", "Products")
    .selectKey("ShipTo.Country", "Country")
    .selectCount()
    .ofType(ProductsInfo.class)
    .toList();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by array(Lines[].Product), ShipTo.Country 
select Lines[].Product as Products, ShipTo.Country as Country, count()
`}
</CodeBlock>
</TabItem>
</Tabs>

Grouping by multiple values from **the same** collection is also supported by `DocumentQuery`:

<Tabs groupId='languageSyntax'>
<TabItem value="Java" label="Java">
<CodeBlock language="java">
{`List<ProductsInfo> results = session.query(Order.class)
    .groupBy(array("Lines[].Product"), array("Lines[].Quantity"))
    .selectKey("Lines[].Product", "Products")
    .selectKey("Lines[].Quantity", "Quantities")
    .selectCount()
    .ofType(ProductsInfo.class)
    .toList();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by array(Lines[].Product), array(Lines[].Quantity) 
select Lines[].Product as Products, Lines[].Quantity as Quantities, count()
`}
</CodeBlock>
</TabItem>
</Tabs>

<Admonition type="note" title="Note" id="note" href="#note">
In order to use the above methods you need to add the following **static import** statement:

<TabItem value="group_by_using" label="group_by_using">
<CodeBlock language="java">
{`import static net.ravendb.client.documents.queries.GroupBy.array;
import static net.ravendb.client.documents.queries.GroupBy.field;
`}
</CodeBlock>
</TabItem>
</Admonition>




</LanguageContent>
<LanguageContent language="python">

<Admonition type="note" title="">

* To run a dynamic query that aggregates data, use the `group_by()` method.  

* Data can be grouped by a single or by multiple fields, and further aggregated 
  by **sum**, **type**, or **count**.  

* RavenDB's query optimizer supports dynamic grouping by query, by automatically 
  creating auto map-reduce indexes.  

* In This Page:  
   * [Group By a Single Field](../../../client-api/session/querying/how-to-perform-group-by-query.mdx#group-by-a-single-field)  
   * [Group By Multiple Fields](../../../client-api/session/querying/how-to-perform-group-by-query.mdx#group-by-multiple-fields)  
   * [Select Composite GroupBy Key](../../../client-api/session/querying/how-to-perform-group-by-query.mdx#select-composite-groupby-key)  
   * [Group By Array](../../../client-api/session/querying/how-to-perform-group-by-query.mdx#group-by-array)  
      * [By Array Values](../../../client-api/session/querying/how-to-perform-group-by-query.mdx#by-array-values)  
      * [By Array Content](../../../client-api/session/querying/how-to-perform-group-by-query.mdx#by-array-content)  
   * [Sorting](../../../client-api/session/querying/how-to-perform-group-by-query.mdx#sorting)  
      * [By Count](../../../client-api/session/querying/how-to-perform-group-by-query.mdx#by-count)  
      * [By Sum](../../../client-api/session/querying/how-to-perform-group-by-query.mdx#by-sum)  

</Admonition>
## Group By a Single Field

<Tabs groupId='languageSyntax'>
<TabItem value="Python" label="Python">
<CodeBlock language="python group_by_1@clientapi\session\querying\howtoperformgroupbyquery.py /}">
{`orders = list(
    session.query(object_type=Order)
    .group_by("ship_to.country")
    .select_key("ship_to.country", "country")
    .select_sum(GroupByField("lines[].quantity", "ordered_quantity"))
    .of_type(CountryAndQuantity)
)
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders
group by ShipTo.City
select ShipTo.City as Country, sum(Lines[].Quantity) as TotalQuantity
`}
</CodeBlock>
</TabItem>
</Tabs>



## Group By Multiple Fields

<Tabs groupId='languageSyntax'>
<TabItem value="Python" label="Python">
<CodeBlock language="python group_by_2@clientapi\session\querying\howtoperformgroupbyquery.py /}">
{`results = list(
    session.query(object_type=Order)
    .group_by("employee", "company")
    .select_key("employee", "employee_identifier")
    .select_key("company")
    .select_count()
    .of_type(CountByCompanyAndEmployee)
)
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders
group by Employee, Company
select Employee as EmployeeIdentifier, Company, count()
`}
</CodeBlock>
</TabItem>
</Tabs>



## Select Composite GroupBy Key

<Tabs groupId='languageSyntax'>
<TabItem value="Python" label="Python">
<CodeBlock language="python group_by_3@clientapi\session\querying\howtoperformgroupbyquery.py /}">
{`orders = list(
    session.query(object_type=Order)
    .group_by("employee", "company")
    .select_key("key()", "employee_company_pair")
    .select_count("count")
    .of_type(CountOfEmployeeAndCompanyPairs)
)
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by Employee, Company
select key() as EmployeeCompanyPair, count()
`}
</CodeBlock>
</TabItem>
</Tabs>



## Group By Array

### By Array Values

The following query will group by the `lines[]` array `product` property 
and calculate the count per product.  
Behind the scenes, an auto map-reduce index is created to handle the query.  
<Tabs groupId='languageSyntax'>
<TabItem value="Python" label="Python">
<CodeBlock language="python group_by_4@clientapi\session\querying\howtoperformgroupbyquery.py /}">
{`products = list(
    session.query(object_type=Order)
    .group_by(GroupBy.array("lines[].product"))
    .select_key("key()", "products")
    .select_count()
    .of_type(ProductsInfo)
)
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by Lines[].Product
select Lines[].Product, count()
`}
</CodeBlock>
</TabItem>
</Tabs>

It is possible to group by the values of an array field **and** by the value of an additional property.  
<Tabs groupId='languageSyntax'>
<TabItem value="Python" label="Python">
<CodeBlock language="python group_by_5@clientapi\session\querying\howtoperformgroupbyquery.py /}">
{`products = list(
    session.advanced.document_query(object_type=Order)
    .group_by("lines[].product", "ship_to.country")
    .select_key("lines[].product", "product")
    .select_key("ship_to.country", "country")
    .select_count()
    .of_type(ProductInfo)
)
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by Lines[].Product, ShipTo.Country 
select Lines[].Product as Product, ShipTo.Country as Country, count()
`}
</CodeBlock>
</TabItem>
</Tabs>

Grouping by values of multiple fields of **the same** array is supported as well.  
<Tabs groupId='languageSyntax'>
<TabItem value="Python" label="Python">
<CodeBlock language="python group_by_6@clientapi\session\querying\howtoperformgroupbyquery.py /}">
{`results = list(
    session.query(object_type=Order)
    .group_by(GroupBy.array("lines[].product"), GroupBy.array("lines[].quantity"))
    .select_key("lines[].product", "product")
    .select_key("lines[].quantity", "quantity")
    .select_count()
    .of_type(ProductInfo)
)
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by Lines[].Product, Lines[].Quantity 
select Lines[].Product as Product, Lines[].Quantity as Quantity, count()
`}
</CodeBlock>
</TabItem>
</Tabs>

### By Array Content

Another option is to group by array **content**.  
The creation of the reduction key will be based on the content of the array field specified by `group_by`.  
<Tabs groupId='languageSyntax'>
<TabItem value="Python" label="Python">
<CodeBlock language="python group_by_7@clientapi\session\querying\howtoperformgroupbyquery.py /}">
{`results = list(
    session.query(object_type=Order)
    .group_by(GroupBy.array("lines[].product"))
    .select_key("key()", "products")
    .select_count()
    .of_type(ProductsInfo)
)
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders
group by array(Lines[].Product)
select key() as Products, count()
`}
</CodeBlock>
</TabItem>
</Tabs>

It is possible to group by the content of an array field **and** by that of a field of an additional property.  
<Tabs groupId='languageSyntax'>
<TabItem value="Python" label="Python">
<CodeBlock language="python group_by_8@clientapi\session\querying\howtoperformgroupbyquery.py /}">
{`results = list(
    session.query(object_type=Order)
    .group_by(GroupBy.array("lines[].product"), GroupBy.field("ship_to.country"))
    .select_key("lines[].product", "products")
    .select_key("ship_to.country", "country")
    .select_count()
    .of_type(ProductsInfo)
)
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by array(Lines[].Product), ShipTo.Country 
select Lines[].Product as Products, ShipTo.Country as Country, count()
`}
</CodeBlock>
</TabItem>
</Tabs>

Grouping by multiple fields of **the same** array is also supported.  
<Tabs groupId='languageSyntax'>
<TabItem value="Python" label="Python">
<CodeBlock language="python group_by_9@clientapi\session\querying\howtoperformgroupbyquery.py /}">
{`results = list(
    session.query(object_type=Order)
    .group_by(GroupBy.array("lines[].product"), GroupBy.array("lines[].quantity"))
    .select_key("lines[].product", "products")
    .select_key("lines[].quantity", "quantities")
    .select_count()
    .of_type(ProductsInfo)
)
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by array(Lines[].Product), array(Lines[].Quantity) 
select Lines[].Product as Products, Lines[].Quantity as Quantities, count()
`}
</CodeBlock>
</TabItem>
</Tabs>



## Sorting

The results of a dynamic group_by query can be sorted by an aggregation function used in the query.  
The results can be ordered by the aggregation operations `count` and `sum`.  

#### By Count

<Tabs groupId='languageSyntax'>
<TabItem value="Python" label="Python">
<CodeBlock language="python order_by_count@clientapi\session\querying\howtoperformgroupbyquery.py /}">
{`results = list(
    session.query(object_type=Order)
    .group_by("employee")
    .select_key("key()", "employee")
    .select_count()
    .order_by("count")
)
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by Employee 
order by count() as long 
select Employee, count()
`}
</CodeBlock>
</TabItem>
</Tabs>

#### By Sum

<Tabs groupId='languageSyntax'>
<TabItem value="Python" label="Python">
<CodeBlock language="python order_by_sum@clientapi\session\querying\howtoperformgroupbyquery.py /}">
{`results = list(
    session.query(object_type=Order)
    .group_by("employee")
    .select_key("key()", "employee")
    .select_sum(GroupByField("freight", "sum"))
    .order_by("sum")
)
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by Employee 
order by sum(Freight) as double 
select key() as Employee, sum(Freight) as Sum
`}
</CodeBlock>
</TabItem>
</Tabs>




</LanguageContent>
<LanguageContent language="php">


Since RavenDB 4.0, the query optimizer supports dynamic group by queries and automatically creates auto map-reduce indexes.

You can create a dynamic query that does an aggregation using the `groupBy` method.

Supported aggregation operations include:

- `selectKey`  
- `selectSum`  
- `selectCount`  

## Group By Single Field

<Tabs groupId='languageSyntax'>
<TabItem value="Php" label="Php">
<CodeBlock language="php group_by_1@clientapi\session\querying\howtoperformgroupbyquery.php /}">
{`/** @var array<CountryAndQuantity> $orders */
$orders = $session->query(Order::class)
    ->groupBy("ShipTo.Country")
    ->selectKey("ShipTo.Country", "Country")
    ->selectSum(new GroupByField("Lines[].Quantity", "OrderedQuantity"))
    ->ofType(CountryAndQuantity::class)
    ->toList();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders
group by ShipTo.City
select ShipTo.City as Country, sum(Lines[].Quantity) as TotalQuantity
`}
</CodeBlock>
</TabItem>
</Tabs>



## Group By Multiple Fields

<Tabs groupId='languageSyntax'>
<TabItem value="Php" label="Php">
<CodeBlock language="php group_by_2@clientapi\session\querying\howtoperformgroupbyquery.php /}">
{`$results = $session->query(Order::class)
    ->groupBy("Employee", "Company")
    ->selectKey("Employee", "EmployeeIdentifier")
    ->selectKey("Company")
    ->selectCount()
    ->ofType(CountByCompanyAndEmployee::class)
    ->toList();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders
group by Employee, Company
select Employee as EmployeeIdentifier, Company, count()
`}
</CodeBlock>
</TabItem>
</Tabs>



## Select Composite GroupBy Key

<Tabs groupId='languageSyntax'>
<TabItem value="Php" label="Php">
<CodeBlock language="php group_by_3@clientapi\session\querying\howtoperformgroupbyquery.php /}">
{`/** @var array<CountOfEmployeeAndCompanyPairs> $orders */
$orders = $session->query(Order::class)
    ->groupBy("Employee", "Company")
    ->selectKey("key()", "EmployeeCompanyPair")
    ->selectCount("Count")
    ->ofType(CountOfEmployeeAndCompanyPairs::class)
    ->toList();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by Employee, Company
select key() as EmployeeCompanyPair, count()
`}
</CodeBlock>
</TabItem>
</Tabs>



## Group By Array

### By Array Values

The following query groups by the `Product` property of the `Lines` collection, 
and calculates the count per ordered products.  
Underneath a fanout, an auto map-reduce index will be created to handle such a query. 

<Tabs groupId='languageSyntax'>
<TabItem value="Php" label="Php">
<CodeBlock language="php group_by_4@clientapi\session\querying\howtoperformgroupbyquery.php /}">
{`/** @var array<ProductsInfo> $products */
$products = $session->query(Order::class)
    ->groupBy(GroupBy::array("Lines[].Product"))
    ->selectKey("key()", "Products")
    ->selectCount()
    ->ofType(ProductsInfo::class)
    ->toList();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by Lines[].Product
select Lines[].Product, count()
`}
</CodeBlock>
</TabItem>
</Tabs>

Inside a single group by statement you can mix collection values and value of another property.  

<Tabs groupId='languageSyntax'>
<TabItem value="Php" label="Php">
<CodeBlock language="php group_by_5@clientapi\session\querying\howtoperformgroupbyquery.php /}">
{`/** @var array<ProductInfo> $results */
$results = $session->advanced()->documentQuery(Order::class)
    ->groupBy("Lines[].Product", "ShipTo.Country")
    ->selectKey("Lines[].Product", "Product")
    ->selectKey("ShipTo.Country", "Country")
    ->selectCount()
    ->ofType(ProductInfo::class)
    ->toList();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by Lines[].Product, ShipTo.Country 
select Lines[].Product as Product, ShipTo.Country as Country, count()
`}
</CodeBlock>
</TabItem>
</Tabs>

Grouping by multiple values from **the same** collection is supported as well:

<Tabs groupId='languageSyntax'>
<TabItem value="Php" label="Php">
<CodeBlock language="php group_by_6@clientapi\session\querying\howtoperformgroupbyquery.php /}">
{`/** @var array<ProductInfo> $results */
$results = $session->query(Order::class)
    ->groupBy(GroupBy::array("Lines[].Product"), GroupBy::array("Lines[].Quantity"))
    ->selectKey("Lines[].Product", "Product")
    ->selectKey("Lines[].Quantity", "Quantity")
    ->selectCount()
    ->ofType(ProductInfo::class)
    ->toList();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by Lines[].Product, Lines[].Quantity 
select Lines[].Product as Product, Lines[].Quantity as Quantity, count()
`}
</CodeBlock>
</TabItem>
</Tabs>

### By Array Content

Another option is to group by array content.  
The reduction key will be calculated based on all values of a collection specified in `groupBy`.

<Tabs groupId='languageSyntax'>
<TabItem value="Php" label="Php">
<CodeBlock language="php group_by_7@clientapi\session\querying\howtoperformgroupbyquery.php /}">
{`/** @var array<ProductsInfo> $results */
$results = $session->query(Order::class)
    ->groupBy(GroupBy::array("Lines[].Product"))
    ->selectKey("key()", "Products")
    ->selectCount()
    ->ofType(ProductsInfo::class)
    ->toList();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders
group by array(Lines[].Product)
select key() as Products, count()
`}
</CodeBlock>
</TabItem>
</Tabs>

Grouping by array content and a value of another property is supported by `documentQuery`:

<Tabs groupId='languageSyntax'>
<TabItem value="Php" label="Php">
<CodeBlock language="php group_by_8@clientapi\session\querying\howtoperformgroupbyquery.php /}">
{`/** @var array<ProductsInfo> $results */
$results = $session->query(Order::class)
    ->groupBy(GroupBy::array("Lines[].Product"), GroupBy::field("ShipTo.Country"))
    ->selectKey("Lines[].Product", "Products")
    ->selectKey("ShipTo.Country", "Country")
    ->selectCount()
    ->ofType(ProductsInfo::class)
    ->toList();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by array(Lines[].Product), ShipTo.Country 
select Lines[].Product as Products, ShipTo.Country as Country, count()
`}
</CodeBlock>
</TabItem>
</Tabs>

Grouping by multiple values from **the same** collection is also supported by `documentQuery`:

<Tabs groupId='languageSyntax'>
<TabItem value="Php" label="Php">
<CodeBlock language="php group_by_9@clientapi\session\querying\howtoperformgroupbyquery.php /}">
{`/** @var array<ProductsInfo> $results */
$results = $session->query(Order::class)
    ->groupBy(GroupBy::array("Lines[].Product"), GroupBy::array("Lines[].Quantity"))
    ->selectKey("Lines[].Product", "Products")
    ->selectKey("Lines[].Quantity", "Quantities")
    ->selectCount()
    ->ofType(ProductsInfo::class)
    ->toList();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by array(Lines[].Product), array(Lines[].Quantity) 
select Lines[].Product as Products, Lines[].Quantity as Quantities, count()
`}
</CodeBlock>
</TabItem>
</Tabs>




</LanguageContent>
<LanguageContent language="nodejs">


Since RavenDB 4.0, the query optimizer supports dynamic group by queries and automatically creates auto map-reduce indexes.

You can create a dynamic query that does an aggregation by using the `groupBy()` method.

The supported aggregation operations are:

- `count`
- `sum`

&lt;br /&gt;

## Group By Single Field

<Tabs groupId='languageSyntax'>
<TabItem value="Node.js" label="Node.js">
<CodeBlock language="js">
{`const orders = await session.query({ collection: "Orders" })
    .groupBy("ShipTo.Country")
    .selectKey("ShipTo.Country", "Country")
    .selectSum(new GroupByField("Lines[].Quantity", "OrderedQuantity"))
    .ofType(CountryAndQuantity)
    .all();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders
group by ShipTo.City
select ShipTo.City as Country, sum(Lines[].Quantity) as TotalQuantity
`}
</CodeBlock>
</TabItem>
</Tabs>



## Group By Multiple Fields

<Tabs groupId='languageSyntax'>
<TabItem value="Node.js" label="Node.js">
<CodeBlock language="js">
{`const results = await session.query({ collection: "Orders" })
    .groupBy("Employee", "Company")
    .selectKey("Employee", "EmployeeIdentifier")
    .selectKey("Company")
    .selectCount()
    .ofType(CountByCompanyAndEmployee)
    .all();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders
group by Employee, Company
select Employee as EmployeeIdentifier, Company, count() as Count
`}
</CodeBlock>
</TabItem>
</Tabs>



## Select Composite GroupBy Key

<Tabs groupId='languageSyntax'>
<TabItem value="Node.js" label="Node.js">
<CodeBlock language="js">
{`const orders = await session.query({ collection: "Orders" })
    .groupBy("Employee", "Company")
    .selectKey("key()", "EmployeeCompanyPair")
    .selectCount("Count")
    .ofType(CountOfEmployeeAndCompanyPairs)
    .all();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by Employee, Company
select key() as EmployeeCompanyPair, count() as Count
`}
</CodeBlock>
</TabItem>
</Tabs>



## Group By Array

### By Array Values

In order to group by values of array, you need to use `groupBy(array(...))`. The following query will group by `product` field from `lines` collection 
and calculate the count per ordered products. Underneath a fanout, an auto map-reduce index will be created to handle such query. 

<Tabs groupId='languageSyntax'>
<TabItem value="Node.js" label="Node.js">
<CodeBlock language="js">
{`const products = await session.query({ collection: "Orders" })
    .groupBy(GroupBy.array("Lines[].Product"))
    .selectKey("key()", "Products")
    .selectCount()
    .ofType(ProductsInfo)
    .all();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by Lines[].Product
select Lines[].Product, count() as Count
`}
</CodeBlock>
</TabItem>
</Tabs>

Inside a single group by statement you can mix collection values and value of another property. That's supported by `DocumentQuery` only:

<Tabs groupId='languageSyntax'>
<TabItem value="Node.js" label="Node.js">
<CodeBlock language="js">
{`const results = await session.advanced.documentQuery({ collection: "Orders" })
    .groupBy("Lines[].Product", "ShipTo.Country")
    .selectKey("Lines[].Product", "Product")
    .selectKey("ShipTo.Country", "Country")
    .selectCount()
    .ofType(ProductInfo)
    .all();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by Lines[].Product, ShipTo.Country 
select Lines[].Product as Product, ShipTo.Country as Country, count() as Count
`}
</CodeBlock>
</TabItem>
</Tabs>

Grouping by multiple values from **the same** collection is supported as well:

<Tabs groupId='languageSyntax'>
<TabItem value="Node.js" label="Node.js">
<CodeBlock language="js">
{`const results = await session.query({ collection: "Orders" })
    .groupBy(GroupBy.array("Lines[].Product"), GroupBy.array("Lines[].Quantity"))
    .selectKey("Lines[].Product", "Product")
    .selectKey("Lines[].Quantity", "Quantity")
    .selectCount()
    .ofType(ProductInfo)
    .all();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by Lines[].Product, Lines[].Quantity 
select Lines[].Product as Product, Lines[].Quantity as Quantity, count() as Count
`}
</CodeBlock>
</TabItem>
</Tabs>

### By Array Content

Another option is to group by array content. The reduction key will be calculated based on all values of a collection specified in `GroupBy`.
The client API exposes the `GroupByArrayContent` extension method for that purpose.

<Tabs groupId='languageSyntax'>
<TabItem value="Node.js" label="Node.js">
<CodeBlock language="js">
{`const results = await session.query({ collection: "Orders" })
    .groupBy(GroupBy.array("Lines[].Product"))
    .selectKey("key()", "Products")
    .selectCount()
    .ofType(ProductsInfo)
    .all();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders
group by array(Lines[].Product)
select key() as Products, count() as Count
`}
</CodeBlock>
</TabItem>
</Tabs>

Grouping by array content and a value of another property is supported by `DocumentQuery`:

<Tabs groupId='languageSyntax'>
<TabItem value="Node.js" label="Node.js">
<CodeBlock language="js">
{`const results = await session.query({ collection: "Orders" })
    .groupBy(GroupBy.array("Lines[].Product"), GroupBy.field("ShipTo.Country"))
    .selectKey("Lines[].Product", "Products")
    .selectKey("ShipTo.Country", "Country")
    .selectCount()
    .ofType(ProductsInfo)
    .toList();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by array(Lines[].Product), ShipTo.Country 
select Lines[].Product as Products, ShipTo.Country as Country, count() as Count
`}
</CodeBlock>
</TabItem>
</Tabs>

Grouping by multiple values from **the same** collection is also supported by `DocumentQuery`:

<Tabs groupId='languageSyntax'>
<TabItem value="Node.js" label="Node.js">
<CodeBlock language="js">
{`const results = await session.query({ collection: "Orders" })
    .groupBy(GroupBy.array("Lines[].Product"), GroupBy.array("Lines[].Quantity"))
    .selectKey("Lines[].Product", "Products")
    .selectKey("Lines[].Quantity", "Quantities")
    .selectCount()
    .ofType(ProductsInfo)
    .all();
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from Orders 
group by array(Lines[].Product), array(Lines[].Quantity) 
select Lines[].Product as Products, Lines[].Quantity as Quantities, count() as Count
`}
</CodeBlock>
</TabItem>
</Tabs>




</LanguageContent>

<!---
### Session
- [How to Query](../../../client-api/session/querying/how-to-query)

### Indexes
- [Map-Reduce Indexes](../../../indexes/map-reduce-indexes)


-->