---
title: "Patch Time Series Entries"
sidebar_label: Patch
sidebar_position: 4
hide_table_of_contents: true
---

import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';
import LanguageSwitcher from "@site/src/components/LanguageSwitcher";
import LanguageContent from "@site/src/components/LanguageContent";

export const supportedLanguages = ["csharp", "python", "php", "nodejs"];


# Patch Time Series Entries
<LanguageSwitcher supportedLanguages={supportedLanguages} />
<LanguageContent language="csharp">

<Admonition type="note" title="Note">

* Patching multiple time series entries (append or delete entries) can be performed via the _Session_  
  using [session.Advanced.Defer](../../../../client-api/operations/patching/single-document#session-api-using-defer), as described below.
  * You can handle a single document at a time.
  * The patching action is defined by the provided [JavaScript](../../../../document-extensions/timeseries/client-api/javascript-support).
  
* Patching time series entries can also be done directly on the _Store_ via [Operations](../../../../client-api/operations/what-are-operations),  
  where multiple documents can be handled at a time. Learn more in [Patching time series operations](../../../../document-extensions/timeseries/client-api/operations/patch).

* In this page:
   * [Usage](../../../../document-extensions/timeseries/client-api/session/patch#usage)  
   * [Patching examples](../../../../document-extensions/timeseries/client-api/session/patch#patching-examples)
     * [Append multiple entries](../../../../document-extensions/timeseries/client-api/session/patch#append-multiple-entries) 
     * [Delete multiple entries](../../../../document-extensions/timeseries/client-api/session/patch#delete-multiple-entries) 
   * [Syntax](../../../../document-extensions/timeseries/client-api/session/patch#syntax)

</Admonition>
## Usage

* Open a session
* Construct a `PatchCommandData` instance and pass it the following:
    * The document ID that contains the time series
    * The document change vector (or `null`)
    * A `PatchRequest` instance with a JavaScript that appends or removes time series entries
* Call `session.Advanced.Defer` and pass it the `PatchCommandData` command.  
  Note that you can call _Defer_ multiple times prior to calling _SaveChanges_.
* Call `session.SaveChanges()`.  
  All patch requests added via _Defer_ will be sent to the server for execution when _SaveChanges_ is called.



## Patching examples

#### Append multiple entries:

In this example, we append 100 time series entries with random heart rate values to a document.  

<TabItem value="something" label="TS_region-Session_Patch-Append-100-Random-TS-Entries">
<CodeBlock language="csharp">
{`var baseline = DateTime.Today;

// Create arrays of timestamps and random values to patch
List<double> values = new List<double>();
List<DateTime> timeStamps = new List<DateTime>();

for (var i = 0; i < 100; i++)
\{
    values.Add(68 + Math.Round(19 * new Random().NextDouble()));
    timeStamps.Add(baseline.AddSeconds(i));
\}

session.Advanced.Defer(new PatchCommandData("users/1-A", null,
    new PatchRequest
    \{
        Script = @"
            var i = 0;
            for(i = 0; i < $values.length; i++)
            \{
                timeseries(id(this), $timeseries)
                .append (
                  new Date($timeStamps[i]), 
                  $values[i], 
                  $tag);
            \}",

        Values =
        \{
            \{ "timeseries", "HeartRates" \},
            \{ "timeStamps", timeStamps\},
            \{ "values", values \},
            \{ "tag", "watches/fitbit" \}
        \}
    \}, null));

session.SaveChanges();
`}
</CodeBlock>
</TabItem>
#### Delete multiple entries:

In this example, we remove a range of 50 time series entries from a document.  

<TabItem value="something" label="TS_region-Session_Patch-Delete-50-TS-Entries">
<CodeBlock language="csharp">
{`// Delete time-series entries
session.Advanced.Defer(new PatchCommandData("users/1-A", null,
    new PatchRequest
    \{
        Script = @"timeseries(this, $timeseries)
                 .delete(
                    $from, 
                    $to
                  );",
        Values =
        \{
            \{ "timeseries", "HeartRates" \},
            \{ "from", baseline.AddSeconds(0) \},
            \{ "to", baseline.AddSeconds(49) \}
        \}
    \}, null));

session.SaveChanges();
`}
</CodeBlock>
</TabItem>



## Syntax

**`PatchCommandData`**

<TabItem value="something" label="PatchCommandData-definition">
<CodeBlock language="csharp">
{`public PatchCommandData(string id, string changeVector,
    PatchRequest patch, PatchRequest patchIfMissing)
`}
</CodeBlock>
</TabItem>

Learn more about `PatchCommandData` [here](../../../../client-api/operations/patching/single-document#session-api-using-defer).
**`PatchRequest`**

<TabItem value="something" label="PatchRequest-definition">
<CodeBlock language="csharp">
{`public class PatchRequest
\{
    // The patching script     
    public string Script \{ get; set; \}
    
    // Values for the parameters used by the patching script
    public Dictionary<string, object> Values \{ get; set; \}
\}
`}
</CodeBlock>
</TabItem>

Learn more about `PatchRequest` [here](../../../../client-api/operations/patching/single-document#session-api-using-defer).




</LanguageContent>
<LanguageContent language="python">

<Admonition type="note" title="Note">

* Patching multiple time series entries (append or delete entries) can be performed via the _Session_  
  using [session.advanced.defer](../../../../client-api/operations/patching/single-document#session-api-using-defer), as described below.
  * You can handle a single document at a time.
  * The patching action is defined by the provided [JavaScript](../../../../document-extensions/timeseries/client-api/javascript-support).
  
* Patching time series entries can also be done directly on the _Store_ via [Operations](../../../../client-api/operations/what-are-operations),  
  where multiple documents can be handled at a time. Learn more in [Patching time series operations](../../../../document-extensions/timeseries/client-api/operations/patch).

* In this page:
   * [Usage](../../../../document-extensions/timeseries/client-api/session/patch#usage)  
   * [Patching examples](../../../../document-extensions/timeseries/client-api/session/patch#patching-examples)
     * [Append multiple entries](../../../../document-extensions/timeseries/client-api/session/patch#append-multiple-entries) 
     * [Delete multiple entries](../../../../document-extensions/timeseries/client-api/session/patch#delete-multiple-entries) 
   * [Syntax](../../../../document-extensions/timeseries/client-api/session/patch#syntax)

</Admonition>
## Usage

* Open a session
* Construct a `PatchCommandData` instance and pass it the following:
    * The document ID that contains the time series
    * The document change vector (or `None`)
    * A `PatchRequest` instance with a JavaScript that appends or removes time series entries
* Call `session.advanced.defer` and pass it the `PatchCommandData` command.  
  Note that you can call _Defer_ multiple times prior to calling _SaveChanges_.
* Call `session.save_changes`.  
  All patch requests added via _Defer_ will be sent to the server for execution when _SaveChanges_ is called.



## Patching examples

#### Append multiple entries:

In this example, we append 100 time series entries with random heart rate values to a document.  

<TabItem value="something-something" label="TS_region-Session_Patch-Append-100-Random-TS-Entries">
<CodeBlock language="python">
{`base_line = datetime.utcnow()

# Create arrays of timestamps and random values to patch
values = []
time_stamps = []

for i in range(100):
    values.append(68 + round(19 * random.uniform(0.0, 1.0)))
    time_stamps.append(base_line + timedelta(seconds=i))

session.advanced.defer(
    PatchCommandData(
        "users/1-A",
        None,
        PatchRequest(
            script=(
                "var i = 0;"
                "for(i = 0; i < $values.length; i++)"
                "\{"
                "    timeseries(id(this), $timeseries)"
                "    .append ("
                "      new Date($time_stamps[i]),"
                "      $values[i],"
                "      $tag);"
                "\}"
            ),
            values=\{
                "timeseries": "HeartRates",
                "time_stamps": time_stamps,
                "values": values,
                "tag": "watches/fitbit",
            \},
        ),
        None,
    )
)

session.save_changes()
`}
</CodeBlock>
</TabItem>
#### Delete multiple entries:

In this example, we remove a range of 50 time series entries from a document.  

<TabItem value="something-something" label="TS_region-Session_Patch-Delete-50-TS-Entries">
<CodeBlock language="python">
{`# Delete time-series entries
session.advanced.defer(
    PatchCommandData(
        "users/1-A",
        None,
        PatchRequest(
            script=("timeseries(this, $timeseries)" ".delete(" "  $from," "  $to" ");"),
            values=\{
                "timeseries": "HeartRates",
                "from": base_line,
                "to": base_line + timedelta(seconds=49),
            \},
        ),
        None,
    )
)
`}
</CodeBlock>
</TabItem>



## Syntax

**`PatchCommandData`**

<TabItem value="something-something" label="PatchCommandData-definition">
<CodeBlock language="python">
{`class PatchCommandData(CommandData):
    def __init__(
        self,
        key: str,
        change_vector: Union[None, str],
        patch: PatchRequest,
        patch_if_missing: Optional[PatchRequest] = None,
    ): ...
`}
</CodeBlock>
</TabItem>

Learn more about `PatchCommandData` [here](../../../../client-api/operations/patching/single-document#session-api-using-defer).
**`PatchRequest`**

<TabItem value="something-something" label="PatchRequest-definition">
<CodeBlock language="python">
{`class PatchRequest:
    def __init__(self, script: Optional[str] = "", values: Optional[Dict[str, object]] = None): ...
`}
</CodeBlock>
</TabItem>

Learn more about `PatchRequest` [here](../../../../client-api/operations/patching/single-document#session-api-using-defer).




</LanguageContent>
<LanguageContent language="php">

<Admonition type="note" title="Note">

* Patching multiple time series entries (append or delete entries) can be performed via the _Session_  
  using `session.advanced.defer` as described below.
  * You can handle a single document at a time.
  * The patching action is defined by the provided `JavaScript`.
  
* Patching time series entries can also be done directly on the _Store_ via [Operations](../../../../client-api/operations/what-are-operations),  
  where multiple documents can be handled at a time.  

* In this page:
   * [Usage](../../../../document-extensions/timeseries/client-api/session/patch#usage)  
   * [Patching examples](../../../../document-extensions/timeseries/client-api/session/patch#patching-examples)
     * [Append multiple entries](../../../../document-extensions/timeseries/client-api/session/patch#append-multiple-entries) 
     * [Delete multiple entries](../../../../document-extensions/timeseries/client-api/session/patch#delete-multiple-entries) 
   * [Syntax](../../../../document-extensions/timeseries/client-api/session/patch#syntax)

</Admonition>
## Usage

* Open a session
* Construct a `PatchCommandData` instance and pass it the following:
    * The document ID that contains the time series
    * The document change vector (or `null`)
    * A `PatchRequest` instance with a JavaScript that appends or removes time series entries
* Call `session.advanced.defer` and pass it the `PatchCommandData` command.  
  Note that you can call _Defer_ multiple times prior to calling _SaveChanges_.
* Call `session.saveChanges`.  
  All patch requests added via _Defer_ will be sent to the server for execution when _SaveChanges_ is called.



## Patching examples

#### Append multiple entries:

In this example, we append 100 time series entries with random heart rate values to a document.  

<TabItem value="something-something" label="TS_region-Session_Patch-Append-100-Random-TS-Entries">
<CodeBlock language="php">
{`$baseTime = DateUtils::today();

/ Create arrays of timestamps and random values to patch
values = [];
timeStamps = [];

or ($i = 0; $i < 100; $i++)
{
   $values[] = 68 + rand(0, 19);
   $timeStamps[] =   (clone $baseTime)->add(new DateInterval("PT" . $i . "S"));
}

patchRequest = new PatchRequest();
patchRequest->setScript("
           var i = 0;
           for(i = 0; i < \\$values.length; i++)
           \{
               timeseries(id(this), \\$timeseries)
               .append (
                 new Date(\\$timeStamps[i]),
                 \\$values[i],
                 \\$tag);
           \}");
patchRequest->setValues([
       "timeseries" => "HeartRates",
       "timeStamps" => $timeStamps,
       "values" => $values,
       "tag" => "watches/fitbit"
);

session->advanced()->defer(new PatchCommandData("users/1-A", null, $patchRequest, null));

session->saveChanges();
`}
</CodeBlock>
</TabItem>
#### Delete multiple entries:

In this example, we remove a range of 50 time series entries from a document.  

<TabItem value="something-something" label="TS_region-Session_Patch-Delete-50-TS-Entries">
<CodeBlock language="php">
{`// Delete time-series entries
$patchRequest = new PatchRequest();
$patchRequest->setScript("timeseries(this, \\$timeseries)
                 .delete(
                    \\$from,
                    \\$to
                  );");
$patchRequest->setValues([
    "timeseries" => "HeartRates",
    "from" =>  $baseTime,
    "to" =>   (clone $baseTime)->add(new DateInterval("PT49S"))
]);

$session->advanced()->defer(new PatchCommandData("users/1-A", null, $patchRequest, null));

$session->saveChanges();
`}
</CodeBlock>
</TabItem>



## Syntax

**`PatchCommandData`**

<TabItem value="something-something" label="PatchCommandData-definition">
<CodeBlock language="php">
{`new PatchCommandData(?string $id, ?string $changeVector, ?PatchRequest $patch, ?PatchRequest $patchIfMissing = null);
`}
</CodeBlock>
</TabItem>
**`PatchRequest`**

<TabItem value="something-something" label="PatchRequest-definition">
<CodeBlock language="php">
{`class PatchRequest
\{
    // The patching script
    private ?string $script = null;

    // Values for the parameters used by the patching script
    private ?ObjectMap $values = null;

    // ... getters and setters ...
\}
`}
</CodeBlock>
</TabItem>




</LanguageContent>
<LanguageContent language="nodejs">

<Admonition type="note" title="Note">

* Patching multiple time series entries (append or delete entries) can be performed via the _Session_  
  using [session.advanced.defer](../../../../client-api/operations/patching/single-document#session-api-using-defer), as described below.
  * You can handle a single document at a time.
  * The patching action is defined by the provided [JavaScript](../../../../document-extensions/timeseries/client-api/javascript-support).
  
* Patching time series entries can also be done directly on the _Store_ via [Operations](../../../../client-api/operations/what-are-operations),  
  where multiple documents can be handled at a time. Learn more in [Patching time series operations](../../../../document-extensions/timeseries/client-api/operations/patch).

* In this page:
   * [Usage](../../../../document-extensions/timeseries/client-api/session/patch#usage)  
   * [Patching examples](../../../../document-extensions/timeseries/client-api/session/patch#patching-examples)
     * [Append multiple entries](../../../../document-extensions/timeseries/client-api/session/patch#append-multiple-entries) 
     * [Delete multiple entries](../../../../document-extensions/timeseries/client-api/session/patch#delete-multiple-entries) 
   * [Syntax](../../../../document-extensions/timeseries/client-api/session/patch#syntax)

</Admonition>
## Usage

* Open a session
* Construct a `PatchCommandData` instance and pass it the following:
  * The document ID that contains the time series
  * The document change vector (or `null`)
  * A `PatchRequest` instance with a JavaScript that appends or removes time series entries
* Call `session.advanced.defer` and pass it the `PatchCommandData` command.  
  Note that you can call _defer_ multiple times prior to calling _saveChanges_.
* Call `session.saveChanges()`.  
  All patch requests added via _defer_ will be sent to the server for execution when _saveChanges_ is called.



## Patching examples

#### Append multiple entries:

In this example, we append 100 time series entries with random heart rate values to a document.  

<TabItem value="something-something" label="patch_1">
<CodeBlock language="nodejs">
{`const baseTime = new Date();

// Prepare random values and timestamps to patch
const values = [];
const timeStamps = [];

for (let i = 0; i < 100; i++) \{
    const randomValue = 65 + Math.round(20 * Math.random());
    values.push(randomValue);
    
    // NOTE: the timestamp passed in the patch request script should be in UTC
    const timeStamp = new Date(baseTime.getTime() + 60_000 * i);
    const utcDate = new Date(timeStamp.getTime() + timeStamp.getTimezoneOffset() * 60_000);
    timeStamps.push(utcDate);
\}

// Define the patch request
// ========================

const patchRequest = new PatchRequest();

// Provide a JavaScript script, use the 'append' method
// Note: "args." can be replaced with "$". E.g.: "args.tag" => "$tag"
patchRequest.script = \`
    for(var i = 0; i < args.values.length; i++)
    \{
        timeseries(id(this), args.timeseries)
        .append (
            new Date(args.timeStamps[i]),
            args.values[i],
            args.tag);
    \}\`;

// Provide values for the params used within the script
patchRequest.values = \{
    timeseries: "HeartRates",
    timeStamps: timeStamps,
    values: values,
    tag: "watches/fitbit"
\}

// Define the patch command
const patchCommand = new PatchCommandData("users/john", null, patchRequest, null)

// Pass the patch command to 'defer'
session.advanced.defer(patchCommand);

// Call saveChanges for the patch request to execute on the server
await session.saveChanges();
`}
</CodeBlock>
</TabItem>
#### Delete multiple entries:

In this example, we remove a range of 50 time series entries from a document.  

<TabItem value="something-something" label="patch_2">
<CodeBlock language="nodejs">
{`// Define the patch request
// ========================

const patchRequest = new PatchRequest();

// Provide a JavaScript script, use the 'delete' method
// Note: "args." can be replaced with "$". E.g.: "args.to" => "$to"
patchRequest.script = \`timeseries(this, args.timeseries)
         .delete(
             args.from,
             args.to 
         );\`;
       
// NOTE: the 'from' & 'to' params in the patch request script should be in UTC
const utcDate = new Date(baseTime.getTime() + baseTime.getTimezoneOffset() * 60_000);

// Provide values for the params used within the script
patchRequest.values = \{
    timeseries: "HeartRates",
    from: utcDate,
    to: new Date(utcDate.getTime() + 60_000 * 49)
\}

// Define the patch command
const patchCommand = new PatchCommandData("users/john", null, patchRequest, null)

// Pass the patch command to 'defer'
session.advanced.defer(patchCommand);

// Call saveChanges for the patch request to execute on the server
await session.saveChanges();
`}
</CodeBlock>
</TabItem>



## Syntax

A detailed syntax description for `PatchCommandData` & `PatchRequest` can be found in the following section:  
[Session API using defer syntax](../../../../client-api/operations/patching/single-document#session-api-using-defer-syntax).




</LanguageContent>

<!---
### Time Series and JavaScript
- [The Time Series JavaScript API](../../../../document-extensions/timeseries/client-api/javascript-support)

### Client API
- [Time Series API Overview](../../../../document-extensions/timeseries/client-api/overview)

### Studio Articles
- [Studio Time Series Management](../../../../studio/database/document-extensions/time-series)

### Querying and Indexing
- [Time Series Querying](../../../../document-extensions/timeseries/querying/overview-and-syntax)
- [Time Series Indexing](../../../../document-extensions/timeseries/indexing)

### Policies
- [Time Series Rollup and Retention](../../../../document-extensions/timeseries/rollup-and-retention)


-->