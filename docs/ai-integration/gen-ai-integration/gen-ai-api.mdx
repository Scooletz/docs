---
title: "GenAI Integration: API"
sidebar_label: GenAI API
sidebar_position: 1
---

import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';
import LanguageSwitcher from "@site/src/components/LanguageSwitcher";
import LanguageContent from "@site/src/components/LanguageContent";

# GenAI Integration: API
<Admonition type="note" title="Note">

* A GenAI task leverages an AI model to enable intelligent processing of documents in runtime.  
   * The task is associated with a document collection and with an AI model.  
   * It is an **ongoing task** that:  
      1. Continuously monitors the collection;  
      2. Whenever needed, like when a document is added to the collection, generates 
         user-defined context objects based on the source document data;  
      3. Passes each context object to the AI model for further processing;  
      4. Receives the AI model's JSON-based results;  
      5. And finally, runs a user-defined script that potentially acts upon the results.  

* The main steps in defining a GenAI task are:  
   * Defining a [Connection string](../../ai-integration/gen-ai-integration/gen-ai-api#defining-a-connection-string) 
     to the AI model  
   * Defining a [Context generation script](../../ai-integration/gen-ai-integration/gen-ai-overview#the-elements_context-objects)  
   * Defining a [Prompt](../../ai-integration/gen-ai-integration/gen-ai-overview#the-elements_prompt)  
   * Defining a [JSON schema](../../ai-integration/gen-ai-integration/gen-ai-overview#the-elements_json-schema)  
   * Defining an [Update script](../../ai-integration/gen-ai-integration/gen-ai-overview#the-elements_update-script)  

* In this article:
    * [Defining a Connection string](../../ai-integration/gen-ai-integration/gen-ai-api#defining-a-connection-string)
    * [Defining the GenAI task](../../ai-integration/gen-ai-integration/gen-ai-api#defining-the-genai-task)

</Admonition>
## Defining a Connection string

* Choose the model to connect with, by what you need from your GenAI task.  
  E.g., If you require security and speed above all for the duration of a rapid 
  development phase, you may prefer a local AI service like [Ollama](../../ai-integration/connection-strings/ollama).  
* Make sure you define the correct service: both Ollama and OpenAI are supported 
  but you need to pick an Ollama/OpenAI service that supports generative AI, 
  like Ollama `llama3.2` or OpenAI `gpt-4o-mini`.  
* Learn more about connection strings [here](../../ai-integration/connection-strings/connection-strings-overview).  
### Example:

<Tabs groupId='languageSyntax'>
<TabItem value="set-ollama" label="set-ollama">
<CodeBlock language="csharp">
{`using (var store = new DocumentStore())
{
    // Define the connection string to Ollama
    var connectionString = new AiConnectionString
    {
        // Connection string name & identifier
        Name = "ollama-cs", 
        
        // Ollama connection settings
        OllamaSettings = new OllamaSettings(
            // LLM Ollama model for text generation
            model: "llama3.2",
            // local Ollama mode URL
            uri: "http://localhost:11434/")
    };
    
    // Deploy the connection string to the server
    var operation = new PutConnectionStringOperation<AiConnectionString>(connectionString);
    var putConnectionStringResult = store.Maintenance.Send(operation);
}
`}
</CodeBlock>
</TabItem>
<TabItem value="set-open-ai" label="set-open-ai">
<CodeBlock language="csharp">
{`using (var store = new DocumentStore())
{
    // Define the connection string to Ollama
    var connectionString = new AiConnectionString
    {
        // Connection string name & identifier
        Name = "open-ai-cs",

        // Ollama connection settings
        OpenAiSettings = new OpenAiSettings(
            apiKey: "your-api-key",
            endpoint: "https://api.openai.com/v1",
            // LLM Ollama model for text generation
            model: "gpt-4o-mini")
    };

    // Deploy the connection string to the server
    var operation = new PutConnectionStringOperation<AiConnectionString>(connectionString);
    var putConnectionStringResult = store.Maintenance.Send(operation);
}
`}
</CodeBlock>
</TabItem>
</Tabs>
### Syntax:

<Tabs groupId='languageSyntax'>
<TabItem value="ollama-syntax" label="ollama-syntax">
<CodeBlock language="csharp">
{`public class AiConnectionString
{
    public string Name { get; set; }
    public string Identifier { get; set; }
    public OllamaSettings OllamaSettings { get; set; }
}

public class OllamaSettings : AbstractAiSettings
{
    public string Model { get; set; }
    public string Uri { get; set; }
}
`}
</CodeBlock>
</TabItem>
<TabItem value="open-ai-syntax" label="open-ai-syntax">
<CodeBlock language="csharp">
{`public class AiConnectionString
{
    public string Name { get; set; }
    public string Identifier { get; set; }
    public OpenAiSettings OpenAiSettings { get; set; }
}

public class OpenAiSettings : AbstractAiSettings
{
    public string ApiKey { get; set; }
    public string Endpoint { get; set; }
    public string Model { get; set; }
    public int? Dimensions { get; set; }
    public string OrganizationId { get; set; }
    public string ProjectId { get; set; }
}

public class AbstractAiSettings
{
    public int? EmbeddingsMaxConcurrentBatches { get; set; }
}
`}
</CodeBlock>
</TabItem>
</Tabs>



## Defining the GenAI task

* Define a GenAI task using a `GenAiConfiguration` object.  
* Run the task using `AddGenAiOperation`.  

<TabItem value="something-something" label="gen-ai_define-gen-ai-task">
<CodeBlock language="csharp">
{`_use-sample-object
            GenAiConfiguration config = new GenAiConfiguration
            \{
                // Task name
                Name = "FilterSpam",

                // Unique task identifier
                Identifier = "FilterSpam",

                // Connection string to AI model
                ConnectionStringName = "ollama-cs",

                // Task is enabled
                Disabled = false,

                // Collection associated with the task
                Collection = "Posts",

                // Context generation script - format for objects to be sentto the AI model
                GenAiTransformation = new GenAiTransformation \{
                    Script = @"
                        for(const comment of this.Comments)
                        \{
                            ai.genContext(\{Text: comment.Text, Author: comment.Author, Id: comment.Id\});\}"
                \},

                // AI model Prompt - the instructions sent to the AI model
                Prompt = "Check if the following blog post comment is spam or not",

                // Sample object - a sample response object to format the AI model's replies by
                SampleObject = JsonConvert.SerializeObject(
                    new
                    \{
                        Blocked = true,
                        Reason = "Concise reason for why this comment was marked as spam or ham"
                    \}),

                // Update script - specifies what to do with AI model replies
                UpdateScript = @"    
                        // Find the comment
                        const idx = this.Comments.findIndex(c => c.Id == $input.Id);  
                        // Was detected as spam
                        if($output.Blocked)
                        \{
                            // Remove this comment
                            this.Comments.splice(idx, 1);
                        \}",

                // Max concurrent connections to AI model
                MaxConcurrency = 4
            \};

            // Run the task
            var GenAiOperation = new AddGenAiOperation(config);
            var addAiIntegrationTaskResult = store.Maintenance.Send(GenAiOperation);
`}
</CodeBlock>
</TabItem>
### `GenAiConfiguration`

| Parameters | Type | Description |
| ------------- | ------------- | ----- |
| **Name** | `string` | Task name |
| **Identifier** | `string` | Unique task identifier, embedded in documents metadata to indicate they were processed along with hash codes for their processed parts |
| **ConnectionStringName** | `string` | Connection string name |
| **Disabled** | `bool` | Determines whether the task is enabled or disabled |
| **Collection** | `string` | Name of the document collection associated with the task |
| **GenAiTransformation** | `GenAiTransformation` | Context generation script - format for objects to be sent to the AI model |
| **Prompt** | `string` | AI model Prompt - the instructions sent to the AI model |
| **SampleObject** | `string` | JSON schema - a sample response object to format AI model replies by |
| **UpdateScript** | `string` | Update script - specifies what to do with AI model replies |
| **MaxConcurrency** | `int` | Max concurrent connections to the AI model (each connection serving a single context object |



