---
title: "AI agents: API"
hide_table_of_contents: true
sidebar_label: AI Agent API
sidebar_position: 0
---

import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';
import LanguageSwitcher from "@site/src/components/LanguageSwitcher";
import LanguageContent from "@site/src/components/LanguageContent";

# AI agents: API
<Admonition type="note" title="">

* A RavenDB **AI Agent** can be used by a RavenDB client to invoke a chat or 
  a continuous conversation between the client, an AI model, and a RavenDB database.  

* The AI agent can provide the AI model with a set of query and action tools that 
  the LLM can use freely to access the database or trigger the user to action.  

* In this article:
   * [Creating a connection string](../../ai-integration/ai-agents/ai-agents-api.mdx#creating-a-connection-string)  
   * [Defining and running an AI agent](../..ai-integration/ai-agents/ai-agents-api.mdx#defining-and-running-an-ai-agent)
      * [Define agent configuration](../../ai-integration/ai-agents/ai-agents-api.mdx#define-agent-configuration)
      * [Set Agent ID](../../ai-integration/ai-agents/ai-agents-api.mdx#set-agent-id)
      * [Add agent parameters](../../ai-integration/ai-agents/ai-agents-api.mdx#add-agent-parameters)
      * [Set maximum number of iterations](../../ai-integration/ai-agents/ai-agents-api.mdx#set-maximum-number-of-iterations)
      * [Set chat trimming configuration](../../ai-integration/ai-agents/ai-agents-api.mdx#set-chat-trimming-configuration)
      * [Add Sample object or Schema](../../ai-integration/ai-agents/ai-agents-api.mdx#add-sample-object-or-schema)
      * [Add agent tools](../../ai-integration/ai-agents/ai-agents-api.mdx#add-sample-object-or-schema)
         * [Query tools](../../ai-integration/ai-agents/ai-agents-api.mdx#query-tools)
         * [Action tools](../../ai-integration/ai-agents/ai-agents-api.mdx#query-tools)
      * [Create the agent](../../ai-integration/ai-agents/ai-agents-api.mdx#query-tools)
   * [Conversations](../../ai-integration/ai-agents/ai-agents-api.mdx#conversations)
      * [Chats](../../ai-integration/ai-agents/ai-agents-api.mdx#chats)
      * [Continuous conversations](../../ai-integration/ai-agents/ai-agents-api.mdx#chats)
      * [Stored conversations' Prefix and IDs](../../ai-integration/ai-agents/ai-agents-api.mdx#stored-conversations-prefix-and-ids)
      * [Set and start the chat](../../ai-integration/ai-agents/ai-agents-api.mdx#set-and-start-the-chat)
      * [Chat reply](../../ai-integration/ai-agents/ai-agents-api.mdx#chat-reply)
   * [Full Example](../../ai-integration/ai-agents/ai-agents-api.mdx#full-example)
</Admonition>
## Creating a connection string

Your agent will need a connection string to connect with the LLM. Create a connection string 
using an `AiConnectionString` instance and the `PutConnectionStringOperation` operation.  
(You can also create a connection string using Studio, see [here](../../ai-integration/ai-agents/ai-agents-studio.mdx#configure-basic-settings))

You can use a local `Ollama` model if your considerations are mainly speed, cost, open-source, or security,  
Or you can use a remote `OpenAI` service for its additional resources and capabilities.  
### Example:

<Tabs groupId='languageSyntax'>
<TabItem value="open-ai-cs" label="open-ai-cs">
<CodeBlock language="csharp">
{`using (var store = new DocumentStore())
{
    // Define the connection string to OpenAI
    var connectionString = new AiConnectionString
    {
        // Connection string name & identifier
        Name = "open-ai-cs",

        // OpenAI connection settings
        OpenAiSettings = new OpenAiSettings(
            apiKey: "your-api-key",
            endpoint: "https://api.openai.com/v1",
            // LLM model for text generation
            model: "gpt-4.1")
    };

    // Deploy the connection string to the server
    var operation = new PutConnectionStringOperation<AiConnectionString>(connectionString);
    var putConnectionStringResult = store.Maintenance.Send(operation);
}
`}
</CodeBlock>
</TabItem>
<TabItem value="ollama-cs" label="ollama-cs">
<CodeBlock language="csharp">
{`using (var store = new DocumentStore())
{
    // Define the connection string to Ollama
    var connectionString = new AiConnectionString
    {
        // Connection string name & identifier
        Name = "ollama-cs",

        // Ollama connection settings
        OllamaSettings = new OllamaSettings(
            // LLM Ollama model for text generation
            model: "llama3.2",
            // local URL
            uri: "http://localhost:11434/")
    };

    // Deploy the connection string to the server
    var operation = new PutConnectionStringOperation<AiConnectionString>(connectionString);
    var putConnectionStringResult = store.Maintenance.Send(operation);
}
`}
</CodeBlock>
</TabItem>
</Tabs>
### Syntax:

<Tabs groupId='languageSyntax'>
<TabItem value="open-ai-cs-syntax" label="open-ai-cs-syntax">
<CodeBlock language="csharp">
{`public class AiConnectionString
{
    public string Name { get; set; }
    public string Identifier { get; set; }
    public OpenAiSettings OpenAiSettings { get; set; }
    ...
}

public class OpenAiSettings : AbstractAiSettings
{
    public string ApiKey { get; set; }
    public string Endpoint { get; set; }
    public string Model { get; set; }
    public int? Dimensions { get; set; }
    public string OrganizationId { get; set; }
    public string ProjectId { get; set; }
}
`}
</CodeBlock>
</TabItem>
<TabItem value="ollama-cs-syntax" label="ollama-cs-syntax">
<CodeBlock language="csharp">
{`public class AiConnectionString
{
    public string Name { get; set; }
    public string Identifier { get; set; }
    public OllamaSettings OllamaSettings { get; set; }
    ...
}

public class OllamaSettings : AbstractAiSettings
{
    public string Model { get; set; }
    public string Uri { get; set; }
}
`}
</CodeBlock>
</TabItem>
</Tabs>



## Defining and running an AI agent

## Define agent configuration

To create an AI agent you need to prepare an **agent configuration** and populate it with 
your settings and tools.  

Start by creating a new `AiAgentConfiguration` instance.  
While creating the instance, pass its constructor:  

- The agent's Name  
- The [connection string](../../ai-integration/ai-agents/ai-agents-api.mdx#creating-a-connection-string) you created  
- A System prompt  

The agent will send the system prompt you define here to the LLM, to define the LLM's role 
and explain it how this role should be fulfilled.  

In the following example we create a system prompt that assigns the LLM the role of a helper 
to a human experience manager, who wants to reward the employee who made the biggest profit.

The LLM will retrieve from the Orders collection the IDs of employees and the sums they made 
for each order, to find which employee has made the biggest profit. Then, the LLM will retrieve 
additional information about this employee from the database and suggest the manager a reward.  

We are very careful and selective with the details we send the LLM about employees and orders.  

<TabItem value="ai-agents_AiAgentConfiguration_example" label="ai-agents_AiAgentConfiguration_example">
<CodeBlock language="csharp">
{`// Create an agent configuration instance and start setting it by providing
// it with the agent name, connection string name, and system prompt.
var agent = new AiAgentConfiguration("reward-productive-employee", connectionString.Name,
    "You work for a human experience manager. " +
    "The manager uses your services to find which employee has made the largest profit and to suggest a reward. " +
    "The manager provides you with the name of a country, or with the word \\"everything\\" to indicate all countries. " +
    "then you: " +
    "1. use a query tool to load all the orders sent to the selected countery, " +
    "or a query tool to load all orders sent to all counteries. " +
    "2. calculate which employee made the largest profit." +
    "3. use a query tool to learn in what general area this employee lives." +
    "4. find suitable vacations sites or other rewards based on the employee's residence area." +
    "5. use an action tool to store in the database the employee's ID, profit, and your reward suggestions." +
    "When you're done, return these details in your answer to the user as well."
    );
`}
</CodeBlock>
</TabItem>

* Method definition:  
<TabItem value="ai-agents_AiAgentConfiguration_definition" label="ai-agents_AiAgentConfiguration_definition">
<CodeBlock language="csharp">
{`public AiAgentConfiguration(string name, string connectionStringName, string systemPrompt);
`}
</CodeBlock>
</TabItem>

* `AiAgentConfiguration` definition:
<TabItem value="ai-agents_AiAgentConfiguration-class_definition" label="ai-agents_AiAgentConfiguration-class_definition">
<CodeBlock language="csharp">
{`public class AiAgentConfiguration
\{
    // A unique identifier given to the AI agent configuration
    public string Identifier \{ get; set; \}

    // The name of the AI agent configuration
    public string Name \{ get; set; \}

    // Connection string name
    public string ConnectionStringName \{ get; set; \}

    // The system promnpt that defines the role and purpose of the agent and the LLM
    public string SystemPrompt \{ get; set; \}

    // An example object that sets the layout for the LLM's response to the user.
    // The object is translated to a schema before we send it to the LLM.
    public string SampleObject \{ get; set; \}

    // A schema that sets the layout for the LLM's response to the user.
    // If both a sample object and a schema are defined, only the schema is used.
    public string OutputSchema \{ get; set; \}

    // A list of Query tools that the LLM can use (through the agent) to access the database
    public List<AiAgentToolQuery> Queries \{ get; set; \} = new List<AiAgentToolQuery>();

    // A list of Action tools that the LLM can use to trigger the user to action
    public List<AiAgentToolAction> Actions \{ get; set; \} = new List<AiAgentToolAction>();

    // Agent parameters whose value the client passes to the LLM each time a chat is started, 
    // for stricter control over queris initiated by the LLM and as a means for interaction 
    // between the client and the LLM.  
    public List<AiAgentParameter> Parameters \{ get; set; \} = new List<AiAgentParameter>();

    // The trimming configuration defines if and how the chat history is summarized, 
    // to minimize the amount of data passed to the LLM when a chat is started.  
    public AiAgentChatTrimmingConfiguration ChatTrimming \{ get; set; \} = new AiAgentChatTrimmingConfiguration(new AiAgentSummarizationByTokens());
    
    // Control over the number of times that the LLMis allowed to use agent tools to handle a user prompt.  
    public int? MaxModelIterationsPerCall \{ get; set; \}
\}
`}
</CodeBlock>
</TabItem>
Once the agent configuration is created, we need to add it a few additional elements.  

## Set agent ID

Use the `Identifier` property to provide the agent with a unique ID that the 
system will recognize it by.  
<TabItem value="ai-agents_agent-identifier" label="ai-agents_agent-identifier">
<CodeBlock language="csharp">
{`// Agent ID
agent.Identifier = "reward-productive-employee";
`}
</CodeBlock>
</TabItem>

## Add agent parameters

Agent parameters are optional variables, whose values are provided by the client 
(or by a user through the client) to the agent when a chat is started.  
The values are then embedded by the client in query tools, and used when these 
tools are applied. Users and clients can provide their selections and preferences 
using agent parameters when the chat starts, and focus the queries and the whole 
interaction on their selections.  

In the example shown below, an agent parameter is used to determine what area 
of the world a query will handle. Another example can be a student that uses 
a librarian agent, providing the agent with a subject and having the agent fetch 
and summarize documents related to this subject.  

To add an agent parameter create an `AiAgentParameter` instance, initialize it with 
the parameter's **name** and **description** (explaining the LLM what the parameter 
is for), and pass this instance to the `agent.Parameters.Add` method.  

* Example:
<TabItem value="ai-agents_AiAgentParameter_function" label="ai-agents_AiAgentParameter_function">
<CodeBlock language="csharp">
{`// Agent parametera
agent.Parameters.Add(new AiAgentParameter("country", "A specific country that orders were shipped to, " +
                                          "or \\"everywhere\\" to look for orders shipped to all countries"));
`}
</CodeBlock>
</TabItem>

* `AiAgentParameter` Definition:
<TabItem value="ai-agents_AiAgentParameter_definition" label="ai-agents_AiAgentParameter_definition">
<CodeBlock language="csharp">
{`public AiAgentParameter(string name, string description);
`}
</CodeBlock>
</TabItem>

## Set maximum number of iterations

You can limit the number of times that the LLM is allowed to request the usage of 
agent tools in response to a single user prompt.  
To change this limit use `MaxModelIterationsPerCall`.  

* Example:
<TabItem value="ai-agents_MaxModelIterationsPerCall_function" label="ai-agents_MaxModelIterationsPerCall_function">
<CodeBlock language="csharp">
{`// Limit the number of times the LLM can request for tools in response to a single user prompt
agent.MaxModelIterationsPerCall = 3;
#region ai-agents_CreateAgentAsync_example

#region ai-agents_CreateAgentAsync_example
var createResult = await store.AI.CreateAgentAsync(agent);
`}
</CodeBlock>
</TabItem>

* `AiAgentParameter` Definition:
<TabItem value="ai-agents_MaxModelIterationsPerCall_definition" label="ai-agents_MaxModelIterationsPerCall_definition">
<CodeBlock language="csharp">
{`public int? MaxModelIterationsPerCall
`}
</CodeBlock>
</TabItem>

## Set chat trimming configuration

Since the LLM keeps no history of previous chats, we include in every new message we send 
it the entire conversation from its start.  
To save traffic and tokens, you can summarize older messages.  
This can be helpful when transfer rate and cost are a concern or the context may become 
too large to handle efficiently.  

To summarize old messages create an `AiAgentChatTrimmingConfiguration` instance, 
use this instance to configure your trimming strategy, and set the agent's `ChatTrimming` property 
with the instance.  

When creating the instance, pass its constructor a summarization strategy using 
a `AiAgentSummarizationByTokens` class.  

A history of the original messages, before they were summarized, can optionally be 
kept in the `@conversations-history` collection.  
To determine whether to keep the original messages and for how long, also pass the 
`AiAgentChatTrimmingConfiguration` constructor an `AiAgentHistoryConfiguration` instance 
with your history settings.  

* Example:
<TabItem value="ai-agents_trimming-configuration_example" label="ai-agents_trimming-configuration_example">
<CodeBlock language="csharp">
{`// Set chat trimming configuration
AiAgentSummarizationByTokens summarization = new AiAgentSummarizationByTokens()
\{
    MaxTokensBeforeSummarization = 32768,
    MaxTokensAfterSummarization = 1024
\};

agent.ChatTrimming = new AiAgentChatTrimmingConfiguration(summarization);
`}
</CodeBlock>
</TabItem>

* Syntax:
<TabItem value="ai-agents_trimming-configuration_syntax" label="ai-agents_trimming-configuration_syntax">
<CodeBlock language="csharp">
{`public class AiAgentSummarizationByTokens
\{
    // The maximum number of tokens allowed before summarization is triggered.
    public long? MaxTokensBeforeSummarization \{ get; set; \}

    // The maximum number of tokens allowed in the generated summary.
    public long? MaxTokensAfterSummarization \{ get; set; \}
\}
*/

/*
public class AiAgentHistoryConfiguration
\{
    // Enables history for the AI agents conversations.
    public AiAgentHistoryConfiguration()

    // Enables history for the AI agents conversations.
    // <param name="expiration">The timespan after which history documents expire.</param>
    public AiAgentHistoryConfiguration(TimeSpan expiration)

    // The timespan after which history documents expire.
    public int? HistoryExpirationInSec \{ get; set; \}
\}
`}
</CodeBlock>
</TabItem>


## Add Sample object or Schema

At the end of a chat, when the LLM is done processing and negotiating, 
it returns a structured output reply through the agent to the client in an 
object whose layout we need to prepare beforehand.  

The layout object we prepare is sent to the LLM when the agent is started.  
You can prepare this object in two different formats: a formal **JSON-based 
schema**, or a friendlier **sample object** format, that RavenDB will turn 
to a schema behind the scenes.  
Normally the simpler way is to prepare a sample object and let RavenDB translate 
it to a schema for you.  

If you prepare both a sample object and a schema, the schema will be used.  

Example:
<Tabs groupId='languageSyntax'>
<TabItem value="sample-object" label="sample-object">
<CodeBlock language="json">
{`{
    "DocumentName": "The document's original title",
    "DocumentSummary": "The summarized document"
}
`}
</CodeBlock>
</TabItem>
<TabItem value="schema" label="schema">
<CodeBlock language="json">
{`{
  "name": "QSt6RSthRGQ5OEVhNTBETTJSOHhUaWc5VDRocXV6MjM0OU85M2tJYnhMbz0",
  "strict": true,
  "schema": {
    "type": "object",
    "properties": {
      "DocumentName": {
        "type": "string",
        "description": "The document\\u0027s original title"
      },
      "DocumentSummary": {
        "type": "string",
        "description": "The summarized document"
      }
    },
    "required": [
      "DocumentName",
      "DocumentSummary"
    ],
    "additionalProperties": false
  }
}
`}
</CodeBlock>
</TabItem>
</Tabs>

To prepare a sample object, use the agent's `SampleObject` string property.  
To prepare a schema, use `OutputSchema`.  
<TabItem value="ai-agents_agent_sampleObjectString" label="ai-agents_agent_sampleObjectString">
<CodeBlock language="csharp">
{`// Set LLM response object
agent.SampleObject = "\{" +
                        "\\"EmployeeID\\": \\"embed the employee’s ID here\\"," +
                        "\\"Profit\\": \\"embed the profit made by the employee here\\"," +
                        "\\"SuggestedReward\\": \\"embed suggested rewards here\\"" +
                     "\}";
`}
</CodeBlock>
</TabItem>


## Add agent tools

You can enhance your agent with Query and Action tools, that allow the LLM 
to query your database and trigger client actions.  

After defining agent tools and submitting them to the LLM, it is up to the LLM 
to decide if and when to use them. 

### Query tools

Query tools provide the LLM with the ability to retrieve data from the database.  
Once defined, the LLM can use them of its own accord.  

A query tool includes a a natural-language **description** that explain the LLM what 
the tool is for, and an **RQL query**.  
To use a query tool, the LLM will requests the agent to apply it, and the agent will 
run the query and send the LLM the results.  

The RQL query can include parameters.  
E.g., `where Country == $country`
When these parameters are agent parameters, their values are provided by the user 
when the chat is initiated.  
But a query tool also includes a **tool parameters schema** that defines parameters 
that the LLM can set and request the agent to use in the query.  

You can choose for yourself whether to define the tool parameters schema as 
a **sample object** or **schema**, just be aware that if you define both only 
the schema will be used.  

Query tools are for **read only operations**. To make changes in the database, 
use an action tool.  

* **Example**:  
  Two of the query tools shown here retrieve the orders that were sent to a certain 
  country if the manager provided (in an agent parameter) a country, or in all countries 
  if the parameter says "everywhere".  
  The third tool retrieves the general location of an employee that the LLM picked.  
<TabItem value="ai-agents_agent_query-tool-sample" label="ai-agents_agent_query-tool-sample">
<CodeBlock language="csharp">
{`// Create query tools
agent.Queries =
[
    // Creata a query tool that triggers the agent to retrieve all the orders that were sent to all countries
    new AiAgentToolQuery
    \{
        Name = "retrieve-orders-sent-to-all-countries",
        Description = "a query tool that allows you to retrieve all orders sent to all countries.",
        Query = "from Orders as O select O.Employee, O.Lines.Quantity",
        ParametersSampleObject = "\{\}"
    \},
    
    // Create a query tool that triggers the agent to retrieve all the orders that were sent to a specific country
    new AiAgentToolQuery
    \{
        Name = "retrieve-orders-sent-to-a-specific-country",
        Description = "a query tool that allows you to retrieve all orders sent to a specific country",
        Query = "from Orders as O where O.ShipTo.Country == $country select O.Employee, O.Lines.Quantity",
        ParametersSampleObject = "\{\}"
    \},

    // Create a query tool that triggers the agent to retrieve the performer's living region 
    // details from the database
    new AiAgentToolQuery
    \{
        Name = "retrieve-performer-living-region",
        Description = "a query tool that allows you to retrieve an employee's country, city, and region, by the employee's ID",
        Query = "from Employees as E where id() == $employeeId select E.Address.Country, E.Address.City, E.Address.Region",
        ParametersSampleObject = "\{" +
                                    "\\"employeeId\\": \\"embed the employee's ID here\\"" +
                                 "\}"
    \}
];
`}
</CodeBlock>
</TabItem>

* **Syntax**:
  Query tools are defined in a list of `AiAgentToolQuery` classes.  
<TabItem value="ai-agents_AiAgentToolQuery_definition" label="ai-agents_AiAgentToolQuery_definition">
<CodeBlock language="csharp">
{`public class AiAgentToolQuery
\{
    public string Name \{ get; set; \}
    public string Description \{ get; set; \}
    public string Query \{ get; set; \}
    public string ParametersSampleObject \{ get; set; \}
    public string ParametersSchema \{ get; set; \}
\}
`}
</CodeBlock>
</TabItem>


### Action tools

Action tools allow the LLM to trigger the client to perform actions like modifying, adding, 
or removing documents.  

Unlike a query tool, an action tool does not include a query. It only includes a description 
and a schema.  
The description informs the LLM in natural language what the tool is capable of.  
The schema is filled by the LLM with values when it requests the agent to apply the action.  

When the agent sends the client a request to use an action tool, the client will need to 
perform the action, and reply to the agent when it's done.  

* The following action tool sends the client an ID so the client will store it in the 
  databse.  
<TabItem value="ai-agents_agent_action-tool-sample" label="ai-agents_agent_action-tool-sample">
<CodeBlock language="csharp">
{`// Create action tools
agent.Actions =
[
    // Create an action tool that triggers the client to store the performer's details
    new AiAgentToolAction
        \{
            Name = "store-performer-details",
            Description = "an action tool that allows you to store the ID of the employee that made " +
                          "the largest profit, the profit, and your suggestions for a reward, in the database.",
            ParametersSampleObject = "\{" +
                                        "\\"employeeID\\": \\"embed the employee’s ID here\\"," +
                                        "\\"profit\\": \\"embed the employee’s profit here\\"," +
                                        "\\"suggestedReward\\": \\"embed your suggestions for a reward here\\"" +
                                     "\}"
        \}
];
`}
</CodeBlock>
</TabItem>

* Syntax:
  Action tools are defined in a list of `AiAgentToolAction` classes.  
<TabItem value="ai-agents_AiAgentToolAction_definition" label="ai-agents_AiAgentToolAction_definition">
<CodeBlock language="csharp">
{`public class AiAgentToolAction
\{
    public string Name \{ get; set; \}
    public string Description \{ get; set; \}
    public string ParametersSampleObject \{ get; set; \}
    public string ParametersSchema \{ get; set; \}

\}
`}
</CodeBlock>
</TabItem>

## Create the agent

Now that the agent configuration is ready, we can create the agent using the `CreateAgentAsync` operation.  
`CreateAgentAsync` has multiple overloads that we can use, including two that use the return schema defined 
within the agent configuration and one that passes to the method a sample object that will define the schema.  

* Example:  
<TabItem value="ai-agents_CreateAgentAsync_example" label="ai-agents_CreateAgentAsync_example">
<CodeBlock language="csharp">
{`#region ai-agents_CreateAgentAsync_example
var createResult = await store.AI.CreateAgentAsync(agent);
`}
</CodeBlock>
</TabItem>

* Syntax:  
<TabItem value="ai-agents_CreateAgentAsync_overloads" label="ai-agents_CreateAgentAsync_overloads">
<CodeBlock language="csharp">
{`// Create the agent with just the defined agent configuration
CreateAgentAsync(configuration);

CreateAgentAsync(AiAgentConfiguration configuration, CancellationToken token = default(CancellationToken));

// Create the agent with the agent configuration,         
CreateAgentAsync<TSchema>(AiAgentConfiguration configuration, TSchema sampleObject, CancellationToken token = default(CancellationToken));
`}
</CodeBlock>
</TabItem>



## Conversations

A conversation is a communication session between the client, the agent, and the LLM, 
during which the LLM may use agent tools to interact with the database and the client.  

If [agent parameters](../../ai-integration/ai-agents/ai-agents-api.mdx#add-agent-parameters) 
were defined, the agent will start the conversation only when they are provided.  

### Continuous conversations
The LLM does not record its chats, starting a new chat means losing the chat history.  
The AI agent allows a continuous conversation by storing conversations history in the 
`@conversations` collection. When a new chat starts, it continues where it left off 
because the agent sends the conversation history to the LLM.  

### Stored conversations' Prefix and IDs
Conversations are kept in the `@conversations` collection with a prefix (such as `Chats/`) 
that can be set when the conversation is initiated. The conversation ID that follows the prefix 
is created automatically by RavenDB, similarly to the creation of automatic IDs for documents.  

You can:  

* Provide a full ID  
* Provide a prefix that ends with `/` or `|` to trigger automatic ID creation.  


## Set the conversation

- Set a chat using the `store.AI.Conversation` method.  
  Pass `Conversation`:  
   - The **agent ID**  
   - The **conversaion ID**  
     If you pass the method the ID of an existing conversation (e.g. `"Chats/0000000000000008883-A"`) 
     the conversation will be retrieved from storage and continued where you left off.  
     If you provide an empty prefix (e.g. `"Chats/`), a new conversation will start.  
   - **agent parameter values** in an `AiConversationCreationOptions` instance.  
- Set the user prompt using the `SetUserPrompt`method.  
  The user prompt informs the agent with the user's requests and expectations for this chat.  
- Use the value returned by the `Conversation` method to run the chat.

* Example: 
<TabItem value="ai-agents_Conversation_example" label="ai-agents_Conversation_example">
<CodeBlock language="csharp">
{`// Set chat ID, prefix, and agent parameters
var chat = store.AI.Conversation(
    createResult.Identifier,
    "Performers/",
    new AiConversationCreationOptions().AddParameter("country", "France"));
`}
</CodeBlock>
</TabItem>

* `Conversation` Definition:  
<TabItem value="ai-agents_Conversation_definition" label="ai-agents_Conversation_definition">
<CodeBlock language="csharp">
{`public IAiConversationOperations Conversation(string agentId, string conversationId, AiConversationCreationOptions creationOptions, string changeVector = null)
`}
</CodeBlock>
</TabItem>

* `SetUserPrompt` Definition:  
<TabItem value="ai-agents_SetUserPrompt_definition" label="ai-agents_SetUserPrompt_definition">
<CodeBlock language="csharp">
{`void SetUserPrompt(string userPrompt);
`}
</CodeBlock>
</TabItem>

### Handling action tools

Handle action tools messages by passing the chat's `Handle` method the name of the 
action toolyou want it to handle. When the LLM sends your agent action tool requests, 
the data they include will reach the `Handle` method.  
Also pass `Handle` an object to receive the incoming data, in the same structure 
that you gave the action tool's sample object.  
When you finish handling the requested action `return` the LLM an indication that 
it was done.  

<TabItem value="ai-agents_Conversation_handle-for-action-tool" label="ai-agents_Conversation_handle-for-action-tool">
<CodeBlock language="csharp">
{`// Handle the action tool that the LLM uses to store an employee's details in the database
chat.Handle("store-performer-details", (Performer performer) =>
\{
    using (var session1 = store.OpenSession())
    \{
        Performer rewarded = new Performer
        \{
            employeeID = performer.employeeID,
            profit = performer.profit,
            suggestedReward = performer.suggestedReward
        \};

        session1.Store(rewarded);
        session1.SaveChanges();
    \}
    return "done";
\});
`}
</CodeBlock>
</TabItem>

<TabItem value="ai-agents_Conversation_action-tool-data-object" label="ai-agents_Conversation_action-tool-data-object">
<CodeBlock language="csharp">
{`// An object for the LLM response
public class Performer
\{
    public string employeeID;
    public string profit;
    public string suggestedReward;
\}
`}
</CodeBlock>
</TabItem>

### Chat reply

LLM replies are returned by the agent to the client in an `AiAnswer` object.  
The conversation status is indicated by `AiAnswer.AiConversationResult`.   

* `AiAnswer`syntax:
<TabItem value="ai-agents_AiAnswer" label="ai-agents_AiAnswer">
<CodeBlock language="csharp">
{`public class AiAnswer<TAnswer>
\{
    // The answer content produced by the AI
    public TAnswer Answer;

    // The status of the conversation
    public AiConversationResult Status;
\}

public enum AiConversationResult
\{
    // The conversation has completed and a final answer is available
    Done,
    // Further interaction is required, such as responding to tool requests
    ActionRequired
\}
`}
</CodeBlock>
</TabItem>

### Set user prompt and run the chat

Set the user prompt using the `SetUserPrompt` method, and run the chat with the
`RunAsync` method.
<TabItem value="ai-agents_Conversation_user-prompt-and-run" label="ai-agents_Conversation_user-prompt-and-run">
<CodeBlock language="csharp">
{`// Set the user prompt and run the chat
chat.SetUserPrompt("send a few suggestions to reward the employee that made the largest profit");

var LLMResponse = await chat.RunAsync<Performer>(CancellationToken.None);

if (LLMResponse.Status == AiConversationResult.Done)
\{
    // The LLM successfully processed the user prompt and returned its response.
    // The performer's ID was stored in the Performers collection by the action tool.  
    // LLM response includes the performer's ID, profit, and suggested rewards.
\}
`}
</CodeBlock>
</TabItem>



## Full example

The agent in this example helps a human experience manage to reward employees.  
It searches, using query tools, the orders sent to a certain country or (if the 
manager prompts it "everywhere") to all countries, and finds the employee that 
made the larget profit. It then uses another query tool to find in which region 
this employee lives, and finds rewards based on this location. Finally, it 
uses an action tool to store the employee's ID in a `Performers` collection, 
and returns, in its final response, the employee's ID, profits, and suggested rewards.  

<TabItem value="ai-agents-full-example" label="ai-agents-full-example">
<CodeBlock language="csharp">
{`public async Task usingHandleToRunChat_full()
\{
    var store = new DocumentStore();

    // Define the connection string to OpenAI
    var connectionString = new AiConnectionString
    \{
        // Connection string name & identifier
        Name = "open-ai-cs",

        ModelType = AiModelType.Chat,

        // OpenAI connection settings

        OpenAiSettings = new OpenAiSettings(
            apiKey: "your api key",
            endpoint: "https://api.openai.com/v1",
            // LLM model for text generation
            model: "gpt-4.1")
    \};

    // Deploy the connection string to the server
    var operation = new PutConnectionStringOperation<AiConnectionString>(connectionString);
    var putConnectionStringResult = store.Maintenance.Send(operation);

    using var session = store.OpenAsyncSession();

    // Create an agent configuration instance and start setting it by providing
    // it with the agent name, connection string name, and system prompt.
    var agent = new AiAgentConfiguration("reward-productive-employee", connectionString.Name,
        "You work for a human experience manager. " +
        "The manager uses your services to find which employee has made the largest profit and to suggest a reward. " +
        "The manager provides you with the name of a country, or with the word \\"everything\\" to indicate all countries. " +
        "then you: " +
        "1. use a query tool to load all the orders sent to the selected countery, " +
        "or a query tool to load all orders sent to all counteries. " +
        "2. calculate which employee made the largest profit." +
        "3. use a query tool to learn in what general area this employee lives." +
        "4. find suitable vacations sites or other rewards based on the employee's residence area." +
        "5. use an action tool to store in the database the employee's ID." +
        "When you're done, return these details in your answer to the user as well."
        );

    // Agent ID
    agent.Identifier = "reward-productive-employee";

    //  Agent parametera
    agent.Parameters.Add(new AiAgentParameter("country", "A specific country that orders were shipped to, " +
                                              "or \\"everywhere\\" to look for orders shipped to all countries"));

    // Set LLM response object
    agent.SampleObject = "\{" +
                            "\\"EmployeeID\\": \\"embed the employee’s ID here\\"," +
                            "\\"Profit\\": \\"embed the profit made by the employee here\\"," +
                            "\\"SuggestedReward\\": \\"embed suggested rewards here\\"" +
                         "\}";

    // Create query tools
    agent.Queries =
    [
        // Creata a query tool that triggers the agent to retrieve all the orders that were sent to all countries
        new AiAgentToolQuery
        \{
            Name = "retrieve-orders-sent-to-all-countries",
            Description = "a query tool that allows you to retrieve all orders sent to all countries.",
            Query = "from Orders as O select O.Employee, O.Lines.Quantity",
            ParametersSampleObject = "\{\}"
        \},
        
        // Create a query tool that triggers the agent to retrieve all the orders that were sent to a specific country
        new AiAgentToolQuery
        \{
            Name = "retrieve-orders-sent-to-a-specific-country",
            Description = "a query tool that allows you to retrieve all orders sent to a specific country",
            Query = "from Orders as O where O.ShipTo.Country == $country select O.Employee, O.Lines.Quantity",
            ParametersSampleObject = "\{\}"
        \},

        // Create a query tool that triggers the agent to retrieve the performer's living region 
        // details from the database
        new AiAgentToolQuery
        \{
            Name = "retrieve-performer-living-region",
            Description = "a query tool that allows you to retrieve an employee's country, city, and region, by the employee's ID",
            Query = "from Employees as E where id() == $employeeId select E.Address.Country, E.Address.City, E.Address.Region",
            ParametersSampleObject = "\{" +
                                        "\\"employeeId\\": \\"embed the employee's ID here\\"" +
                                     "\}"
        \}
    ];

    // Create action tools
    agent.Actions =
    [
        // Create an action tool that triggers the client to store the performer's details
        new AiAgentToolAction
            \{
                Name = "store-performer-details",
                Description = "an action tool that allows you to store the ID of the employee that made " +
                              "the largest profit, the profit, and your suggestions for a reward, in the database.",
                ParametersSampleObject = "\{" +
                                            "\\"employeeID\\": \\"embed the employee’s ID here\\"," +
                                            "\\"profit\\": \\"embed the employee’s profit here\\"," +
                                            "\\"suggestedReward\\": \\"embed your suggestions for a reward here\\"" +
                                         "\}"
            \}
    ];

    // Set chat trimming configuration
    AiAgentSummarizationByTokens summarization = new AiAgentSummarizationByTokens()
    \{
        MaxTokensBeforeSummarization = 32768,
        MaxTokensAfterSummarization = 1024
    \};

    agent.ChatTrimming = new AiAgentChatTrimmingConfiguration(summarization);

    // Limit the number of times the LLM can request for tools in response to a single user prompt
    agent.MaxModelIterationsPerCall = 3;

    var createResult = await store.AI.CreateAgentAsync(agent);

    // Set chat ID, prefix, and agent parameters
    var chat = store.AI.Conversation(
        createResult.Identifier,
        "Performers/",
        new AiConversationCreationOptions().AddParameter("country", "France"));

    // Handle the action tool that the LLM uses to store an employee's details in the database
    chat.Handle("store-performer-details", (Performer performer) =>
    \{
        using (var session1 = store.OpenSession())
        \{
            Performer rewarded = new Performer
            \{
                employeeID = performer.employeeID,
                profit = performer.profit,
                suggestedReward = performer.suggestedReward
            \};

            session1.Store(rewarded);
            session1.SaveChanges();
        \}
        return "done";
    \});

    // Set the user prompt and run the chat
    chat.SetUserPrompt("send a few suggestions to reward the employee that made the largest profit");

    var LLMResponse = await chat.RunAsync<Performer>(CancellationToken.None);

    if (LLMResponse.Status == AiConversationResult.Done)
    \{
        // The LLM successfully processed the user prompt and returned its response.
        // The performer's ID was stored in the Performers collection by the action tool.  
        // LLM response includes the performer's ID, profit, and suggested rewards.
    \}
\}
`}
</CodeBlock>
</TabItem>



