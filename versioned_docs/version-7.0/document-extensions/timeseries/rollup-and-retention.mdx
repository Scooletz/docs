---
title: "Time Series Rollups and Retention"
hide_table_of_contents: true
sidebar_label: Rollups and Retention
sidebar_position: 4
---

import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';
import LanguageSwitcher from "@site/src/components/LanguageSwitcher";
import LanguageContent from "@site/src/components/LanguageContent";

export const supportedLanguages = ["csharp", "python", "php", "nodejs"];


# Time Series Rollups and Retention
<LanguageSwitcher supportedLanguages={supportedLanguages} />
<LanguageContent language="csharp">

<Admonition type="note" title="Note">

Many time series applications produce massive amounts of data at a steady rate.  
**Time Series Policies** help you manage your data in two ways:  

* Creating **Rollups**:  
  Summarizing time series data by aggregating it into the form of a new, lower-resolution time series.

* Limiting **Retention**:  
  Controlling the duration for which time series data is kept before deletion.
 
* In this page:  
  * [Time series policies](../../document-extensions/timeseries/rollup-and-retention.mdx#time-series-policies)  
  * [Examples](../../document-extensions/timeseries/rollup-and-retention.mdx#examples)  
      * [Create time series policy](../../document-extensions/timeseries/rollup-and-retention.mdx#create-time-series-policies)  
      * [Retrieve rollup data](../../document-extensions/timeseries/rollup-and-retention.mdx#retrieve-rollup-data)
  * [Syntax](../../document-extensions/timeseries/rollup-and-retention.mdx#syntax)

</Admonition>
## Time series policies

#### What are rollups?

A rollup is a time series that summarizes the data from another time series, 
with each rollup entry representing a specific time frame in the original time series.  
Each rollup entry contains 6 values that aggregate the data from all the entries in the original time frame:  

* *First* - the value of the first entry in the frame.  
* *Last* - the value of the last entry.  
* *Min* - the smallest value.  
* *Max* - the largest value.  
* *Sum* - the sum of all the values in the frame.  
* *Count* - the total number of entries in the frame.  

This results in a much more compact time series that still contains useful information about the original time series (also called "raw" time series).

#### Rollup policies:

Rollup time series are created automatically according to rollup policies that can be defined from Studio or client code.  

* A rollup policy applies to all time series of every document in the given collection. 

* Each collection can be configured to have multiple policies which are applied sequentially:
  * The raw time series is first rolled up using the policy with the shortest aggregation frame.
  * Subsequently, the resulting rollup time series is further aggregated using the policy with the next shortest aggregation frame,  
    and so on.

[Querying with group-by](../../document-extensions/timeseries/querying/aggregation-and-projections.mdx) 
will transparently traverse over the rollups to retrieve the relevant results.  

Let's look at an example of rollup data:  

!["Rollup time series entries"](./assets/rollup-1.png)

**1) Name:**  
The name of a rollup time series has this format: `<name of raw time series>@<name of time series policy>`  
It is a combination of the name of the raw time series and the name of the time series policy separated by `@`.  
In the image above these are "HeartRates" and "byHour" respectively.  
For this reason, neither a time series name nor a policy name can have the character `@` in it.

**2) Timestamp:**  
The aggregation frame always begins at a round number of one of these time units: a second, minute, hour, day, week, month, or year. 
So the frame includes all entries starting at a round number of time units, and ending at a round number *minus one millisecond* 
(since milliseconds are the minimal resolution in RavenDB time series). 
The timestamp for a rollup entry is the beginning of the frame it represents.  

For example, if the aggregation frame is three days, a frame will start and end at a time stamps like:  
`2020-01-01 00:00:00` - `2020-01-03 23:59:59.999`.

**3) Values:**  
Each group of six values represents one value from the original entries. 
If the raw time series has `n` values per entry, the rollup time series will have `6 * n` per entry: 
the first six summarize the first raw value, the next six summarize the next raw value, and so on. 
The aggregated values have the names: `"First (<name of raw value>)", "Last (<name of raw value>)", ...` respectively.  

Because time series entries are limited to 32 values, rollups are limited to the first five values of an original time series entry, or 30 aggregate values.  



## Examples

#### Create time series policies:

<TabItem value="rollup_and_retention_0" label="rollup_and_retention_0">
<CodeBlock language="csharp">
{`var oneWeek = TimeValue.FromDays(7);
var fiveYears = TimeValue.FromYears(5);

// Define a policy on the RAW time series data:
// ============================================
var rawPolicy = new RawTimeSeriesPolicy(fiveYears); // Retain entries for five years

// Define a ROLLUP policy: 
// =======================
var rollupPolicy = new TimeSeriesPolicy(
        "By1WeekFor1Year", // Name of policy
        oneWeek, // Aggregation time, roll-up the data for each week
        fiveYears); // Retention time, keep data for five years

// Define the time series configuration for collection "Companies" (use above policies):
// =====================================================================================
var timeSeriesConfig = new TimeSeriesConfiguration();
timeSeriesConfig.Collections["Companies"] = new TimeSeriesCollectionConfiguration
\{
    Policies = new List<TimeSeriesPolicy> \{ rollupPolicy \},
    RawPolicy = rawPolicy
\};
               
// Deploy the time series configuration to the server
// by sending the 'ConfigureTimeSeriesOperation' operation:
// ========================================================
store.Maintenance.Send(new ConfigureTimeSeriesOperation(timeSeriesConfig));

// NOTE:
// The time series entries in the RavenDB sample data are dated up to the year 2020.
// To ensure that you see the rollup time series created when running this example,
// the retention time should be set to exceed that year.
`}
</CodeBlock>
</TabItem>
#### Retrieve rollup data:

* Retrieving entries from a rollup time series is similar to getting the raw time series data.

* Learn more about using `TimeSeriesFor.Get` in [Get time series entries](../../document-extensions/timeseries/client-api/session/get/get-entries.mdx).

<TabItem value="rollup_and_retention_1" label="rollup_and_retention_1">
<CodeBlock language="csharp">
{`// Get all data from the RAW time series:
// ======================================

var rawData = session
    .TimeSeriesFor("companies/91-A", "StockPrices")
    .Get(DateTime.MinValue, DateTime.MaxValue);

// Get all data from the ROLLUP time series:
// =========================================

// Either - pass the rollup name explicitly to 'TimeSeriesFor':
var rollupData = session
    .TimeSeriesFor("companies/91-A", "StockPrices@By1WeekFor1Year")
    .Get(DateTime.MinValue, DateTime.MaxValue);

// Or - get the rollup name by calling 'GetTimeSeriesName':
rollupData = session
    .TimeSeriesFor("companies/91-A", rollupPolicy.GetTimeSeriesName("StockPrices"))
    .Get(DateTime.MinValue, DateTime.MaxValue);

// The raw time series has 100 entries
Assert.Equal(rawData.Length, 100);
Assert.Equal(rawData[0].IsRollup, false);

// The rollup time series has only 22 entries
// as each entry aggregates 1 week's data from the raw time series
Assert.Equal(rollupData.Length, 22);
Assert.Equal(rollupData[0].IsRollup, true);
`}
</CodeBlock>
</TabItem>



## Syntax

### The time series policies

* Raw policy:  
  * Used to define the retention time of the raw time series. 
  * Only one such policy per collection can be defined.
  * Does not perform aggregation.

* Rollup policy:  
  * Used to define the aggregation time frame and retention time for the rollup time series.
  * Multiple policies can be defined per collection.

<TabItem value="csharp" label="csharp">
<CodeBlock language="csharp">
{`public class RawTimeSeriesPolicy : TimeSeriesPolicy
\{
    public TimeValue RetentionTime;
\}

public class TimeSeriesPolicy
\{
    public string Name;
    public TimeValue RetentionTime; \{ get; protected set; \}
    public TimeValue AggregationTime; \{ get; private set; \}
\}
`}
</CodeBlock>
</TabItem>

| Property             | Description                                                                                                                                                                                                    |
|----------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Name**             | This string is used to create the name of the rollup time series.
`Name` is added to the raw time series name - with `@` as a separator,<br/>e.g.: `<name of raw time series>@<name of time series policy>` |
| **RetentionTime**    | Time series entries older than this time span (see `TimeValue` below) are automatically deleted.                                                                                                               |
| **AggregationTime**  | The time series data being rolled up is divided into parts of this length of time, rounded to nearest time units. Each part is aggregated into an entry of the rollup time series.                             |

<TabItem value="csharp" label="csharp">
<CodeBlock language="csharp">
{`public struct TimeValue
\{
    public static TimeValue FromSeconds(int seconds);
    public static TimeValue FromMinutes(int minutes);
    public static TimeValue FromHours(int hours);
    public static TimeValue FromDays(int days);
    public static TimeValue FromMonths(int months);
    public static TimeValue FromYears(int years);
\}
`}
</CodeBlock>
</TabItem>

Each of the above `TimeValue` methods returns a `TimeValue` object representing a whole number of the specified time units. 
These methods are used to define the aggregation and retention spans om time series policies.  

<Admonition type="info" title="Info">
The main reason we use `TimeValue` rather than something like `TimeSpan` is that `TimeSpan` doesn't have a notion of 'months' 
because a calendar month is not a standard unit of time (as it can range from 28 to 31 days).  
`TimeValue` enables you to define retention and aggregation spans specifically tailored to calendar months.
</Admonition>
### The time series configuration object

<TabItem value="csharp" label="csharp">
<CodeBlock language="csharp">
{`public class TimeSeriesConfiguration
\{
    public Dictionary<string, TimeSeriesCollectionConfiguration> Collections;
\}

public class TimeSeriesCollectionConfiguration
\{
    public bool Disabled;
    public List<TimeSeriesPolicy> Policies;
    public RawTimeSeriesPolicy RawPolicy;
\}
`}
</CodeBlock>
</TabItem>

| Property        | Description                                                                                                               |
|-----------------|---------------------------------------------------------------------------------------------------------------------------|
| **Collections** | Populate this `Dictionary` with the collection names and their corresponding `TimeSeriesCollectionConfiguration` objects. |
| **Disabled**    | If set to `true`, rollup processes will stop, and time series data will not be deleted by retention policies.             |
| **Policies**    | Populate this `List` with your rollup policies.                                                                           |
| **RawPolicy**   | The `RawTimeSeriesPolicy`, the retention policy for the raw time series.                                                  |
### The time series configuration operation

<TabItem value="csharp" label="csharp">
<CodeBlock language="csharp">
{`public ConfigureTimeSeriesOperation(TimeSeriesConfiguration configuration);
`}
</CodeBlock>
</TabItem>

Learn more about operations in: [What are operations](../../client-api/operations/what-are-operations.mdx).  
### Casting time series entries

Time series entries are of one of the following classes:  

<TabItem value="csharp" label="csharp">
<CodeBlock language="csharp">
{`public class TimeSeriesEntry \{   \}
public class TimeSeriesEntry<T> : TimeSeriesEntry \{   \}
public class TimeSeriesRollupEntry<TValues> : TimeSeriesEntry \{   \}
`}
</CodeBlock>
</TabItem>

If you have an existing rollup entry of type `TimeSeriesEntry`,  
you can cast it to a `TimeSeriesRollupEntry` using `AsRollupEntry()`.  

<TabItem value="csharp" label="csharp">
<CodeBlock language="csharp">
{`public static TimeSeriesRollupEntry<T> AsRollupEntry<T>(this TimeSeriesEntry<T> entry);
`}
</CodeBlock>
</TabItem>

You can cast a `TimeSeriesRollupEntry` to a `TimeSeriesEntry` directly.  
Its values will consist of all the `First` values of the rollup entry.  

<TabItem value="csharp" label="csharp">
<CodeBlock language="csharp">
{`var rollupEntry = new TimeSeriesRollupEntry<int>(new DateTime(2020,1,1));
TimeSeriesEntry<int> TSEntry = (TimeSeriesEntry<int>)rollupEntry;
`}
</CodeBlock>
</TabItem>

Read more about time series with generic types [here](../../document-extensions/timeseries/client-api/named-time-series-values.mdx).




</LanguageContent>
<LanguageContent language="python">

<Admonition type="note" title="Note">

Many time series applications produce massive amounts of data at a steady rate.  
**Time Series Policies** help you manage your data in two ways:  

* Creating **Rollups**:  
  Summarizing time series data by aggregating it into the form of a new, lower-resolution time series.

* Limiting **Retention**:  
  Controlling the duration for which time series data is kept before deletion.
 
* In this page:  
  * [Time series policies](../../document-extensions/timeseries/rollup-and-retention.mdx#time-series-policies)  
  * [Examples](../../document-extensions/timeseries/rollup-and-retention.mdx#examples)  
      * [Create time series policy](../../document-extensions/timeseries/rollup-and-retention.mdx#create-time-series-policies)  
      * [Retrieve rollup data](../../document-extensions/timeseries/rollup-and-retention.mdx#retrieve-rollup-data)
  * [Syntax](../../document-extensions/timeseries/rollup-and-retention.mdx#syntax)

</Admonition>
## Time series policies

#### What are rollups?

A rollup is a time series that summarizes the data from another time series, 
with each rollup entry representing a specific time frame in the original time series.  
Each rollup entry contains 6 values that aggregate the data from all the entries in the original time frame:  

* `First` - the value of the first entry in the frame.  
* `Last` - the value of the last entry.  
* `Min` - the smallest value.  
* `Max` - the largest value.  
* `Sum` - the sum of all the values in the frame.  
* `Count` - the total number of entries in the frame.  

This results in a much more compact time series that still contains useful information about the original time series (also called "raw" time series).

#### Rollup policies:

Rollup time series are created automatically according to rollup policies that can be defined from Studio or client code.  

* A rollup policy applies to all time series of every document in the given collection. 

* Each collection can be configured to have multiple policies which are applied sequentially:
  * The raw time series is first rolled up using the policy with the shortest aggregation frame.
  * Subsequently, the resulting rollup time series is further aggregated using the policy with the next shortest aggregation frame,  
    and so on.

[Querying with group-by](../../document-extensions/timeseries/querying/aggregation-and-projections.mdx) 
will transparently traverse over the rollups to retrieve the relevant results.  

Let's look at an example of rollup data:  

!["Rollup time series entries"](./assets/rollup-1.png)

**1) Name:**  
The name of a rollup time series has this format: `<name of raw time series>@<name of time series policy>`  
It is a combination of the name of the raw time series and the name of the time series policy separated by `@`.  
In the image above these are "HeartRates" and "byHour" respectively.  
For this reason, neither a time series name nor a policy name can have the character `@` in it.

**2) Timestamp:**  
The aggregation frame always begins at a round number of one of these time units: a second, minute, hour, day, week, month, or year. 
So the frame includes all entries starting at a round number of time units, and ending at a round number *minus one millisecond* 
(since milliseconds are the minimal resolution in RavenDB time series). 
The timestamp for a rollup entry is the beginning of the frame it represents.  

For example, if the aggregation frame is three days, a frame will start and end at a time stamps like:  
`2020-01-01 00:00:00` - `2020-01-03 23:59:59.999`.

**3) Values:**  
Each group of six values represents one value from the original entries. 
If the raw time series has `n` values per entry, the rollup time series will have `6 * n` per entry: 
the first six summarize the first raw value, the next six summarize the next raw value, and so on. 
The aggregated values have the names: `"First (<name of raw value>)", "Last (<name of raw value>)", ...` respectively.  

Because time series entries are limited to 32 values, rollups are limited to the first five values of an original time series entry, or 30 aggregate values.  



## Examples

#### Create time series policies:

<TabItem value="rollup_and_retention_0" label="rollup_and_retention_0">
<CodeBlock language="python">
{`# Policy for the original ("raw") time-series,
# to keep the data for one week
one_week = TimeValue.of_days(7)
raw_retention = RawTimeSeriesPolicy(one_week)

# Roll-up the data for each day,
# and keep the results for one year
one_day = TimeValue.of_days(1)
one_year = TimeValue.of_years(1)
daily_rollup = TimeSeriesPolicy("DailyRollupForOneYear", one_day, one_year)

# Enter the above policies into a
# time-series collection configuration
# for the collection 'Sales'
sales_ts_config = TimeSeriesCollectionConfiguration(policies=[daily_rollup], raw_policy=raw_retention)

# Enter the configuration for the Sales collection
# into a time-series configuration for the whole database
database_ts_config = TimeSeriesConfiguration()
database_ts_config.collections["Sales"] = sales_ts_config

# Send the time-series configuration to the server
store.maintenance.send(ConfigureTimeSeriesOperation(database_ts_config))
`}
</CodeBlock>
</TabItem>
#### Retrieve rollup data:

* Retrieving entries from a rollup time series is similar to getting the raw time series data.

* Learn more about using `time_series_for.get` in [Get time series entries](../../document-extensions/timeseries/client-api/session/get/get-entries.mdx).

<TabItem value="rollup_and_retention_1" label="rollup_and_retention_1">
<CodeBlock language="python">
{`# Create local instance of the time-series "rawSales"
# in the document "sales/1"
raw_ts = session.time_series_for("sales/1", "rawSales")

# Create local instance of the rollup time-series - first method:
daily_rollup_TS = session.time_series_for("sales/1", "rawSales@DailyRollupForOneYear")

# Create local instance of the rollup time-series - second method:
# using the rollup policy itself and the raw time-series' name
rollup_time_series_2 = session.time_series_for("sales/1", daily_rollup.get_time_series_name("rawSales"))

# Retrieve all the data from both time-series
raw_data = raw_ts.get(datetime.min, datetime.max)
rollup_data = daily_rollup_TS.get(datetime.min, datetime.max)
`}
</CodeBlock>
</TabItem>



## Syntax

### The time series policies

* `raw_policy`  
  * Used to define the retention time of the raw time series. 
  * Only one such policy per collection can be defined.
  * Does not perform aggregation.

* Rollup policy:  
  * Used to define the aggregation time frame and retention time for the rollup time series.
  * Multiple policies can be defined per collection.

<TabItem value="python" label="python">
<CodeBlock language="python">
{`class RawTimeSeriesPolicy(TimeSeriesPolicy):    
    def __init__(self, retention_time: TimeValue = TimeValue.MAX_VALUE()):
        ...

class TimeSeriesPolicy:
    def __init__(
        self,
        name: Optional[str] = None,
        aggregation_time: Optional[TimeValue] = None,
        retention_time: TimeValue = TimeValue.MAX_VALUE(),
    ):
        ...
`}
</CodeBlock>
</TabItem>

| Property             | Type | Description |
|----------------------|------|-------------|
| **name** (Optional)  | `str` | This string is used to create the name of the rollup time series.
`name` is added to the raw time series name - with `@` as a separator,<br/>e.g.: `<name of raw time series>@<name of time series policy>` |
| **retention_time** | `TimeValue` | Time series entries older than this time value (see `TimeValue` below) are automatically deleted. |
| **aggregation_time** (Optional) | `TimeValue` |The time series data being rolled up is divided into parts of this length of time, rounded to nearest time units. Each part is aggregated into an entry of the rollup time series. |

<TabItem value="python" label="python">
<CodeBlock language="python">
{`class TimeValue:
    def __init__(self, value: int, unit: TimeValueUnit):
        self.value = value
        self.unit = unit

   @classmethod
   def of_seconds(cls, seconds: int) -> TimeValue:
       return cls(seconds, TimeValueUnit.SECOND)

   @classmethod
   def of_minutes(cls, minutes: int) -> TimeValue:
       return cls(minutes * 60, TimeValueUnit.SECOND)

   @classmethod
   def of_hours(cls, hours: int) -> TimeValue:
       return cls(hours * 3600, TimeValueUnit.SECOND)

   @classmethod
   def of_days(cls, days: int) -> TimeValue:
       return cls(days * cls.SECONDS_PER_DAY, TimeValueUnit.SECOND)

   @classmethod
   def of_months(cls, months: int) -> TimeValue:
       return cls(months, TimeValueUnit.MONTH)

   @classmethod
   def of_years(cls, years: int) -> TimeValue:
       return cls(12 * years, TimeValueUnit.MONTH)
`}
</CodeBlock>
</TabItem>

Each of the above `TimeValue` methods returns a `TimeValue` object representing a whole number of the specified time units. 
These methods are used to define the aggregation and retention spans om time series policies.  
### The time series configuration object

<TabItem value="python" label="python">
<CodeBlock language="python">
{`class TimeSeriesConfiguration:
    def __init__(self):
        self.collections: Dict[str, TimeSeriesCollectionConfiguration] = \{\}
        self.policy_check_frequency: Optional[datetime.timedelta] = None
        self.named_values: Optional[Dict[str, Dict[str, List[str]]]] = None

class TimeSeriesCollectionConfiguration:
    def __init__(
        self,
        disabled: Optional[bool] = False,
        policies: Optional[List[TimeSeriesPolicy]] = None,
        raw_policy: Optional[RawTimeSeriesPolicy] = RawTimeSeriesPolicy.DEFAULT_POLICY(),
    ):
        self.disabled = disabled
        self.policies = policies
        self.raw_policy = raw_policy
`}
</CodeBlock>
</TabItem>

| Property        | Type | Description |
|-----------------|------|-------------|
| **collections** | `Dict[str, TimeSeriesCollectionConfiguration]` | Populate this `Dictionary` with the collection names and their corresponding `TimeSeriesCollectionConfiguration` objects. |
| **disabled** (Optional) | `bool` | If set to `true`, rollup processes will stop, and time series data will not be deleted by retention policies. |
| **policies** (Optional) | `List[TimeSeriesPolicy]` | Populate this `List` with your rollup policies. |
| **raw_policy** (Optional) | `RawTimeSeriesPolicy` | The `RawTimeSeriesPolicy`, the retention policy for the raw time series. |
### The time series configuration operation

<TabItem value="python" label="python">
<CodeBlock language="python">
{`class ConfigureTimeSeriesOperation(MaintenanceOperation[ConfigureTimeSeriesOperationResult])
`}
</CodeBlock>
</TabItem>

Learn more about operations in: [What are operations](../../client-api/operations/what-are-operations.mdx).  
### Time series entries

Time series entries are of one of the following classes:  

<TabItem value="python" label="python">
<CodeBlock language="python">
{`class TimeSeriesEntry:
  def __init__(
   self, timestamp: datetime.datetime = None, tag: str = None, values: List[int] = None, rollup: bool = None
  ):
   self.timestamp = timestamp
   self.tag = tag
   self.values = values
   self.rollup = rollup

class TypedTimeSeriesEntry(Generic[_T_TSBindable]):
  def __init__(
   self,
   timestamp: datetime.datetime = None,
   tag: str = None,
   values: List[int] = None,
   is_rollup: bool = None,
   value: _T_TSBindable = None,
  ):
   self.timestamp = timestamp
   self.tag = tag
   self.values = values
   self.is_rollup = is_rollup
   self.value = value


class TypedTimeSeriesRollupEntry(Generic[_T_Values]):
  def __init__(self, object_type: Type[_T_Values], timestamp: datetime.datetime):
   self._object_type = object_type
   self.tag: Optional[str] = None
   self.rollup = True
   self.timestamp = timestamp

   self._first: Optional[_T_Values] = None
   self._last: Optional[_T_Values] = None
   self._max: Optional[_T_Values] = None
   self._min: Optional[_T_Values] = None
   self._sum: Optional[_T_Values] = None
   self._count: Optional[_T_Values] = None
   self._average: Optional[_T_Values] = None
`}
</CodeBlock>
</TabItem>




</LanguageContent>
<LanguageContent language="php">

<Admonition type="note" title="Note">

Many time series applications produce massive amounts of data at a steady rate.  
**Time Series Policies** help you manage your data in two ways:  

* Creating **Rollups**:  
  Summarizing time series data by aggregating it into the form of a new, lower-resolution time series.

* Limiting **Retention**:  
  Controlling the duration for which time series data is kept before deletion.
 
* In this page:  
  * [Time series policies](../../document-extensions/timeseries/rollup-and-retention.mdx#time-series-policies)  
  * [Examples](../../document-extensions/timeseries/rollup-and-retention.mdx#examples)  
      * [Create time series policy](../../document-extensions/timeseries/rollup-and-retention.mdx#create-time-series-policies)  
      * [Retrieve rollup data](../../document-extensions/timeseries/rollup-and-retention.mdx#retrieve-rollup-data)
  * [Syntax](../../document-extensions/timeseries/rollup-and-retention.mdx#syntax)

</Admonition>
## Time series policies

#### What are rollups?

A rollup is a time series that summarizes the data from another time series, 
with each rollup entry representing a specific time frame in the original time series.  
Each rollup entry contains 6 values that aggregate the data from all the entries in the original time frame:  

* `First` - the value of the first entry in the frame.  
* `Last` - the value of the last entry.  
* `Min` - the smallest value.  
* `Max` - the largest value.  
* `Sum` - the sum of all the values in the frame.  
* `Count` - the total number of entries in the frame.  

This results in a much more compact time series that still contains useful information about the original time series (also called "raw" time series).

#### Rollup policies:

Rollup time series are created automatically according to rollup policies that can be defined from Studio or client code.  

* A rollup policy applies to all time series of every document in the given collection. 

* Each collection can be configured to have multiple policies which are applied sequentially:
  * The raw time series is first rolled up using the policy with the shortest aggregation frame.
  * Subsequently, the resulting rollup time series is further aggregated using the policy with the next shortest aggregation frame,  
    and so on.

[Querying with group-by](../../document-extensions/timeseries/querying/aggregation-and-projections.mdx#examples) 
will transparently traverse over the rollups to retrieve the relevant results.  

Let's look at an example of rollup data:  

!["Rollup time series entries"](./assets/rollup-1.png)

**1) Name:**  
The name of a rollup time series has this format: `<name of raw time series>@<name of time series policy>`  
It is a combination of the name of the raw time series and the name of the time series policy separated by `@`.  
In the image above these are "HeartRates" and "byHour" respectively.  
For this reason, neither a time series name nor a policy name can have the character `@` in it.

**2) Timestamp:**  
The aggregation frame always begins at a round number of one of these time units: a second, minute, hour, day, week, month, or year. 
So the frame includes all entries starting at a round number of time units, and ending at a round number *minus one millisecond* 
(since milliseconds are the minimal resolution in RavenDB time series). 
The timestamp for a rollup entry is the beginning of the frame it represents.  

For example, if the aggregation frame is three days, a frame will start and end at a time stamps like:  
`2020-01-01 00:00:00` - `2020-01-03 23:59:59.999`.

**3) Values:**  
Each group of six values represents one value from the original entries. 
If the raw time series has `n` values per entry, the rollup time series will have `6 * n` per entry: 
the first six summarize the first raw value, the next six summarize the next raw value, and so on. 
The aggregated values have the names: `"First (<name of raw value>)", "Last (<name of raw value>)", ...` respectively.  

Because time series entries are limited to 32 values, rollups are limited to the first five values of an original time series entry, or 30 aggregate values.  



## Examples

#### Create time series policies:

<TabItem value="rollup_and_retention_0" label="rollup_and_retention_0">
<CodeBlock language="php">
{`$oneWeek = TimeValue::ofDays(7);
$fiveYears = TimeValue::ofYears(5);

// Define a policy on the RAW time series data:
// ============================================
$rawPolicy = new RawTimeSeriesPolicy($fiveYears); // Retain entries for five years

// Define a ROLLUP policy:
// =======================
$rollupPolicy = new TimeSeriesPolicy(
        "By1WeekFor1Year", // Name of policy
        $oneWeek, // Aggregation time, roll-up the data for each week
        $fiveYears); // Retention time, keep data for five years

// Define the time series configuration for collection "Companies" (use above policies):
// =====================================================================================
$companyConfig = new TimeSeriesCollectionConfiguration();
$companyConfig->setPolicies(TimeSeriesPolicyArray::fromArray([ $rollupPolicy ]));
$companyConfig->setRawPolicy($rawPolicy);

$timeSeriesConfig = new TimeSeriesConfiguration();
$timeSeriesConfig->setCollections([
    "Companies" => $companyConfig
]);

// Deploy the time series configuration to the server
// by sending the 'ConfigureTimeSeriesOperation' operation:
// ========================================================
$store->maintenance()->send(new ConfigureTimeSeriesOperation($timeSeriesConfig));

// NOTE:
// The time series entries in the RavenDB sample data are dated up to the year 2020.
// To ensure that you see the rollup time series created when running this example,
// the retention time should be set to exceed that year.
`}
</CodeBlock>
</TabItem>
#### Retrieve rollup data:

* Retrieving entries from a rollup time series is similar to getting the raw time series data.

* Learn more about using `timeSeriesFor.get` in [Get time series entries](../../document-extensions/timeseries/client-api/session/get/get-entries.mdx).

<TabItem value="rollup_and_retention_1" label="rollup_and_retention_1">
<CodeBlock language="php">
{`// Get all data from the RAW time series:
// ======================================

$rawData = $session
    ->timeSeriesFor("companies/91-A", "StockPrices")
    ->get();

// Get all data from the ROLLUP time series:
// =========================================

// Either - pass the rollup name explicitly to 'TimeSeriesFor':
$rollupData = $session
    ->timeSeriesFor("companies/91-A", "StockPrices@By1WeekFor1Year")
    ->get();

// Or - get the rollup name by calling 'GetTimeSeriesName':
$rollupData = $session
    ->timeSeriesFor("companies/91-A", $rollupPolicy->GetTimeSeriesName("StockPrices"))
    ->get();

// The raw time series has 100 entries
$this->assertCount(100, $rawData);
$this->assertFalse($rawData[0]->isRollup());

// The rollup time series has only 22 entries
// as each entry aggregates 1 week's data from the raw time series
$this->assertCount(22, $rollupData);
$this->assertTrue($rollupData[0]->isRollup());
`}
</CodeBlock>
</TabItem>



## Syntax

### The time series policies

* `rawPolicy`  
  * Used to define the retention time of the raw time series. 
  * Only one such policy per collection can be defined.
  * Does not perform aggregation.

* Rollup policy:  
  * Used to define the aggregation time frame and retention time for the rollup time series.
  * Multiple policies can be defined per collection.

<TabItem value="python" label="python">
<CodeBlock language="python">
{`class RawTimeSeriesPolicy(TimeSeriesPolicy):    
    def __init__(self, retention_time: TimeValue = TimeValue.MAX_VALUE()):
        ...

class TimeSeriesPolicy:
    def __init__(
        self,
        name: Optional[str] = None,
        aggregation_time: Optional[TimeValue] = None,
        retention_time: TimeValue = TimeValue.MAX_VALUE(),
    ):
        ...
`}
</CodeBlock>
</TabItem>

| Property             | Type | Description |
|----------------------|------|-------------|
| **name** (Optional)  | `str` | This string is used to create the name of the rollup time series.
`name` is added to the raw time series name - with `@` as a separator,<br/>e.g.: `<name of raw time series>@<name of time series policy>` |
| **retention_time** | `TimeValue` | Time series entries older than this time value (see `TimeValue` below) are automatically deleted. |
| **aggregation_time** (Optional) | `TimeValue` |The time series data being rolled up is divided into parts of this length of time, rounded to nearest time units. Each part is aggregated into an entry of the rollup time series. |

<TabItem value="python" label="python">
<CodeBlock language="python">
{`class TimeValue:
    def __init__(self, value: int, unit: TimeValueUnit):
        self.value = value
        self.unit = unit

   @classmethod
   def of_seconds(cls, seconds: int) -> TimeValue:
       return cls(seconds, TimeValueUnit.SECOND)

   @classmethod
   def of_minutes(cls, minutes: int) -> TimeValue:
       return cls(minutes * 60, TimeValueUnit.SECOND)

   @classmethod
   def of_hours(cls, hours: int) -> TimeValue:
       return cls(hours * 3600, TimeValueUnit.SECOND)

   @classmethod
   def of_days(cls, days: int) -> TimeValue:
       return cls(days * cls.SECONDS_PER_DAY, TimeValueUnit.SECOND)

   @classmethod
   def of_months(cls, months: int) -> TimeValue:
       return cls(months, TimeValueUnit.MONTH)

   @classmethod
   def of_years(cls, years: int) -> TimeValue:
       return cls(12 * years, TimeValueUnit.MONTH)
`}
</CodeBlock>
</TabItem>

Each of the above `TimeValue` methods returns a `TimeValue` object representing a whole number of the specified time units. 
These methods are used to define the aggregation and retention spans om time series policies.  
### The time series configuration object

<TabItem value="python" label="python">
<CodeBlock language="python">
{`class TimeSeriesConfiguration:
    def __init__(self):
        self.collections: Dict[str, TimeSeriesCollectionConfiguration] = \{\}
        self.policy_check_frequency: Optional[datetime.timedelta] = None
        self.named_values: Optional[Dict[str, Dict[str, List[str]]]] = None

class TimeSeriesCollectionConfiguration:
    def __init__(
        self,
        disabled: Optional[bool] = False,
        policies: Optional[List[TimeSeriesPolicy]] = None,
        raw_policy: Optional[RawTimeSeriesPolicy] = RawTimeSeriesPolicy.DEFAULT_POLICY(),
    ):
        self.disabled = disabled
        self.policies = policies
        self.raw_policy = raw_policy
`}
</CodeBlock>
</TabItem>

| Property        | Type | Description |
|-----------------|------|-------------|
| **collections** | `Dict[str, TimeSeriesCollectionConfiguration]` | Populate this `Dictionary` with the collection names and their corresponding `TimeSeriesCollectionConfiguration` objects. |
| **disabled** (Optional) | `bool` | If set to `true`, rollup processes will stop, and time series data will not be deleted by retention policies. |
| **policies** (Optional) | `List[TimeSeriesPolicy]` | Populate this `List` with your rollup policies. |
| **raw_policy** (Optional) | `RawTimeSeriesPolicy` | The `RawTimeSeriesPolicy`, the retention policy for the raw time series. |
### The time series configuration operation

<TabItem value="python" label="python">
<CodeBlock language="python">
{`class ConfigureTimeSeriesOperation(MaintenanceOperation[ConfigureTimeSeriesOperationResult])
`}
</CodeBlock>
</TabItem>

Learn more about operations in: [What are operations](../../client-api/operations/what-are-operations.mdx).  
### Time series entries

Time series entries are of one of the following classes:  

<TabItem value="python" label="python">
<CodeBlock language="python">
{`class TimeSeriesEntry:
  def __init__(
   self, timestamp: datetime.datetime = None, tag: str = None, values: List[int] = None, rollup: bool = None
  ):
   self.timestamp = timestamp
   self.tag = tag
   self.values = values
   self.rollup = rollup

class TypedTimeSeriesEntry(Generic[_T_TSBindable]):
  def __init__(
   self,
   timestamp: datetime.datetime = None,
   tag: str = None,
   values: List[int] = None,
   is_rollup: bool = None,
   value: _T_TSBindable = None,
  ):
   self.timestamp = timestamp
   self.tag = tag
   self.values = values
   self.is_rollup = is_rollup
   self.value = value


class TypedTimeSeriesRollupEntry(Generic[_T_Values]):
  def __init__(self, object_type: Type[_T_Values], timestamp: datetime.datetime):
   self._object_type = object_type
   self.tag: Optional[str] = None
   self.rollup = True
   self.timestamp = timestamp

   self._first: Optional[_T_Values] = None
   self._last: Optional[_T_Values] = None
   self._max: Optional[_T_Values] = None
   self._min: Optional[_T_Values] = None
   self._sum: Optional[_T_Values] = None
   self._count: Optional[_T_Values] = None
   self._average: Optional[_T_Values] = None
`}
</CodeBlock>
</TabItem>




</LanguageContent>
<LanguageContent language="nodejs">

<Admonition type="note" title="Note">

Many time series applications produce massive amounts of data at a steady rate.  
**Time Series Policies** help you manage your data in two ways:  

* Creating **Rollups**:  
  Summarizing time series data by aggregating it into the form of a new, lower-resolution time series.

* Limiting **Retention**:  
  Controlling the duration for which time series data is kept before deletion.
 
* In this page:  
  * [Time series policies](../../document-extensions/timeseries/rollup-and-retention.mdx#time-series-policies)  
  * [Examples](../../document-extensions/timeseries/rollup-and-retention.mdx#examples)  
      * [Create time series policy](../../document-extensions/timeseries/rollup-and-retention.mdx#create-time-series-policies)  
      * [Retrieve rollup data](../../document-extensions/timeseries/rollup-and-retention.mdx#retrieve-rollup-data)
  * [Syntax](../../document-extensions/timeseries/rollup-and-retention.mdx#syntax)

</Admonition>
## Time series policies

#### What are rollups?

A rollup is a time series that summarizes the data from another time series, 
with each rollup entry representing a specific time frame in the original time series.  
Each rollup entry contains 6 values that aggregate the data from all the entries in the original time frame:  

* *First* - the value of the first entry in the frame.  
* *Last* - the value of the last entry.  
* *Min* - the smallest value.  
* *Max* - the largest value.  
* *Sum* - the sum of all the values in the frame.  
* *Count* - the total number of entries in the frame.  

This results in a much more compact time series that still contains useful information about the original time series (also called "raw" time series).

#### Rollup policies:

Rollup time series are created automatically according to rollup policies that can be defined from the tudio or client code.  

* A rollup policy applies to all time series of every document in the given collection. 

* Each collection can be configured to have multiple policies which are applied sequentially:
  * The raw time series is first rolled up using the policy with the shortest aggregation frame.
  * Subsequently, the resulting rollup time series is further aggregated using the policy with the next shortest aggregation frame,  
    and so on.

[Querying with group-by](../../document-extensions/timeseries/querying/aggregation-and-projections.mdx) 
will transparently traverse over the rollups to retrieve the relevant results.  

Let's look at an example of rollup data:  

!["Rollup time series entries"](./assets/rollup-1.png)

**1) Name:**  
The name of a rollup time series has this format: `<name of raw time series>@<name of time series policy>`  
It is a combination of the name of the raw time series and the name of the time series policy separated by `@`.  
In the image above these are "HeartRates" and "byHour" respectively.  
For this reason, neither a time series name nor a policy name can have the character `@` in it.

**2) Timestamp:**  
The aggregation frame always begins at a round number of one of these time units: a second, minute, hour, day, week, month, or year. 
So the frame includes all entries starting at a round number of time units, and ending at a round number *minus one millisecond* 
(since milliseconds are the minimal resolution in RavenDB time series). 
The timestamp for a rollup entry is the beginning of the frame it represents.  

For example, if the aggregation frame is three days, a frame will start and end at a time stamps like:  
`2020-01-01 00:00:00` - `2020-01-03 23:59:59.999`.

**3) Values:**  
Each group of six values represents one value from the original entries. 
If the raw time series has `n` values per entry, the rollup time series will have `6 * n` per entry: 
the first six summarize the first raw value, the next six summarize the next raw value, and so on. 
The aggregated values have the names: `"First (<name of raw value>)", "Last (<name of raw value>)", ...` respectively.  

Because time series entries are limited to 32 values, rollups are limited to the first five values of an original time series entry, or 30 aggregate values.  



## Examples

#### Create time series policies:

<TabItem value="rollup_1" label="rollup_1">
<CodeBlock language="js">
{`// Define a policy on the RAW time series data:
// ============================================
const rawPolicy = new RawTimeSeriesPolicy(TimeValue.ofYears(5)); // Retain data for five years

// Define a ROLLUP policy: 
// =======================
const rollupPolicy = new TimeSeriesPolicy(
    "By1WeekFor1Year",      // Name of policy
    TimeValue.ofDays(7),    // Aggregation time, roll-up the data for each week
    TimeValue.ofYears(5));  // Retention time, keep data for five years

// Define the time series configuration for collection "Companies" (use above policies):
// =====================================================================================
const collectionConfig = new TimeSeriesCollectionConfiguration();        
collectionConfig.rawPolicy = rawPolicy;
collectionConfig.policies = [rollupPolicy];

const timeSeriesConfig = new TimeSeriesConfiguration();
timeSeriesConfig.collections.set("Companies", collectionConfig);

// Deploy the time series configuration to the server
// by sending the 'ConfigureTimeSeriesOperation' operation:
// ========================================================
await documentStore.maintenance.send(new ConfigureTimeSeriesOperation(timeSeriesConfig));

// NOTE:
// The time series entries in the RavenDB sample data are dated up to the year 2020.
// To ensure that you see the rollup time series created when running this example,
// the retention time should be set to exceed that year.
`}
</CodeBlock>
</TabItem>
#### Retrieve rollup data:

* Retrieving entries from a rollup time series is similar to getting the raw time series data.

* Learn more about using `timeSeriesFor.get` in [Get time series entries](../../document-extensions/timeseries/client-api/session/get/get-entries.mdx).

<TabItem value="rollup_2" label="rollup_2">
<CodeBlock language="js">
{`// Get all data from the RAW time series:
// ======================================

const rawData = await session
    .timeSeriesFor("companies/91-A", "StockPrices")
    .get();

// Get all data from the ROLLUP time series:
// =========================================

// Either - pass the rollup name explicitly to 'TimeSeriesFor':
let rollupData = await session
    .timeSeriesFor("companies/91-A", "StockPrices@By1WeekFor1Year")
    .get();

// Or - get the rollup name by calling 'GetTimeSeriesName':
rollupData = await session
    .timeSeriesFor("companies/91-A", rollupPolicy.getTimeSeriesName("StockPrices"))
    .get();

// The raw time series has 100 entries
assert.equal(rawData.length, 100);
assert.equal(rawData[0].isRollup, false);

// The rollup time series has only 22 entries
// as each entry aggregates 1 week's data from the raw time series
assert.equal(rollupData.length, 22);
assert.equal(rollupData[0].isRollup, true);
`}
</CodeBlock>
</TabItem>



## Syntax
### The time series policies

* Raw policy:  
  * Used to define the retention time of the raw time series. 
  * Only one such policy per collection can be defined.
  * Does not perform aggregation.

* Rollup policy:  
  * Used to define the aggregation time frame and retention time for the rollup time series.
  * Multiple policies can be defined per collection.

<TabItem value="syntax_1" label="syntax_1">
<CodeBlock language="js">
{`class RawTimeSeriesPolicy extends TimeSeriesPolicy \{
    retentionTime;  // TimeValue
\}

class TimeSeriesPolicy \{
    name;           // string;
    retentionTime   // TimeValue
    aggregationTime // TimeValue
\}
`}
</CodeBlock>
</TabItem>

| Property             | Description                                                                                                                                                                                                    |
|----------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **name**             | This string is used to create the name of the rollup time series.
`Name` is added to the raw time series name - with `@` as a separator,<br/>e.g.: `<name of raw time series>@<name of time series policy>` |
| **retentionTime**    | Time series entries older than this `TimeValue` are automatically deleted.                                                                                                               |
| **aggregationTime** | The time series data being rolled up is divided into parts of this length of time, rounded to nearest time units. Each part is aggregated into an entry of the rollup time series.                             |

<TabItem value="syntax_2" label="syntax_2">
<CodeBlock language="js">
{`class TimeValue \{
    static ofSeconds(seconds);
    static ofMinutes(minutes);
    static ofHours(hours);
    static ofDays(days); 
    static ofMonths(months);
    static ofYears(years);
\}
`}
</CodeBlock>
</TabItem>

<Admonition type="info" title="Info">
The main reason we use `TimeValue` rather than something like `TimeSpan` is that `TimeSpan` doesn't have a notion of 'months' 
because a calendar month is not a standard unit of time (as it can range from 28 to 31 days).  
`TimeValue` enables you to define retention and aggregation spans specifically tailored to calendar months.
</Admonition>
### The time series configuration object

<TabItem value="syntax_3" label="syntax_3">
<CodeBlock language="js">
{`class TimeSeriesConfiguration \{
    collections; // Map<string, TimeSeriesCollectionConfiguration>
\}

class TimeSeriesCollectionConfiguration \{
    disabled;  // boolean
    policies;  // TimeSeriesPolicy[]
    rawPolicy; // RawTimeSeriesPolicy
\}
`}
</CodeBlock>
</TabItem>

| Property        | Description                                                                                                             |
|-----------------|-------------------------------------------------------------------------------------------------------------------------|
| **collections** | Populate this dictionary with the collection names and their corresponding `TimeSeriesCollectionConfiguration` objects. |
| **disabled**    | If set to `true`, rollup processes will stop, and time series data will not be deleted by retention policies.           |
| **policies**    | Populate this list with your rollup policies.                                                                          |
| **rawPolicy**   | The `RawTimeSeriesPolicy`, the retention policy for the raw time series.                                                |
### The time series configuration operation

<TabItem value="syntax_4" label="syntax_4">
<CodeBlock language="js">
{`ConfigureTimeSeriesOperation(configuration);
`}
</CodeBlock>
</TabItem>

| Parameter         | Description                                                  |
|-------------------|--------------------------------------------------------------|
| **configuration** | The `TimeSeriesConfiguration` object to deploy to the server |

Learn more about operations in: [What are operations](../../client-api/operations/what-are-operations.mdx).  




</LanguageContent>

<!---
### Studio
- [Time Series Interface in Studio](../../studio/database/document-extensions/time-series)

### Time Series
- [Time Series Overview](../../document-extensions/timeseries/overview)
- [API Overview](../../document-extensions/timeseries/client-api/overview)

### Client-API
- [What Are Operations?](../../client-api/operations/what-are-operations)


-->