import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

<Admonition type="note" title="">

* Patching multiple time series entries (append or delete entries) can be performed via the _Session_  
  using [session.Advanced.Defer](../../../../client-api/operations/patching/single-document.mdx#session-api-using-defer), as described below.
  * You can handle a single document at a time.
  * The patching action is defined by the provided [JavaScript](../../../../document-extensions/timeseries/client-api/javascript-support.mdx).
  
* Patching time series entries can also be done directly on the _Store_ via [Operations](../../../../client-api/operations/what-are-operations.mdx),  
  where multiple documents can be handled at a time. Learn more in [Patching time series operations](../../../../document-extensions/timeseries/client-api/operations/patch.mdx).

* In this page:
   * [Usage](../../../../document-extensions/timeseries/client-api/session/patch.mdx#usage)  
   * [Patching examples](../../../../document-extensions/timeseries/client-api/session/patch.mdx#patching-examples)
     * [Append multiple entries](../../../../document-extensions/timeseries/client-api/session/patch.mdx#append-multiple-entries) 
     * [Delete multiple entries](../../../../document-extensions/timeseries/client-api/session/patch.mdx#delete-multiple-entries) 
   * [Syntax](../../../../document-extensions/timeseries/client-api/session/patch.mdx#syntax)

</Admonition>
## Usage

* Open a session
* Construct a `PatchCommandData` instance and pass it the following:
    * The document ID that contains the time series
    * The document change vector (or `null`)
    * A `PatchRequest` instance with a JavaScript that appends or removes time series entries
* Call `session.Advanced.Defer` and pass it the `PatchCommandData` command.  
  Note that you can call _Defer_ multiple times prior to calling _SaveChanges_.
* Call `session.SaveChanges()`.  
  All patch requests added via _Defer_ will be sent to the server for execution when _SaveChanges_ is called.



## Patching examples

#### Append multiple entries:

In this example, we append 100 time series entries with random heart rate values to a document.  

<TabItem value="TS_region-Session_Patch-Append-100-Random-TS-Entries" label="TS_region-Session_Patch-Append-100-Random-TS-Entries">
<CodeBlock language="csharp">
{`var baseline = DateTime.Today;

// Create arrays of timestamps and random values to patch
List<double> values = new List<double>();
List<DateTime> timeStamps = new List<DateTime>();

for (var i = 0; i < 100; i++)
\{
    values.Add(68 + Math.Round(19 * new Random().NextDouble()));
    timeStamps.Add(baseline.AddSeconds(i));
\}

session.Advanced.Defer(new PatchCommandData("users/1-A", null,
    new PatchRequest
    \{
        Script = @"
            var i = 0;
            for(i = 0; i < $values.length; i++)
            \{
                timeseries(id(this), $timeseries)
                .append (
                  new Date($timeStamps[i]), 
                  $values[i], 
                  $tag);
            \}",

        Values =
        \{
            \{ "timeseries", "HeartRates" \},
            \{ "timeStamps", timeStamps\},
            \{ "values", values \},
            \{ "tag", "watches/fitbit" \}
        \}
    \}, null));

session.SaveChanges();
`}
</CodeBlock>
</TabItem>
#### Delete multiple entries:

In this example, we remove a range of 50 time series entries from a document.  

<TabItem value="TS_region-Session_Patch-Delete-50-TS-Entries" label="TS_region-Session_Patch-Delete-50-TS-Entries">
<CodeBlock language="csharp">
{`// Delete time-series entries
session.Advanced.Defer(new PatchCommandData("users/1-A", null,
    new PatchRequest
    \{
        Script = @"timeseries(this, $timeseries)
                 .delete(
                    $from, 
                    $to
                  );",
        Values =
        \{
            \{ "timeseries", "HeartRates" \},
            \{ "from", baseline.AddSeconds(0) \},
            \{ "to", baseline.AddSeconds(49) \}
        \}
    \}, null));

session.SaveChanges();
`}
</CodeBlock>
</TabItem>



## Syntax

**`PatchCommandData`**

<TabItem value="PatchCommandData-definition" label="PatchCommandData-definition">
<CodeBlock language="csharp">
{`public PatchCommandData(string id, string changeVector,
    PatchRequest patch, PatchRequest patchIfMissing)
`}
</CodeBlock>
</TabItem>

Learn more about `PatchCommandData` [here](../../../../client-api/operations/patching/single-document.mdx#session-api-using-defer).
**`PatchRequest`**

<TabItem value="PatchRequest-definition" label="PatchRequest-definition">
<CodeBlock language="csharp">
{`public class PatchRequest
\{
    // The patching script     
    public string Script \{ get; set; \}
    
    // Values for the parameters used by the patching script
    public Dictionary<string, object> Values \{ get; set; \}
\}
`}
</CodeBlock>
</TabItem>

Learn more about `PatchRequest` [here](../../../../client-api/operations/patching/single-document.mdx#session-api-using-defer).




