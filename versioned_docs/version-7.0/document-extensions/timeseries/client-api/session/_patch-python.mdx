import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

<Admonition type="note" title="">

* Patching multiple time series entries (append or delete entries) can be performed via the _Session_  
  using [session.advanced.defer](../../../../client-api/operations/patching/single-document.mdx#session-api-using-defer), as described below.
  * You can handle a single document at a time.
  * The patching action is defined by the provided [JavaScript](../../../../document-extensions/timeseries/client-api/javascript-support.mdx).
  
* Patching time series entries can also be done directly on the _Store_ via [Operations](../../../../client-api/operations/what-are-operations.mdx),  
  where multiple documents can be handled at a time. Learn more in [Patching time series operations](../../../../document-extensions/timeseries/client-api/operations/patch.mdx).

* In this page:
   * [Usage](../../../../document-extensions/timeseries/client-api/session/patch.mdx#usage)  
   * [Patching examples](../../../../document-extensions/timeseries/client-api/session/patch.mdx#patching-examples)
     * [Append multiple entries](../../../../document-extensions/timeseries/client-api/session/patch.mdx#append-multiple-entries) 
     * [Delete multiple entries](../../../../document-extensions/timeseries/client-api/session/patch.mdx#delete-multiple-entries) 
   * [Syntax](../../../../document-extensions/timeseries/client-api/session/patch.mdx#syntax)

</Admonition>
## Usage

* Open a session
* Construct a `PatchCommandData` instance and pass it the following:
    * The document ID that contains the time series
    * The document change vector (or `None`)
    * A `PatchRequest` instance with a JavaScript that appends or removes time series entries
* Call `session.advanced.defer` and pass it the `PatchCommandData` command.  
  Note that you can call _Defer_ multiple times prior to calling _SaveChanges_.
* Call `session.save_changes`.  
  All patch requests added via _Defer_ will be sent to the server for execution when _SaveChanges_ is called.



## Patching examples

#### Append multiple entries:

In this example, we append 100 time series entries with random heart rate values to a document.  

<TabItem value="TS_region-Session_Patch-Append-100-Random-TS-Entries" label="TS_region-Session_Patch-Append-100-Random-TS-Entries">
<CodeBlock language="python">
{`base_line = datetime.utcnow()

# Create arrays of timestamps and random values to patch
values = []
time_stamps = []

for i in range(100):
    values.append(68 + round(19 * random.uniform(0.0, 1.0)))
    time_stamps.append(base_line + timedelta(seconds=i))

session.advanced.defer(
    PatchCommandData(
        "users/1-A",
        None,
        PatchRequest(
            script=(
                "var i = 0;"
                "for(i = 0; i < $values.length; i++)"
                "\{"
                "    timeseries(id(this), $timeseries)"
                "    .append ("
                "      new Date($time_stamps[i]),"
                "      $values[i],"
                "      $tag);"
                "\}"
            ),
            values=\{
                "timeseries": "HeartRates",
                "time_stamps": time_stamps,
                "values": values,
                "tag": "watches/fitbit",
            \},
        ),
        None,
    )
)

session.save_changes()
`}
</CodeBlock>
</TabItem>
#### Delete multiple entries:

In this example, we remove a range of 50 time series entries from a document.  

<TabItem value="TS_region-Session_Patch-Delete-50-TS-Entries" label="TS_region-Session_Patch-Delete-50-TS-Entries">
<CodeBlock language="python">
{`# Delete time-series entries
session.advanced.defer(
    PatchCommandData(
        "users/1-A",
        None,
        PatchRequest(
            script=("timeseries(this, $timeseries)" ".delete(" "  $from," "  $to" ");"),
            values=\{
                "timeseries": "HeartRates",
                "from": base_line,
                "to": base_line + timedelta(seconds=49),
            \},
        ),
        None,
    )
)
`}
</CodeBlock>
</TabItem>



## Syntax

**`PatchCommandData`**

<TabItem value="PatchCommandData-definition" label="PatchCommandData-definition">
<CodeBlock language="python">
{`class PatchCommandData(CommandData):
    def __init__(
        self,
        key: str,
        change_vector: Union[None, str],
        patch: PatchRequest,
        patch_if_missing: Optional[PatchRequest] = None,
    ): ...
`}
</CodeBlock>
</TabItem>

Learn more about `PatchCommandData` [here](../../../../client-api/operations/patching/single-document.mdx#session-api-using-defer).
**`PatchRequest`**

<TabItem value="PatchRequest-definition" label="PatchRequest-definition">
<CodeBlock language="python">
{`class PatchRequest:
    def __init__(self, script: Optional[str] = "", values: Optional[Dict[str, object]] = None): ...
`}
</CodeBlock>
</TabItem>

Learn more about `PatchRequest` [here](../../../../client-api/operations/patching/single-document.mdx#session-api-using-defer).




