import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

<Admonition type="note" title="">

* By default, optimistic concurrency checks are **disabled**. Changes made outside of the session object will be overwritten. 
  Concurrent changes to the same document will use the _Last Write Wins_ strategy so a lost update anomaly is possible 
  with the default configuration of the [session](../../../client-api/session/what-is-a-session-and-how-does-it-work.mdx).

* Optimistic concurrency can be **enabled** for:
   * A specific document  
   * A specific session (enable on a per-session basis)  
   * All sessions (enable globally, at the document store level)  

* With optimistic concurrency enabled, RavenDB will generate a concurrency exception (and abort all modifications in 
  the current transaction) when trying to save a document that has been modified on the server side after the client 
  loaded and modified it.

* The `ConcurrencyException` that might be thrown upon the `saveChanges` call needs to be handled by the caller. 
  The operation can be retried (the document needs to be reloaded since it got changed meanwhile) or handle the error 
  in a way that is suitable in a given scenario.

* In this page:
  * [Enable for specific session](../../../client-api/session/configuration/how-to-enable-optimistic-concurrency.mdx#enable-for-specific-session)
  * [Enable globally](../../../client-api/session/configuration/how-to-enable-optimistic-concurrency.mdx#enable-globally)
  * [Disable for specific document (when enabled on session)](../../../client-api/session/configuration/how-to-enable-optimistic-concurrency.mdx#disable-for-specific-document-(when-enabled-on-session))
  * [Enable for specific document (when disabled on session)](../../../client-api/session/configuration/how-to-enable-optimistic-concurrency.mdx#enable-for-specific-document-(when-disabled-on-session)) 

<Admonition type="warning" title="">

* Note that the `useOptimisticConcurrency` setting only applies to documents that have been modified by the current session. 
  E.g., if you load documents `users/1-A` and `users/2-A` in a session, make modifications only to `users/1-A`, and then call `saveChanges`, 
  the operation will succeed regardless of the optimistic concurrency setting, even if `users/2-A` has been changed by another process in the meantime.

* However, if you modify both documents and attempt to save changes with optimistic concurrency enabled, an exception will be raised 
  if `users/2-A` has been modified externally.  
  In this case, the updates to both `users/1-A` and `users/2-A` will be cancelled.

</Admonition>

<Admonition type="info" title="">

A detailed description of transactions and concurrency control in RavenDB is available here: 
[Transaction support in RavenDB](../../../client-api/faq/transaction-support.mdx)

</Admonition>

</Admonition>
## Enable for specific session

<TabItem value="optimistic_concurrency_1" label="optimistic_concurrency_1">
<CodeBlock language="js">
{`// Enable optimistic concurrency for this session
const session = store.openSession();
session.advanced.useOptimisticConcurrency = true;

const product = new Product();
product.name = "Some Name";

// Save a document in this session
await session.store(product, "products/999");
await session.saveChanges();

\{
    // Modify the document 'externally' by another session 
    const anotherSession = store.openSession();
    
    const otherProduct = await anotherSession.load("products/999");
    otherProduct.name = "Other Name";
    await anotherSession.saveChanges();
\}

// Trying to modify the document without reloading it first will throw
product.name = "Better Name";
await session.saveChanges(); // This will throw a ConcurrencyException
`}
</CodeBlock>
</TabItem>

<Admonition type="warning" title="">

* Enabling optimistic concurrency in a session will ensure that changes made to a document will only be persisted
  if the version of the document sent in the `saveChanges()` call matches its version from the time it was initially read (loaded from the server).

* Note that it's necessary to enable optimistic concurrency for ALL sessions that modify the documents for which you want to guarantee that no writes will be silently discarded.
  If optimistic concurrency is enabled in some sessions but not in others, and they modify the same documents, the risk of the lost update anomaly still exists.

</Admonition>



## Enable globally

* Optimistic concurrency can also be _enabled_ for all sessions that are opened under a document store.

* Use the [store.Conventions.UseOptimisticConcurrency](../../../client-api/configuration/conventions.mdx#useoptimisticconcurrency) convention to enable globally.

<TabItem value="optimistic_concurrency_2" label="optimistic_concurrency_2">
<CodeBlock language="js">
{`// Enable for all sessions that will be opened within this document store
store.conventions.useOptimisticConcurrency = true;

\{
    const session = store.openSession();
    const isSessionUsingOptimisticConcurrency
        = session.advanced.useOptimisticConcurrency; // true
\}
`}
</CodeBlock>
</TabItem>



## Disable for specific document (when enabled on session)

* Optimistic concurrency can be _disabled_ when **storing** a specific document,  
  even when it is _enabled_ for an entire session (or globally).

* This is done by passing `null` as a change vector value to the [store](../../../client-api/session/storing-entities.mdx) method.

<TabItem value="optimistic_concurrency_3" label="optimistic_concurrency_3">
<CodeBlock language="js">
{`\{        
    const session = store.openSession();
    
    const product = new Product();
    product.name = "Some Name";

    // Store document 'products/999'
    await session.store(product, "products/999");
    await session.saveChanges();
\}
\{
    const session = store.openSession();
    
    // Enable optimistic concurrency for the session
    session.advanced.useOptimisticConcurrency = true;

    const product = new Product();
    product.name = "Some Other Name";

    // Store the same document
    // Pass 'null' as the changeVector to turn OFF optimistic concurrency for this document
    await session.store(product, "products/999", \{ "changeVector": null \});

    // This will NOT throw a ConcurrencyException, and the document will be saved
    await session.saveChanges();
\}
`}
</CodeBlock>
</TabItem>



## Enable for specific document (when disabled on session)

* Optimistic concurrency can be _enabled_ when **storing** a specific document,  
  even when it is _disabled_ for an entire session (or globally).

* This is done by passing `string.Empty` as the change vector value to the [store](../../../client-api/session/storing-entities.mdx) method.  
  Setting the change vector to an empty string will cause RavenDB to ensure that this document is a new one and doesn't already exist.
  A `ConcurrencyException` will be thrown if the document already exists.

* If you do not provide a change vector or if the change vector is `null`, optimistic concurrency will be disabled.  

* Setting optimistic concurrency for a specific document overrides the `useOptimisticConcurrency` property from the `advanced` session operations.

<TabItem value="optimistic_concurrency_4" label="optimistic_concurrency_4">
<CodeBlock language="js">
{`\{
    const session = store.openSession();
    
    const product = new Product();
    product.name = "Some Name";

    // Store document 'products/999'
    await session.store(product, "products/999");
    await session.saveChanges();
\}
\{
    const session = store.openSession();
    
    // Disable optimistic concurrency for the session 
    session.advanced.useOptimisticConcurrency = false; // This is also the default value

    const product = new Product();
    product.name = "Some Other Name";

    // Store the same document
    // Pass an empty string as the changeVector to turn ON optimistic concurrency for this document
    await session.store(product, "products/999", \{ "changeVector": "" \});

    // This will throw a ConcurrencyException, and the document will NOT be saved
    await session.saveChanges();
\}
`}
</CodeBlock>
</TabItem>




