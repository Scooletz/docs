---
title: "Session: Querying: How to Perform a Faceted Search"
hide_table_of_contents: true
sidebar_label: Perform Faceted Search
sidebar_position: 8
---

import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';
import LanguageSwitcher from "@site/src/components/LanguageSwitcher";
import LanguageContent from "@site/src/components/LanguageContent";

export const supportedLanguages = ["csharp", "java"];


# Session: Querying: How to Perform a Faceted Search
<LanguageSwitcher supportedLanguages={supportedLanguages} />
<LanguageContent language="csharp">


To execute a facet query using the session `Query` method, use `ToFacets` extension. There is also a possibility to convert the query straight into the `FacetQuery` instance using the `ToFacetQuery` extension.

## Syntax

<TabItem value="facet_1" label="facet_1">
<CodeBlock language="csharp">
{`IAggregationQuery<T> AggregateBy<T>(FacetBase facet);

IAggregationQuery<T> AggregateBy<T>(IEnumerable<FacetBase> facets);

IAggregationQuery<T> AggregateBy<T>(Action<IFacetBuilder<T>> builder);

IAggregationQuery<T> AggregateUsing<T>(string facetSetupDocumentKey);
`}
</CodeBlock>
</TabItem>

| Parameters | | |
| ------------- | ------------- | ----- |
| **facets** | List&lt;[Facet](../../../glossary/facet.mdx)&gt; | List of facets required to perform a facet query (mutually exclusive with `facetSetupDoc`). |
| **facetSetupDoc** | string | Document key that contains predefined [FacetSetup](../../../glossary/facet-setup.mdx) (mutually exclusive with `facets`). |
| **start** | int | number of results that should be skipped. Default: `0`. |
| **pageSize** | int | maximum number of results that will be retrieved. Default: `null`. | 

| Return Value | |
| ------------- | ----- |
| [FacetResults](../../../glossary/facet-results.mdx) | Facet query results with query `Duration` and list of `Results`: One entry for each term/range as specified in [FacetSetup] document or passed in parameters. |

## Example I

<TabItem value="facet_2" label="facet_2">
<CodeBlock language="csharp">
{`_1
                    Dictionary<string, FacetResult> facets = session
                        .Query<Camera>("Camera/Costs")
                        .AggregateBy(new Facet
                        \{
                            FieldName = "Manufacturer",
                            Options = new FacetOptions
                            \{
                                TermSortMode = FacetTermSortMode.CountDesc
                            \}
                        \})
                        .AndAggregateBy(new RangeFacet<Camera>
                        \{
                            Ranges =
                            \{
                                camera => camera.Cost < 200m,
                                camera => camera.Cost >= 200m && camera.Cost < 400m,
                                camera => camera.Cost >= 400m && camera.Cost < 600m,
                                camera => camera.Cost >= 600m && camera.Cost < 800m,
                                camera => camera.Cost >= 800m
                            \},
                            Aggregations =
                            \{
                                \{
                                    FacetAggregation.Average,
                                    new HashSet<FacetAggregationField> \{ new FacetAggregationField \{ Name = "Cost" \} \}
                                \}
                            \}
                        \})
                        .AndAggregateBy(new RangeFacet<Camera>
                        \{
                            Ranges =
                            \{
                                camera => camera.Megapixels < 3.0,
                                camera => camera.Megapixels >= 3.0 && camera.Megapixels < 7.0,
                                camera => camera.Megapixels >= 7.0 && camera.Megapixels < 10.0,
                                camera => camera.Megapixels >= 10.0
                            \}
                        \})
                        .Execute();
`}
</CodeBlock>
</TabItem>

## Example II

<TabItem value="facet_3" label="facet_3">
<CodeBlock language="csharp">
{`_1
                    Dictionary<string, FacetResult> facets = session
                        .Query<Camera>("Camera/Costs")
                        .AggregateBy(builder => builder
                            .ByField(x => x.Manufacturer)
                            .WithOptions(new FacetOptions
                            \{
                                TermSortMode = FacetTermSortMode.CountDesc
                            \}))
                        .AndAggregateBy(builder => builder
                            .ByRanges(
                                camera => camera.Cost < 200m,
                                camera => camera.Cost >= 200m && camera.Cost < 400m,
                                camera => camera.Cost >= 400m && camera.Cost < 600m,
                                camera => camera.Cost >= 600m && camera.Cost < 800m,
                                camera => camera.Cost >= 800m)
                            .AverageOn(x => x.Cost))
                        .AndAggregateBy(builder => builder
                            .ByRanges(
                                camera => camera.Megapixels < 3.0,
                                camera => camera.Megapixels >= 3.0 && camera.Megapixels < 7.0,
                                camera => camera.Megapixels >= 7.0 && camera.Megapixels < 10.0,
                                camera => camera.Megapixels >= 10.0))
                        .Execute();
`}
</CodeBlock>
</TabItem>

## Converting Query into FacetQuery

<TabItem value="facet_4" label="facet_4">
<CodeBlock language="csharp">
{`_1
                    session.Store(new FacetSetup
                    \{
                        Facets = new List<Facet>
                            \{
                                new Facet
                                \{
                                    FieldName = "Manufacturer"
                                \}
                            \},
                        RangeFacets = new List<RangeFacet>
                            \{
                                new RangeFacet<Camera>
                                \{
                                    Ranges =
                                    \{
                                        camera => camera.Cost < 200m,
                                        camera => camera.Cost >= 200m && camera.Cost < 400m,
                                        camera => camera.Cost >= 400m && camera.Cost < 600m,
                                        camera => camera.Cost >= 600m && camera.Cost < 800m,
                                        camera => camera.Cost >= 800m
                                    \}
                                \},
                                new RangeFacet<Camera>
                                \{
                                    Ranges =
                                    \{
                                        camera => camera.Megapixels < 3.0,
                                        camera => camera.Megapixels >= 3.0 && camera.Megapixels < 7.0,
                                        camera => camera.Megapixels >= 7.0 && camera.Megapixels < 10.0,
                                        camera => camera.Megapixels >= 10.0
                                    \}
                                \}
                            \}
                    \}, "facets/CameraFacets");

                    session.SaveChanges();

                    Dictionary<string, FacetResult> facets = session
                        .Query<Camera>("Camera/Costs")
                        .AggregateUsing("facets/CameraFacets")
                        .Execute();
`}
</CodeBlock>
</TabItem>

| Parameters | | |
| ------------- | ------------- | ----- |
| **facets** | List&lt;[Facet](../../../glossary/facet.mdx)&gt; | List of facets required to perform a facet query (mutually exclusive with `facetSetupDoc`). |
| **facetSetupDoc** | string | Document key that contains predefined [FacetSetup](../../../glossary/facet-setup.mdx) (mutually exclusive with `facets`). |
| **start** | int | number of results that should be skipped. Default: `0`. |
| **pageSize** | int | maximum number of results that will be retrieved. Default: `null`. | 

| Return Value | |
| ------------- | ----- |
| [FacetQuery](../../../glossary/facet-query.mdx) | Instance of FacetQuery containing all options set in `Query`. Can be used with `MultiFacetedSearch` from `Advanced` session operations or with `Commands` directly. |

### Example

<TabItem value="facet_5" label="facet_5">
<CodeBlock language="csharp">
{`_1
                    Dictionary<string, FacetResult> facets = session
                        .Query<Camera>("Camera/Costs")
                        .AggregateBy(builder => builder
                            .ByField(x => x.Manufacturer)
                            .MinOn(x => x.Cost)
                            .MaxOn(x => x.Megapixels)
                            .MaxOn(x => x.Zoom))
                        .AndAggregateBy(builder => builder
                            .ByRanges(
                                camera => camera.Cost < 400m,
                                camera => camera.Cost >= 400m)
                            .AverageOn(x => x.Cost)
                            .MaxOn(x => x.Cost)
                            .MinOn(x => x.Cost))
                        .Execute();
`}
</CodeBlock>
</TabItem>


</LanguageContent>
<LanguageContent language="java">


To execute facet query using session `query` method use `toFacets` method.

## Syntax

<TabItem value="facet_1" label="facet_1">
<CodeBlock language="java">
{`IAggregationDocumentQuery<T> aggregateBy(Consumer<IFacetBuilder<T>> builder);

IAggregationDocumentQuery<T> aggregateBy(FacetBase facet);

IAggregationDocumentQuery<T> aggregateBy(Facet... facet);

IAggregationDocumentQuery<T> aggregateUsing(String facetSetupDocumentId);
`}
</CodeBlock>
</TabItem>

| Parameters | | |
| ------------- | ------------- | ----- |
| **facets** | List&lt;[Facet](../../../glossary/facet.mdx)&gt; | List of facets required to perform a facet query (mutually exclusive with `facetSetupDoc`). |
| **facetSetupDoc** | String | Document key that contains predefined [FacetSetup](../../../glossary/facet-setup.mdx) (mutually exclusive with `facets`). |
| **start** | int | number of results that should be skipped. Default: `0`. |
| **pageSize** | int | maximum number of results that will be retrieved. Default: `null`. | 

| Return Value | |
| ------------- | ----- |
| [FacetResults](../../../glossary/facet-results.mdx) | Facet query results with query `duration` and list of `results` - one entry for each term/range as specified in [FacetSetup] document or passed in parameters. |

## Example I

<TabItem value="facet_2" label="facet_2">
<CodeBlock language="java">
{`_1
                FacetOptions facetOptions = new FacetOptions();
                facetOptions.setTermSortMode(FacetTermSortMode.COUNT_DESC);

                Facet facet1 = new Facet();
                facet1.setFieldName("manufacturer");
                facet1.setOptions(facetOptions);

                RangeFacet facet2 = new RangeFacet();
                facet2.setRanges(Arrays.asList(
                    "cost < 200",
                    "cost between 200 and 400",
                    "cost between 400 and 600",
                    "cost between 600 and 800",
                    "cost >= 800"
                ));
                facet2.setAggregations(Collections.singletonMap(FacetAggregation.AVERAGE, "cost"));

                RangeFacet facet3 = new RangeFacet();
                facet3.setRanges(Arrays.asList(
                    "megapixels < 3",
                    "megapixels between 3 and 7",
                    "megapixels between 7 and 10",
                    "megapixels >= 10"
                ));

                Map<String, FacetResult> facets = session
                    .query(Camera.class, Query.index("Camera/Costs"))
                    .aggregateBy(facet1)
                    .andAggregateBy(facet2)
                    .andAggregateBy(facet3)
                    .execute();
`}
</CodeBlock>
</TabItem>

## Example II

<TabItem value="facet_3" label="facet_3">
<CodeBlock language="java">
{`_1
                FacetOptions options = new FacetOptions();
                options.setTermSortMode(FacetTermSortMode.COUNT_DESC);

                RangeBuilder<Integer> costBuilder = RangeBuilder.forPath("cost");
                RangeBuilder<Integer> megapixelsBuilder = RangeBuilder.forPath("megapixels");

                Map<String, FacetResult> facetResult = session
                    .query(Camera.class, Query.index("Camera/Costs"))
                    .aggregateBy(builder -> builder
                        .byField("manufacturer")
                        .withOptions(options))
                    .andAggregateBy(builder -> builder
                        .byRanges(
                            costBuilder.isLessThan(200),
                            costBuilder.isGreaterThanOrEqualTo(200).isLessThan(400),
                            costBuilder.isGreaterThanOrEqualTo(400).isLessThan(600),
                            costBuilder.isGreaterThanOrEqualTo(600).isLessThan(800),
                            costBuilder.isGreaterThanOrEqualTo(800))
                        .averageOn("cost"))
                    .andAggregateBy(builder -> builder
                        .byRanges(
                            megapixelsBuilder.isLessThan(3),
                            megapixelsBuilder.isGreaterThanOrEqualTo(3).isLessThan(7),
                            megapixelsBuilder.isGreaterThanOrEqualTo(7).isLessThan(10),
                            megapixelsBuilder.isGreaterThanOrEqualTo(10)
                        ))
                    .execute();
`}
</CodeBlock>
</TabItem>


## Converting Query into FacetQuery

<TabItem value="facet_4" label="facet_4">
<CodeBlock language="java">
{`_1
                FacetSetup facetSetup = new FacetSetup();

                Facet facetManufacturer = new Facet();
                facetManufacturer.setFieldName("manufacturer");
                facetSetup.setFacets(Arrays.asList(facetManufacturer));

                RangeFacet cameraFacet = new RangeFacet();
                cameraFacet.setRanges(Arrays.asList(
                    "cost < 200",
                    "cost between 200 and 400",
                    "cost between 400 and 600",
                    "cost between 600 and 800",
                    "cost >= 800"
                ));

                RangeFacet megapixelsFacet = new RangeFacet();
                megapixelsFacet.setRanges(Arrays.asList(
                    "megapixels < 3",
                    "megapixels between 3 and 7",
                    "megapixels between 7 and 10",
                    "megapixels >= 10"
                ));

                facetSetup.setRangeFacets(Arrays.asList(cameraFacet, megapixelsFacet));

                session.store(facetSetup, "facets/CameraFacets");
                session.saveChanges();

                Map<String, FacetResult> facets = session
                    .query(Camera.class, Query.index("Camera/Costs"))
                    .aggregateUsing("facets/CameraFacets")
                    .execute();
`}
</CodeBlock>
</TabItem>

| Parameters | | |
| ------------- | ------------- | ----- |
| **facets** | List&lt;[Facet](../../../glossary/facet.mdx)&gt; | List of facets required to perform a facet query (mutually exclusive with `facetSetupDoc`). |
| **facetSetupDoc** | String | Document key that contains predefined [FacetSetup](../../../glossary/facet-setup.mdx) (mutually exclusive with `facets`). |
| **start** | int | number of results that should be skipped. Default: `0`. |
| **pageSize** | int | maximum number of results that will be retrieved. Default: `null`. | 

| Return Value | |
| ------------- | ----- |
| [FacetQuery](../../../glossary/facet-query.mdx) | Instance of FacetQuery containing all options set in `query`. Can be used with `multiFacetedSearch` from `advanced` session operations or with `commands` directly. |

### Example

<TabItem value="facet_5" label="facet_5">
<CodeBlock language="java">
{`FacetQuery facetQuery1 = session.query(Camera.class)
  .toFacetQuery("facets/CameraFacets1");

FacetQuery facetQuery2 = session.query(Camera.class)
  .toFacetQuery("facets/CameraFacets2");

FacetResults[] results = session.advanced()
  .multiFacetedSearch(facetQuery1, facetQuery2);

FacetResults facetResults1 = results[0];
FacetResults facetResults2 = results[1];
`}
</CodeBlock>
</TabItem>



</LanguageContent>

<!---
- [Indexes : Querying : Faceted Search](../../../indexes/querying/faceted-search)

-->