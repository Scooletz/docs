import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

Another feature called `highlights` has been added to RavenDB to enhance the search UX.

## Usage

Lets consider a class and index as follows:   

<TabItem value="blog_post" label="blog_post">
<CodeBlock language="java">
{`@QueryEntity
public class BlogPost \{

  private String id;
  private String title;
  private String category;
  private String content;
  private Date publishedAt;
  private String[] tags;
  private List<BlogComment> comments;

  public String getId() \{
    return id;
  \}

  public void setId(String id) \{
    this.id = id;
  \}

  public String getTitle() \{
    return title;
  \}

  public void setTitle(String title) \{
    this.title = title;
  \}

  public String getCategory() \{
    return category;
  \}

  public void setCategory(String category) \{
    this.category = category;
  \}

  public String getContent() \{
    return content;
  \}

  public void setContent(String content) \{
    this.content = content;
  \}

  public Date getPublishedAt() \{
    return publishedAt;
  \}

  public void setPublishedAt(Date publishedAt) \{
    this.publishedAt = publishedAt;
  \}

  public String[] getTags() \{
    return tags;
  \}

  public void setTags(String[] tags) \{
    this.tags = tags;
  \}

  public List<BlogComment> getComments() \{
    return comments;
  \}

  public void setComments(List<BlogComment> comments) \{
    this.comments = comments;
  \}
\}
`}
</CodeBlock>
</TabItem>

<TabItem value="blog_comment" label="blog_comment">
<CodeBlock language="java">
{`public class BlogComment \{
  private String title;
  private String content;

  public String getTitle() \{
    return title;
  \}
  public void setTitle(String title) \{
    this.title = title;
  \}
  public String getContent() \{
    return content;
  \}
  public void setContent(String content) \{
    this.content = content;
  \}
\}
`}
</CodeBlock>
</TabItem>

<TabItem value="highlights_1" label="highlights_1">
<CodeBlock language="java">
{`public static class BlogPosts_ByContent extends AbstractIndexCreationTask \{
    public static class Result \{
        private String content;

        public String getContent() \{
            return content;
        \}

        public void setContent(String content) \{
            this.content = content;
        \}
    \}

    public BlogPosts_ByContent() \{
        map = "docs.Posts.Select(post => new \{ post.content \})";
        index("content", FieldIndexing.SEARCH);
        store("content", FieldStorage.YES);
        termVector("content", FieldTermVector.WITH_POSITIONS_AND_OFFSETS);
    \}
\}
`}
</CodeBlock>
</TabItem>

Now to use Highlights we just need to use one of the `highlight` query methods. The basic usage can be as simple as:   

<TabItem value="highlights_2" label="highlights_2">
<CodeBlock language="java">
{`Reference<Highlightings> highlightsRef = new Reference<>();
List<Blog> results = session
    .advanced()
    .documentQuery(Blog.class, BlogPosts_ByContent.class)
    .highlight("content", 128, 1, highlightsRef)
    .search("content", "raven")
    .toList();

StringBuilder builder = new StringBuilder();
builder.append("<ul>");

for (Blog result : results) \{
    String[] fragments = highlightsRef.value.getFragments(result.getId());
    builder.append("<li>")
        .append(fragments[0])
        .append("</li>");
\}

builder.append("</ul>");
String ul = builder.toString();
`}
</CodeBlock>
</TabItem>

This will return the list of results and for each result we will be displaying first found fragment with the length up to 128 characters.

### Highlights + Projections

Highlights can also be accessed when projections are performed.

<TabItem value="highlights_6" label="highlights_6">
<CodeBlock language="java">
{`_2
                Reference<Highlightings> highlightsRef = new Reference<>();
                HighlightingOptions highlightingOptions = new HighlightingOptions();
                highlightingOptions.setPreTags(new String[] \{ "**" \});
                highlightingOptions.setPostTags(new String[] \{ "**" \});
                List<BlogPosts_ByContent.Result> results = session
                    .query(BlogPosts_ByContent.class, BlogPosts_ByContent.class)
                    .highlight("content", 128, 1, highlightingOptions, highlightsRef)
                    .search("content", "raven")
                    .selectFields(BlogPosts_ByContent.Result.class)
                    .toList();
`}
</CodeBlock>
</TabItem>

### Highlights + Map-Reduce

Highlights can be accessed when performing queries on map-reduce indexes.

<TabItem value="highlights_7" label="highlights_7">
<CodeBlock language="java">
{`public static class BlogPosts_ByCategory_Content extends AbstractIndexCreationTask \{
    public static class Result \{
        private String category;
        private String content;

        public String getCategory() \{
            return category;
        \}

        public void setCategory(String category) \{
            this.category = category;
        \}

        public String getContent() \{
            return content;
        \}

        public void setContent(String content) \{
            this.content = content;
        \}
    \}

    public BlogPosts_ByCategory_Content() \{
        map = "docs.Posts.Select(post => new \{ post.category, post.content \})";

        reduce = "results.GroupBy(result => result.Category).Select(g => new \{" +
            " category = g.Key, " +
            " Content = string.Join(\\" \\", g.Select(r => r.content)) " +
            "\}";

        index("content", FieldIndexing.SEARCH);
        store("content", FieldStorage.YES);
        termVector("content", FieldTermVector.WITH_POSITIONS_AND_OFFSETS);
    \}
\}
`}
</CodeBlock>
</TabItem>

<TabItem value="highlights_8" label="highlights_8">
<CodeBlock language="java">
{`_2
                // highlighting 'content', but marking 'category' as key
                Reference<Highlightings> highlightsRef = new Reference<>();
                HighlightingOptions highlightingOptions = new HighlightingOptions();
                highlightingOptions.setPreTags(new String[] \{ "**" \});
                highlightingOptions.setPostTags(new String[] \{ "**" \});
                highlightingOptions.setGroupKey("category");
                List<BlogPosts_ByCategory_Content.Result> results = session
                    .advanced()
                    .documentQuery(BlogPosts_ByCategory_Content.Result.class, BlogPosts_ByCategory_Content.class)
                    .highlight("content", 128, 1, highlightingOptions, highlightsRef)
                    .search("content", "raven")
                    .toList();

                // get fragments for 'news' category
                String[] newsHighlightings = highlightsRef.value.getFragments("news");
`}
</CodeBlock>
</TabItem>

## Customization

<TabItem value="highlights_3" label="highlights_3">
<CodeBlock language="java">
{`public TSelf highlight(String fieldName, int fragmentLength, int fragmentCount, String fragmentsField);

public TSelf highlight(String fieldName, int fragmentLength, int fragmentCount, Reference<FieldHighlightings> highlightings);

public <TValue> TSelf highlight(Expression<?> propertySelector, int fragmentLength, int fragmentCount, ListPath<?, ?> fragmentsPropertySelector);

public <TValue> TSelf highlight(Expression<?> propertySelector, int fragmentLength, int fragmentCount, Reference<FieldHighlightings> highlightings);
`}
</CodeBlock>
</TabItem>

where:   
* **fieldName** or **propertySelector** is used to mark a field/property for highlight.   
* **fragmentLength** this is the maximum length of text fragments that will be returned.   
* **fragmentCount** this is the maximum number of fragments that will be returned.   
* **highlightings** this will return an instance of a `FieldHighlightings` that contains the highlight fragments for each returned result.       

By default, the highlighted text is wrapped with `<b></b>` tags, to change this behavior the `setHighlighterTags` method was introduced.

<TabItem value="highlights_4" label="highlights_4">
<CodeBlock language="java">
{`public TSelf setHighlighterTags(String preTag, String postTag);

public TSelf setHighlighterTags(String[] preTags, String[] postTags);
`}
</CodeBlock>
</TabItem>

Example. To wrap highlighted text with `**` we just need to execute following query:   

<TabItem value="highlights_5" label="highlights_5">
<CodeBlock language="java">
{`Reference<FieldHighlightings> highlightingsRef = new Reference<>();

List<BlogPost> results = session
  .advanced()
  .documentQuery(BlogPost.class, BlogPosts_ByContent.class)
  .highlight("Content", 128, 1, highlightingsRef)
  .setHighlighterTags("**", "**")
  .search("Content", "raven")
  .toList();
`}
</CodeBlock>
</TabItem>

<Admonition type="note" title="Note" id="note" href="#note">
Default `<b></b>` tags are coloured and colours are returned in following order:

- &lt;span style="border-left: 10px solid yellow"&gt;&nbsp;&lt;/span&gt;yellow,
- &lt;span style="border-left: 10px solid lawngreen"&gt;&nbsp;&lt;/span&gt;lawngreen,
- &lt;span style="border-left: 10px solid aquamarine"&gt;&nbsp;&lt;/span&gt;aquamarine,
- &lt;span style="border-left: 10px solid magenta"&gt;&nbsp;&lt;/span&gt;magenta,
- &lt;span style="border-left: 10px solid palegreen"&gt;&nbsp;&lt;/span&gt;palegreen,
- &lt;span style="border-left: 10px solid coral"&gt;&nbsp;&lt;/span&gt;coral,
- &lt;span style="border-left: 10px solid wheat"&gt;&nbsp;&lt;/span&gt;wheat,
- &lt;span style="border-left: 10px solid khaki"&gt;&nbsp;&lt;/span&gt;khaki,
- &lt;span style="border-left: 10px solid lime"&gt;&nbsp;&lt;/span&gt;lime,
- &lt;span style="border-left: 10px solid deepskyblue"&gt;&nbsp;&lt;/span&gt;deepskyblue,
- &lt;span style="border-left: 10px solid deeppink"&gt;&nbsp;&lt;/span&gt;deeppink,
- &lt;span style="border-left: 10px solid salmon"&gt;&nbsp;&lt;/span&gt;salmon,
- &lt;span style="border-left: 10px solid peachpuff"&gt;&nbsp;&lt;/span&gt;peachpuff,
- &lt;span style="border-left: 10px solid violet"&gt;&nbsp;&lt;/span&gt;violet,
- &lt;span style="border-left: 10px solid mediumpurple"&gt;&nbsp;&lt;/span&gt;mediumpurple,
- &lt;span style="border-left: 10px solid palegoldenrod"&gt;&nbsp;&lt;/span&gt;palegoldenrod,
- &lt;span style="border-left: 10px solid darkkhaki"&gt;&nbsp;&lt;/span&gt;darkkhaki,
- &lt;span style="border-left: 10px solid springgreen"&gt;&nbsp;&lt;/span&gt;springgreen,
- &lt;span style="border-left: 10px solid turquoise"&gt;&nbsp;&lt;/span&gt;turquoise,
- &lt;span style="border-left: 10px solid powderblue"&gt;&nbsp;&lt;/span&gt;powderblue
</Admonition>


