import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

<Admonition type="note" title="">

* Query execution can be deferred.  
  You can __define a query as lazy__ and execute it later when query results are actually needed.  

* This article contains lazy queries examples.  
  __Prior to this article__, please refer to [perform requests lazily](../../../client-api/session/how-to/perform-operations-lazily.mdx)  for general knowledge about  
  RavenDB's lazy behavior, and other request types that can be executed lazily within a session.

* In this page:
  * [Lazy query](../../../client-api/session/querying/how-to-perform-queries-lazily.mdx#lazy-query)  
  * [Lazy count query](../../../client-api/session/querying/how-to-perform-queries-lazily.mdx#lazy-count-query)  
  * [Lazy suggestions query](../../../client-api/session/querying/how-to-perform-queries-lazily.mdx#lazy-suggestions-query)  
  * [Lazy facets query](../../../client-api/session/querying/how-to-perform-queries-lazily.mdx#lazy-facets-query)  
  * [Syntax](../../../client-api/session/querying/how-to-perform-queries-lazily.mdx#syntax)

</Admonition>
## Lazy query

<Tabs groupId='languageSyntax'>
<TabItem value="Lazy_query" label="Lazy_query">
<CodeBlock language="csharp">
{`// Define a lazy query
Lazy<IEnumerable<Employee>> lazyEmployees = session
    .Query<Employee>()
    .Where(x => x.FirstName == "Robert")
     // Add a call to 'Lazily'
    .Lazily();

IEnumerable<Employee> employees = lazyEmployees.Value; // Query is executed here
`}
</CodeBlock>
</TabItem>
<TabItem value="Lazy_query_async" label="Lazy_query_async">
<CodeBlock language="csharp">
{`// Define a lazy query
Lazy<Task<IEnumerable<Employee>>> lazyEmployees = asyncSession
    .Query<Employee>()
    .Where(x => x.FirstName == "Robert")
     // Add a call to 'LazilyAsync'
    .LazilyAsync();

IEnumerable<Employee> employees = await lazyEmployees.Value; // Query is executed here
`}
</CodeBlock>
</TabItem>
<TabItem value="Lazy_documentQuery" label="Lazy_documentQuery">
<CodeBlock language="csharp">
{`// Define a lazy DocumentQuery
Lazy<IEnumerable<Employee>> lazyEmployees = session.Advanced
    .DocumentQuery<Employee>()
    .WhereEquals(x => x.FirstName, "Robert")
     // Add a call to 'Lazily'
    .Lazily();

IEnumerable<Employee> employees = lazyEmployees.Value; // DocumentQuery is executed here
`}
</CodeBlock>
</TabItem>
</Tabs>

* Learn more about queries in this [query overview](../../../client-api/session/querying/how-to-query.mdx).



## Lazy count query

<Tabs groupId='languageSyntax'>
<TabItem value="Lazy_query" label="Lazy_query">
<CodeBlock language="csharp">
{`// Define a lazy count query
Lazy<int> lazyCount = session
    .Query<Employee>()
    .Where(x => x.FirstName == "Robert")
     // Add a call to 'CountLazily'
    .CountLazily();

int count = lazyCount.Value; // Query is executed here
`}
</CodeBlock>
</TabItem>
<TabItem value="Lazy_query_async" label="Lazy_query_async">
<CodeBlock language="csharp">
{`// Define a lazy count query
Lazy<Task<int>> lazyCount = asyncSession
    .Query<Employee>()
    .Where(x => x.FirstName == "Robert")
     // Add a call to 'CountLazilyAsync'
    .CountLazilyAsync();

int count = await lazyCount.Value; // Query is executed here
`}
</CodeBlock>
</TabItem>
<TabItem value="Lazy_documentQuery" label="Lazy_documentQuery">
<CodeBlock language="csharp">
{`// Define a lazy DocumentQuery
Lazy<int> lazyCount = session.Advanced
    .DocumentQuery<Employee>()
    .WhereEquals(x => x.FirstName, "Robert")
     // Add a call to 'CountLazily'
    .CountLazily();

int count = lazyCount.Value; // DocumentQuery is executed here
`}
</CodeBlock>
</TabItem>
</Tabs>



## Lazy suggestions query

<Tabs groupId='languageSyntax'>
<TabItem value="Lazy_query" label="Lazy_query">
<CodeBlock language="csharp">
{`// Define a lazy suggestion query
Lazy<Dictionary<string, SuggestionResult>> lazySuggestions = session
    .Query<Product>()
    .SuggestUsing(builder => builder.ByField(x => x.Name, "chaig"))
     // Add a call to 'ExecuteLazy'
    .ExecuteLazy();

Dictionary<string, SuggestionResult> suggest = lazySuggestions.Value; // Query is executed here
List<string> suggestions = suggest["Name"].Suggestions;
`}
</CodeBlock>
</TabItem>
<TabItem value="Lazy_query_async" label="Lazy_query_async">
<CodeBlock language="csharp">
{`// Define a lazy suggestion query
Lazy<Task<Dictionary<string, SuggestionResult>>> lazySuggestions = asyncSession
    .Query<Employee>()
    .SuggestUsing(builder => builder.ByField("Name", "chaig"))
     // Add a call to 'ExecuteLazyAsync'
    .ExecuteLazyAsync();

Dictionary<string, SuggestionResult> suggest = await lazySuggestions.Value; // Query is executed here
List<string> suggestions = suggest["Name"].Suggestions;
`}
</CodeBlock>
</TabItem>
<TabItem value="Lazy_documentQuery" label="Lazy_documentQuery">
<CodeBlock language="csharp">
{`// Define a lazy DocumentQuery
Lazy<Dictionary<string, SuggestionResult>> lazySuggestions = session.Advanced
    .DocumentQuery<Employee>()
    .SuggestUsing(builder => builder.ByField("Name", "chaig"))
     // Add a call to 'ExecuteLazy'
    .ExecuteLazy();

Dictionary<string, SuggestionResult> suggest = lazySuggestions.Value; // DocumentQuery is executed here
List<string> suggestions = suggest["FullName"].Suggestions;
`}
</CodeBlock>
</TabItem>
</Tabs>

* Learn more about suggestions in [query for suggestions](../../../client-api/session/querying/how-to-work-with-suggestions.mdx).



## Lazy facets query

<Tabs groupId='languageSyntax'>
<TabItem value="Lazy_query" label="Lazy_query">
<CodeBlock language="csharp">
{`// Define a lazy facets query
Lazy<Dictionary<string, FacetResult>> lazyFacets = session
    .Query<Product, Products_ByCategoryAndPrice>()
    .AggregateBy(facetsDefinition)
     // Add a call to 'ExecuteLazy'
    .ExecuteLazy();

Dictionary<string, FacetResult> facets = lazyFacets.Value; // Query is executed here

FacetResult categoryResults = facets["Product Category"];
FacetResult priceResults = facets["Price per Unit"];
`}
</CodeBlock>
</TabItem>
<TabItem value="Lazy_query_async" label="Lazy_query_async">
<CodeBlock language="csharp">
{`// Define a lazy DocumentQuery
Lazy<Task<Dictionary<string,FacetResult>>> lazyFacets = asyncSession
    .Query<Product, Products_ByCategoryAndPrice>()
    .AggregateBy(facetsDefinition)
     // Add a call to 'ExecuteLazyAsync'
    .ExecuteLazyAsync();

Dictionary<string, FacetResult> facets = await lazyFacets.Value; // Query is executed here

FacetResult categoryResults = facets["Product Category"];
FacetResult priceResults = facets["Price per Unit"];
`}
</CodeBlock>
</TabItem>
<TabItem value="Lazy_documentQuery" label="Lazy_documentQuery">
<CodeBlock language="csharp">
{`// Define a lazy DocumentQuery
Lazy<Dictionary<string, FacetResult>> lazyFacets = session.Advanced
    .DocumentQuery<Product, Products_ByCategoryAndPrice>()
    .AggregateBy(facetsDefinition)
     // Add a call to 'ExecuteLazy'
    .ExecuteLazy();

Dictionary<string, FacetResult> facets = lazyFacets.Value; //  DocumentQuery is executed here

FacetResult categoryResults = facets["Product Category"];
FacetResult priceResults = facets["Price per Unit"];
`}
</CodeBlock>
</TabItem>
<TabItem value="Facets_definition" label="Facets_definition">
<CodeBlock language="csharp">
{`// The facets definition used in the facets query:
List<FacetBase> facetsDefinition = new List<FacetBase>
{
    new Facet
    {
        FieldName = "CategoryName",
        DisplayFieldName = "Product Category"
    },
    new RangeFacet<Product>
    {
        Ranges =
        {
            product => product.PricePerUnit < 25,
            product => product.PricePerUnit >= 25 && product.PricePerUnit < 50,
            product => product.PricePerUnit >= 50 && product.PricePerUnit < 100,
            product => product.PricePerUnit >= 100
        },
        DisplayFieldName = "Price per Unit"
    }
};
`}
</CodeBlock>
</TabItem>
<TabItem value="Index_definition" label="Index_definition">
<CodeBlock language="csharp">
{`// The index definition used in the facets query:
public class Products_ByCategoryAndPrice :
    AbstractIndexCreationTask<Product, Products_ByCategoryAndPrice.IndexEntry>
{
    // The IndexEntry class defines the index-fields
    public class IndexEntry
    {
        public string CategoryName { get; set; }
        public decimal PricePerUnit { get; set; }
    }
        
    public Products_ByCategoryAndPrice()
    {
        // The 'Map' function defines the content of the index-fields
        Map = products => from product in products
            select new IndexEntry
            {
                CategoryName = LoadDocument<Category>(product.Category).Name,
                PricePerUnit = product.PricePerUnit
            };
    }
}
`}
</CodeBlock>
</TabItem>
</Tabs>

* Learn more about facets in [perform faceted search](../../../client-api/session/querying/how-to-perform-a-faceted-search.mdx).



## Syntax

<TabItem value="syntax_1" label="syntax_1">
<CodeBlock language="csharp">
{`// Lazy query overloads:
Lazy<IEnumerable<T>> Lazily<T>();
Lazy<IEnumerable<T>> Lazily<T>(Action<IEnumerable<T>> onEval);

Lazy<Task<IEnumerable<T>>> LazilyAsync<T>();
Lazy<Task<IEnumerable<T>>> LazilyAsync<T>(Action<IEnumerable<T>> onEval);
`}
</CodeBlock>
</TabItem>
<TabItem value="syntax_2" label="syntax_2">
<CodeBlock language="csharp">
{`// Lazy count query overloads:
Lazy<int> CountLazily<T>();
Lazy<long> LongCountLazily<T>();

Lazy<Task<int>> CountLazilyAsync<T>(CancellationToken token = default(CancellationToken));
Lazy<Task<long>> LongCountLazilyAsync<T>(CancellationToken token = default(CancellationToken));
`}
</CodeBlock>
</TabItem>
<TabItem value="syntax_3" label="syntax_3">
<CodeBlock language="csharp">
{`// Lazy suggestions query overloads:
Lazy<Dictionary<string, SuggestionResult>>
    ExecuteLazy(Action<Dictionary<string, SuggestionResult>> onEval = null);

Lazy<Task<Dictionary<string, SuggestionResult>>>
    ExecuteLazyAsync(Action<Dictionary<string, SuggestionResult>> onEval = null,
        CancellationToken token = default);
`}
</CodeBlock>
</TabItem>
<TabItem value="syntax_4" label="syntax_4">
<CodeBlock language="csharp">
{`// Lazy facets query overloads:
Lazy<Dictionary<string, FacetResult>>
    ExecuteLazy(Action<Dictionary<string, FacetResult>> onEval = null);

Lazy<Task<Dictionary<string, FacetResult>>>
    ExecuteLazyAsync(Action<Dictionary<string, FacetResult>> onEval = null,
        CancellationToken token = default);
`}
</CodeBlock>
</TabItem>

| Parameters | Type                                                                                                                              | Description                                                                          |
|------------|-----------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------|
| __onEval__ | `Action<IEnumerable<TResult>>` <br/> `Action<Dictionary<string, SuggestionResult>>` <br/> `Action<Dictionary<string, FacetResult>>` | An action that will be performed on the query results<br/>when the query is executed. |

| Return Value                                                                                                                           |                                                                |
|----------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------|
| `Lazy<IEnumerable<TResult>>`<br/>`Lazy<int>`<br/>`Lazy<Dictionary<string, SuggestionResult>>`<br/>`Lazy<Dictionary<string, FacetResult>>` | A lazy instance that will evaluate the query only when needed. |




