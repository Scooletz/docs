---
title: "Session: Patch Time Series"
hide_table_of_contents: true
sidebar_label: Patch
sidebar_position: 4
---

import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';
import LanguageSwitcher from "@site/src/components/LanguageSwitcher";
import LanguageContent from "@site/src/components/LanguageContent";

# Session: Patch Time Series
<Admonition type="note" title="Note">

* To patch time series entries to a document, use `session.Advanced.Defer`.  
   * You can pass `Defer` a script to Append, Get, and Remove time series entries.  
   * You can handle a single document at a time.  

* [Patching Using `session.Advanced.Defer`](../../../../document-extensions/timeseries/client-api/session/patch.mdx#patching-using-sessionadvanceddefer)  
   * [Syntax](../../../../document-extensions/timeseries/client-api/session/patch.mdx#syntax)  
   * [Usage Flow](../../../../document-extensions/timeseries/client-api/session/patch.mdx#usage-flow)  
   * [Usage Samples](../../../../document-extensions/timeseries/client-api/session/patch.mdx#usage-samples)  

</Admonition>
## Patching Using `session.Advanced.Defer`

<Admonition type="info" title="Info">

* [Defer](../../../../client-api/operations/patching/single-document.mdx#non-typed-session-api) 
  is used for patching in general, not necessarily for time series data patching.  
* To patch time series data, you need to [customize the JavaScript](../../../../document-extensions/timeseries/client-api/javascript-support.mdx) 
  that `Defer` uses.  
* Learn more about time series JavaScript [here](../../../../document-extensions/timeseries/client-api/javascript-support.mdx).  

</Admonition>



## Syntax

* **`PatchCommandData`**  
   * **Definition**
<TabItem value="PatchCommandData-definition" label="PatchCommandData-definition">
<CodeBlock language="csharp">
{`public PatchCommandData(string id, string changeVector,
    PatchRequest patch, PatchRequest patchIfMissing)
`}
</CodeBlock>
</TabItem>
     Learn more about `PatchCommandData` [here](../../../../client-api/operations/patching/single-document.mdx#non-typed-session-api).

* **`PatchRequest`**  
   * **Definition**
<TabItem value="PatchRequest-definition" label="PatchRequest-definition">
<CodeBlock language="csharp">
{`public class PatchRequest
\{
    // The patching script     
    public string Script \{ get; set; \}
    
    // Values for the parameters used by the patching script
    public Dictionary<string, object> Values \{ get; set; \}
\}
`}
</CodeBlock>
</TabItem>
     Learn more about `PatchRequest` [here](../../../../client-api/operations/patching/single-document.mdx#non-typed-session-api).  



## Usage Flow

* Open a session  
* Call `session.Advanced.Defer` and pass it a `PatchCommandData` instance.  
* Pass the `PatchCommandData` constructor method -  
   * the document ID  
   * the change vector (or `null`)  
   * a `PatchRequest` instance with a JavaScript that appends or removes time series entries.  
* Call `session.SaveChanges()` to perform the patch.  



## Usage Samples

* In this sample, we pass `Defer` a script that appends a document 100 time series 
  entries with random heart rate values.  
<TabItem value="TS_region-Session_Patch-Append-100-Random-TS-Entries" label="TS_region-Session_Patch-Append-100-Random-TS-Entries">
<CodeBlock language="csharp">
{`var baseline = DateTime.Today;

// Create arrays of timestamps and random values to patch
List<double> values = new List<double>();
List<DateTime> timeStamps = new List<DateTime>();

for (var i = 0; i < 100; i++)
\{
    values.Add(68 + Math.Round(19 * new Random().NextDouble()));
    timeStamps.Add(baseline.AddSeconds(i));
\}

session.Advanced.Defer(new PatchCommandData("users/1-A", null,
    new PatchRequest
    \{
        Script = @"
            var i = 0;
            for(i = 0; i < $values.length; i++)
            \{
                timeseries(id(this), $timeseries)
                .append (
                  new Date($timeStamps[i]), 
                  $values[i], 
                  $tag);
            \}",

        Values =
        \{
            \{ "timeseries", "HeartRates" \},
            \{ "timeStamps", timeStamps\},
            \{ "values", values \},
            \{ "tag", "watches/fitbit" \}
        \}
    \}, null));

session.SaveChanges();
`}
</CodeBlock>
</TabItem>

* In this sample, we remove a range of 50 time series entries from a document.  
<TabItem value="TS_region-Session_Patch-Delete-50-TS-Entries" label="TS_region-Session_Patch-Delete-50-TS-Entries">
<CodeBlock language="csharp">
{`// Delete time-series entries
session.Advanced.Defer(new PatchCommandData("users/1-A", null,
    new PatchRequest
    \{
        Script = @"timeseries(this, $timeseries)
                 .delete(
                    $from, 
                    $to
                  );",
        Values =
        \{
            \{ "timeseries", "HeartRates" \},
            \{ "from", baseline.AddSeconds(0) \},
            \{ "to", baseline.AddSeconds(49) \}
        \}
    \}, null));

session.SaveChanges();
`}
</CodeBlock>
</TabItem>



