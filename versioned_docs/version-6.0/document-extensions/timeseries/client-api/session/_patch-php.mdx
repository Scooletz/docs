import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

<Admonition type="note" title="">

* Patching multiple time series entries (append or delete entries) can be performed via the _Session_  
  using `session.advanced.defer` as described below.
  * You can handle a single document at a time.
  * The patching action is defined by the provided `JavaScript`.
  
* Patching time series entries can also be done directly on the _Store_ via [Operations](../../../../client-api/operations/what-are-operations.mdx),  
  where multiple documents can be handled at a time.  

* In this page:
   * [Usage](../../../../document-extensions/timeseries/client-api/session/patch.mdx#usage)  
   * [Patching examples](../../../../document-extensions/timeseries/client-api/session/patch.mdx#patching-examples)
     * [Append multiple entries](../../../../document-extensions/timeseries/client-api/session/patch.mdx#append-multiple-entries) 
     * [Delete multiple entries](../../../../document-extensions/timeseries/client-api/session/patch.mdx#delete-multiple-entries) 
   * [Syntax](../../../../document-extensions/timeseries/client-api/session/patch.mdx#syntax)

</Admonition>
## Usage

* Open a session
* Construct a `PatchCommandData` instance and pass it the following:
    * The document ID that contains the time series
    * The document change vector (or `null`)
    * A `PatchRequest` instance with a JavaScript that appends or removes time series entries
* Call `session.advanced.defer` and pass it the `PatchCommandData` command.  
  Note that you can call _Defer_ multiple times prior to calling _SaveChanges_.
* Call `session.saveChanges`.  
  All patch requests added via _Defer_ will be sent to the server for execution when _SaveChanges_ is called.



## Patching examples

#### Append multiple entries:

In this example, we append 100 time series entries with random heart rate values to a document.  

<TabItem value="TS_region-Session_Patch-Append-100-Random-TS-Entries" label="TS_region-Session_Patch-Append-100-Random-TS-Entries">
<CodeBlock language="php">
{`$baseTime = DateUtils::today();

/ Create arrays of timestamps and random values to patch
values = [];
timeStamps = [];

or ($i = 0; $i < 100; $i++)
{
   $values[] = 68 + rand(0, 19);
   $timeStamps[] =   (clone $baseTime)->add(new DateInterval("PT" . $i . "S"));
}

patchRequest = new PatchRequest();
patchRequest->setScript("
           var i = 0;
           for(i = 0; i < \\$values.length; i++)
           \{
               timeseries(id(this), \\$timeseries)
               .append (
                 new Date(\\$timeStamps[i]),
                 \\$values[i],
                 \\$tag);
           \}");
patchRequest->setValues([
       "timeseries" => "HeartRates",
       "timeStamps" => $timeStamps,
       "values" => $values,
       "tag" => "watches/fitbit"
);

session->advanced()->defer(new PatchCommandData("users/1-A", null, $patchRequest, null));

session->saveChanges();
`}
</CodeBlock>
</TabItem>
#### Delete multiple entries:

In this example, we remove a range of 50 time series entries from a document.  

<TabItem value="TS_region-Session_Patch-Delete-50-TS-Entries" label="TS_region-Session_Patch-Delete-50-TS-Entries">
<CodeBlock language="php">
{`// Delete time-series entries
$patchRequest = new PatchRequest();
$patchRequest->setScript("timeseries(this, \\$timeseries)
                 .delete(
                    \\$from,
                    \\$to
                  );");
$patchRequest->setValues([
    "timeseries" => "HeartRates",
    "from" =>  $baseTime,
    "to" =>   (clone $baseTime)->add(new DateInterval("PT49S"))
]);

$session->advanced()->defer(new PatchCommandData("users/1-A", null, $patchRequest, null));

$session->saveChanges();
`}
</CodeBlock>
</TabItem>



## Syntax

**`PatchCommandData`**

<TabItem value="PatchCommandData-definition" label="PatchCommandData-definition">
<CodeBlock language="php">
{`new PatchCommandData(?string $id, ?string $changeVector, ?PatchRequest $patch, ?PatchRequest $patchIfMissing = null);
`}
</CodeBlock>
</TabItem>
**`PatchRequest`**

<TabItem value="PatchRequest-definition" label="PatchRequest-definition">
<CodeBlock language="php">
{`class PatchRequest
\{
    // The patching script
    private ?string $script = null;

    // Values for the parameters used by the patching script
    private ?ObjectMap $values = null;

    // ... getters and setters ...
\}
`}
</CodeBlock>
</TabItem>




