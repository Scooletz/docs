import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

<Admonition type="note" title="">

* When making a [Full-Text Search query](../../../../client-api/session/querying/text-search/full-text-search.mdx),  
  in addition to retrieving documents that contain the searched terms in the results,  
  you can also request to get a **list of text fragments that highlight the searched terms**.

* The highlighted terms can enhance user experience when searching for documents with specific content.

* This article shows highlighting search results when making a **dynamic-query**.  
  For highlighting search results when querying a **static-index** see [highlight index search results](../../../../indexes/querying/highlighting.mdx).
* In this page:
  * [Highlight - basic example](../../../../client-api/session/querying/text-search/highlight-query-results.mdx#highlight---basic-example)
      * [Highlight tags](../../../../client-api/session/querying/text-search/highlight-query-results.mdx#highlight-tags)
      * [Highlight results in Studio](../../../../client-api/session/querying/text-search/highlight-query-results.mdx#highlight-results-in-studio)
  * [Highlight - customize tags](../../../../client-api/session/querying/text-search/highlight-query-results.mdx#highlight---customize-tags)
  * [Highlight - projected results](../../../../client-api/session/querying/text-search/highlight-query-results.mdx#highlight---projected-results)
  * [Syntax](../../../../client-api/session/querying/text-search/highlight-query-results.mdx#syntax)
  
</Admonition>
## Highlight - basic example

<Tabs groupId='languageSyntax'>
<TabItem value="Query" label="Query">
<CodeBlock language="python">
{`# Make a full-text search dynamic query:
# ======================================

# Define a callback that takes highlightings as an argument
sales_highlightings: Optional[Highlightings] = None

def _sales_highlights(highlightings: Highlightings):
    # You may use the results (highlightings) here in any way desired
    sales_highlightings = highlightings

employees_result = list(  # Execute the query inside the parenthesis
    session
    # Make a query on 'Employees' collection
    .query(object_type=Employee)
    # Search for documents containing the term 'sales' in their 'Notes' field
    .search("Notes", "sales")
    # Request to highlight the searched term by calling 'Highlight'
    .highlight(
        "Notes",  # The document-field name in which we search
        35,  # Max length of each text fragment
        4,  # Max number of fragments to return per document
        _sales_highlights,  # An out param for getting the highlighted text fragments
    )
)
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from "Employees"
where search(Notes, "sales")
include highlight(Notes, 35, 4)
`}
</CodeBlock>
</TabItem>
</Tabs>

<TabItem value="fragments_1" label="fragments_1">
<CodeBlock language="python">
{`# Process results:
# ================

# 'employees_results' contains all Employee DOCUMENTS that have 'sales' in their 'Notes' field.
# 'sales_highlights' contains the text FRAGMENTS that highlight the 'sales' term.

builder = ["<ul>", \{os.linesep\}]
for employee in employees_result:
    # Call 'get_fragments' to get all fragments for the specified employee Id
    fragments = sales_highlightings.get_fragments(employee.Id)
    for fragment in fragments:
        builder.append(f"\{os.linesep\}<li>Doc: \{employee.Id\} Fragment: \{fragment\}</li>")

fragments_html = builder.append(f"\{os.linesep\}</ul>")

# The resulting fragments_html:
# ============================

# <ul>
#   <li>Doc: employees/2-A Fragment: company as a <b style="background:yellow">sales</b></li>
#   <li>Doc: employees/2-A Fragment: promoted to <b style="background:yellow">sales</b> manager in</li>
#   <li>Doc: employees/2-A Fragment: president of <b style="background:yellow">sales</b> in March 1993</li>
#   <li>Doc: employees/2-A Fragment: member of the <b style="background:yellow">Sales</b> Management</li>
#   <li>Doc: employees/3-A Fragment: hired as a <b style="background:yellow">sales</b> associate in</li>
#   <li>Doc: employees/3-A Fragment: promoted to <b style="background:yellow">sales</b> representativ</li>
#   <li>Doc: employees/5-A Fragment: company as a <b style="background:yellow">sales</b> representativ</li>
#   <li>Doc: employees/5-A Fragment: promoted to <b style="background:yellow">sales</b> manager in</li>
#   <li>Doc: employees/5-A Fragment: <b style="background:yellow">Sales</b> Management." </li>
#   <li>Doc: employees/6-A Fragment: for the <b style="background:yellow">Sales</b> Professional.</li>
#  </ul>
`}
</CodeBlock>
</TabItem>

<Admonition type="note" title="">

#### Highlight tags

* By default, the highlighted term is wrapped with the following html:  
  `<b style="background:yellow">term</b>`  

* When requesting to highlight multiple terms,  
  the background color returned for each different term will be in the following order:

  - &lt;span style="border-left: 10px solid yellow"&gt;&nbsp;&lt;/span&gt;yellow,
  - &lt;span style="border-left: 10px solid lawngreen"&gt;&nbsp;&lt;/span&gt;lawngreen,
  - &lt;span style="border-left: 10px solid aquamarine"&gt;&nbsp;&lt;/span&gt;aquamarine,
  - &lt;span style="border-left: 10px solid magenta"&gt;&nbsp;&lt;/span&gt;magenta,
  - &lt;span style="border-left: 10px solid palegreen"&gt;&nbsp;&lt;/span&gt;palegreen,
  - &lt;span style="border-left: 10px solid coral"&gt;&nbsp;&lt;/span&gt;coral,
  - &lt;span style="border-left: 10px solid wheat"&gt;&nbsp;&lt;/span&gt;wheat,
  - &lt;span style="border-left: 10px solid khaki"&gt;&nbsp;&lt;/span&gt;khaki,
  - &lt;span style="border-left: 10px solid lime"&gt;&nbsp;&lt;/span&gt;lime,
  - &lt;span style="border-left: 10px solid deepskyblue"&gt;&nbsp;&lt;/span&gt;deepskyblue,
  - &lt;span style="border-left: 10px solid deeppink"&gt;&nbsp;&lt;/span&gt;deeppink,
  - &lt;span style="border-left: 10px solid salmon"&gt;&nbsp;&lt;/span&gt;salmon,
  - &lt;span style="border-left: 10px solid peachpuff"&gt;&nbsp;&lt;/span&gt;peachpuff,
  - &lt;span style="border-left: 10px solid violet"&gt;&nbsp;&lt;/span&gt;violet,
  - &lt;span style="border-left: 10px solid mediumpurple"&gt;&nbsp;&lt;/span&gt;mediumpurple,
  - &lt;span style="border-left: 10px solid palegoldenrod"&gt;&nbsp;&lt;/span&gt;palegoldenrod,
  - &lt;span style="border-left: 10px solid darkkhaki"&gt;&nbsp;&lt;/span&gt;darkkhaki,
  - &lt;span style="border-left: 10px solid springgreen"&gt;&nbsp;&lt;/span&gt;springgreen,
  - &lt;span style="border-left: 10px solid turquoise"&gt;&nbsp;&lt;/span&gt;turquoise,
  - &lt;span style="border-left: 10px solid powderblue"&gt;&nbsp;&lt;/span&gt;powderblue

* The html tags that wrap the highlighted terms can be **customized** to any other tags.  
  See [customize tags](../../../../client-api/session/querying/text-search/highlight-query-results.mdx#highlight---customize-tags) below.

</Admonition>

<Admonition type="note" title="">

#### Highlight results in Studio

![Figure 1. Fragments results](./assets/fragmentsResults.png)

1. **Auto-Index**  
   This is the auto-index that was created by the server to serve the dynamic-query.  

2. **Results tab**  
   The results tab contains the resulting **documents** that match the provided RQL query.

3. **Highlight tab**  
   The highlight tab shows the resulting **fragments** that were included in the query result.

</Admonition>



## Highlight - customize tags

* The html tags that wrap the highlighted terms can be **customized** to any other tags.

<Tabs groupId='languageSyntax'>
<TabItem value="Query" label="Query">
<CodeBlock language="python">
{`# Define customized tags to use for highlighting the searched terms
# =================================================================
tags_to_use = HighlightingOptions(
    # Provide strings of your choice to 'PreTags' & 'PostTags', e.g.:
    # the first term searched for will be wrapped with '+++'
    # the second term searched for will be wrapped with '<<<' & '>>>'
    pre_tags=["+++", "<<<"],
    post_tags=["+++", ">>>"],
)

# Define a callback that takes highlightings as an argument
manager_highlightings: Optional[Highlightings] = None

def _manager_highlights(highlightings: Highlightings):
    # You may use the results (highlightings) here in any way desired
    manager_highlightings = highlightings

# Make a full-text search dynamic query:
# ======================================
employees_result = list(
    session.query(object_type=Employee)
    # Search for:
    #  * documents containing the term 'sales' in their 'Notes' field
    #  * OR for documents containing the term 'manager' in their 'Title' field
    .search("Notes", "sales")
    .search("Title", "manager")
    # Call 'Highlight' for each field searched
    # Pass 'tagsToUse' to OVERRIDE the default tags used
    .highlight("Notes", 35, 1, _sales_highlights)
    .highlight("Title", 35, 1, tags_to_use, _manager_highlights)
)
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from "Employees"
where (search(Notes, "sales") or search(Title, "manager"))
include highlight(Notes, 35, 1, $p0), highlight(Title, 35, 1, $p1)
{
"p0":{"PreTags":["+++","<<<"],"PostTags":["+++",">>>"]},
"p1":{"PreTags":["+++","<<<"],"PostTags":["+++",">>>"]}
}
`}
</CodeBlock>
</TabItem>
</Tabs>

<TabItem value="fragments_2" label="fragments_2">
<CodeBlock language="python">
{`# The resulting salesHighlights fragments:
# ========================================
#
# "for the +++Sales+++ Professional."
# "hired as a +++sales+++ associate in"
# "company as a +++sales+++"
# "company as a +++sales+++ representative"
#
# The resulting managerHighlights fragments:
# ==========================================
#
# "Sales <<<Manager>>>"
`}
</CodeBlock>
</TabItem>



## Highlight - projected results

* Highlighting can also be used when [projecting query results](../../../../client-api/session/querying/how-to-project-query-results.mdx).

<Tabs groupId='languageSyntax'>
<TabItem value="Query" label="Query">
<CodeBlock language="python">
{`# Make a full-text search dynamic query & project results:
# ========================================================

# Define a callback that takes highlightings as an argument
terms_highlightings: Optional[Highlightings] = None

def _terms_highlights(highlightings: Highlightings):
    # You may use the results (highlightings) here in any way desired
    terms_highlightings = highlightings

employees_projected = list(
    session.query(object_type=Employee)
    .search("Notes", "manager german")
    .highlight("Notes", 35, 2, _terms_highlights)
    .select_fields_query_data(
        QueryData.custom_function("o", "{ Name: o.FirstName + ' ' + o.LastName, Title: o.Title }"),
    )
)

# todo reeb & gracjan: lets implement it after 5.4 release
#  i have a perfect ticket for that
#  https://issues.hibernatingrhinos.com/issue/RDBC-820#focus=Comments-67-1050834.0-0
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from "Employees" as x
where search(x.Notes, "manager german")
select { Name : "{0} {1}".format(x.FirstName, x.LastName), Title : x.Title }
include highlight(Notes, 35, 2)
`}
</CodeBlock>
</TabItem>
</Tabs>

<TabItem value="fragments_3" label="fragments_3">
<CodeBlock language="python">
{`# The resulting fragments from termsHighlights:
# =============================================
#
# "to sales <b style=\\"background:yellow\\">manager</b> in March"
# "and reads <b style=\\"background:lawngreen\\">German</b>.  He joined"
# "to sales <b style=\\"background:yellow\\">manager</b> in January"
# "in French and <b style=\\"background:lawngreen\\">German</b>."
#
# NOTE: each search term is wrapped with a different color
# 'manager' is wrapped with yellow
# 'german' is wrapped with lawngreen
`}
</CodeBlock>
</TabItem>



## Syntax

<TabItem value="syntax_1" label="syntax_1">
<CodeBlock language="python">
{`def highlight(
    self,
    field_name: str,
    fragment_length: int,
    fragment_count: int,
    highlightings_callback: Callable[[Highlightings], None],
    options: Optional[HighlightingOptions] = None,
) -> DocumentQuery[_T]: ...
`}
</CodeBlock>
</TabItem>

| Parameter          | Type                          | Description                         |
|--------------------|-------------------------------|-------------------------------------|
| **field_name** | `str` | Name of the field that contains the searched terms to highlight |
| **fragment_length** | `int` | Maximum length of a text fragment<br/>Must be `>= 18` |
| **fragment_count** | `int` | Maximum number of text fragments that will be returned |
| **highlightings_callback** | `Callable[[Highlightings], None]` | A callback function to retrieve the highlighted text fragments for each returned result |
| **options** (Optional) | `HighlightingOptions ` | Customizing options |

<br/>

**Highlighting options**:

<TabItem value="syntax_2" label="syntax_2">
<CodeBlock language="python">
{`def __init__(self, group_key: str = None, pre_tags: List[str] = None, post_tags: List[str] = None):
    self.group_key = group_key
    self.pre_tags = pre_tags
    self.post_tags = post_tags
`}
</CodeBlock>
</TabItem>

| Option       | Type      | Description  |
|--------------|-----------|--------------|
| **group_key** | `str` | Grouping key for the results.<br/>Used when highlighting query results from a [Map-Reduce index](../../../../indexes/querying/highlighting.mdx#highlight-results---map-reduce-index).<br/>If `None` results are grouped by document ID (default).<br/>Note: Highlighting is Not available for dynamic aggregation queries. |
| **pre_tags** | `List[str]` | Array of PRE tags used to wrap the highlighted search terms in the text fragments. |
| **post_tags** | `List[str]` | Array of POST tags used to wrap the highlighted search terms in the text fragments. |

<br/>

**Highlightings object**:

<TabItem value="syntax_3" label="syntax_3">
<CodeBlock language="python">
{`def __init__(self, field_name: str):
    self.field_name = field_name
    ...

@property
def result_indents(self) -> Set[str]: ...
`}
</CodeBlock>
</TabItem>

| Property           | Type       | Description                                                     |
|--------------------|------------|-----------------------------------------------------------------|
| **field_name**     | `str`      | Name of the field that contains the searched terms to highlight |
| **result_indents** | `Set[str]` | The resulting keys (document IDs, or the map-reduce keys) |

<TabItem value="syntax_4" label="syntax_4">
<CodeBlock language="python">
{`def get_fragments(self, key: str) -> List[str]: ...
`}
</CodeBlock>
</TabItem>

| Method            | Return Type | Description    |
|-------------------|-------------|------------------------------------------------------------------------------------------------------|
| **get_fragments** | `List[str]` | Returns the list of the highlighted text fragments for the passed document ID, or the map-reduce key |




