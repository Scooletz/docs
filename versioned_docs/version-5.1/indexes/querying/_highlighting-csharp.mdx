import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

Another feature called `Highlighting` has been added to RavenDB to enhance the search UX.

## Setup

<Tabs groupId='languageSyntax'>
<TabItem value="BlogPost" label="BlogPost">
<CodeBlock language="csharp">
{`public class BlogPost
{
	public string Id { get; set; }

	public string Title { get; set; }

	public string Category { get; set; }

	public string Content { get; set; }

	public DateTime PublishedAt { get; set; }

	public string[] Tags { get; set; }

	public BlogComment[] Comments { get; set; }
}
`}
</CodeBlock>
</TabItem>
<TabItem value="BlogComment" label="BlogComment">
<CodeBlock language="csharp">
{`public class BlogComment
{
	public string Title { get; set; }

	public string Content { get; set; }
}
`}
</CodeBlock>
</TabItem>
</Tabs>

<Tabs groupId='languageSyntax'>
<TabItem value="Index" label="Index">
<CodeBlock language="csharp">
{`public class BlogPosts_ByContent : AbstractIndexCreationTask<BlogPost>
{
    public class Result
    {
        public string Content { get; set; }
    }

    public BlogPosts_ByContent()
    {
        Map = posts => from post in posts
                       select new Result
                       {
                           Content = post.Content
                       };

        Index(x => x.Content, FieldIndexing.Search);
        Store(x => x.Content, FieldStorage.Yes);
        TermVector(x => x.Content, FieldTermVector.WithPositionsAndOffsets);
    }
}
`}
</CodeBlock>
</TabItem>
</Tabs>

<Admonition type="info" title="Important" id="important" href="#important">

Each of the fields on which we want to use **Highlighting** needs to have:

- **FieldIndexing** set to `Search`
- **FieldStorage** set to `Yes`
- **FieldTermVector** set to `WithPositionsAndOffsets`

</Admonition>

## Usage

To use Highlighting we just need to use one of the `Highlight` query methods. The basic usage can be as simple as:   

<TabItem value="highlights_2" label="highlights_2">
<CodeBlock language="csharp">
{`BlogPost[] results = session
    .Advanced
    .DocumentQuery<BlogPost, BlogPosts_ByContent>()
    .Highlight("Content", 128, 1, out Highlightings highlightings)
    .Search("Content", "raven")
    .ToArray();

StringBuilder builder = new StringBuilder()
    .AppendLine("<ul>");

foreach (BlogPost result in results)
\{
    string[] fragments = highlightings.GetFragments(result.Id);
    builder.AppendLine($"<li>\{fragments.First()\}</li>");
\}

string ul = builder
    .AppendLine("</ul>")
    .ToString();
`}
</CodeBlock>
</TabItem>

This will return the list of results and for each result we will be displaying first found fragment with the length up to 128 characters.

### Highlighting + Projections

Highlighting can also be done when projections are performed.

<Tabs groupId='languageSyntax'>
<TabItem value="DocumentQuery_1" label="DocumentQuery_1">
<CodeBlock language="csharp">
{`BlogPosts_ByContent.Result[] results = session
    .Query<BlogPosts_ByContent.Result, BlogPosts_ByContent>()
    .Highlight("Content", 128, 1, new HighlightingOptions
    {
        PreTags = new[] { "**" },
        PostTags = new[] { "**" }
    }, out Highlightings highlightings)
    .Search(x => x.Content, "raven")
    .ProjectInto<BlogPosts_ByContent.Result>()
    .ToArray();
`}
</CodeBlock>
</TabItem>
<TabItem value="DocumentQuery_2" label="DocumentQuery_2">
<CodeBlock language="csharp">
{`BlogPosts_ByContent.Result[] results = session
    .Advanced
    .DocumentQuery<BlogPost, BlogPosts_ByContent>()
    .Highlight("Content", 128, 1, new HighlightingOptions
    {
        PreTags = new[] { "**" },
        PostTags = new[] { "**" }
    }, out Highlightings highlightings)
    .Search("Content", "raven")
    .SelectFields<BlogPosts_ByContent.Result>()
    .ToArray();
`}
</CodeBlock>
</TabItem>
<TabItem value="Index" label="Index">
<CodeBlock language="csharp">
{`public class BlogPosts_ByContent : AbstractIndexCreationTask<BlogPost>
{
    public class Result
    {
        public string Content { get; set; }
    }

    public BlogPosts_ByContent()
    {
        Map = posts => from post in posts
                       select new Result
                       {
                           Content = post.Content
                       };

        Index(x => x.Content, FieldIndexing.Search);
        Store(x => x.Content, FieldStorage.Yes);
        TermVector(x => x.Content, FieldTermVector.WithPositionsAndOffsets);
    }
}
`}
</CodeBlock>
</TabItem>
</Tabs>

### Highlighting + Map-Reduce

Highlighting can be performed when executing queries on map-reduce indexes.

<Tabs groupId='languageSyntax'>
<TabItem value="Query" label="Query">
<CodeBlock language="csharp">
{`// highlighting 'Content', but marking 'Category' as key
BlogPosts_ByCategory_Content.Result[] results = session
    .Query<BlogPosts_ByCategory_Content.Result, BlogPosts_ByCategory_Content>()
    .Highlight("Content", 128, 1, new HighlightingOptions
    {
        PreTags = new[] { "**" },
        PostTags = new[] { "**" },
        GroupKey = "Category"
    }, out Highlightings highlightings)
    .Search(x => x.Content, "raven")
    .ToArray();

// get fragments for 'News' category
var newsHighlightings = highlightings.GetFragments("News");
`}
</CodeBlock>
</TabItem>
<TabItem value="DocumentQuery" label="DocumentQuery">
<CodeBlock language="csharp">
{`// highlighting 'Content', but marking 'Category' as key
BlogPosts_ByCategory_Content.Result[] results = session
    .Advanced
    .DocumentQuery<BlogPosts_ByCategory_Content.Result, BlogPosts_ByCategory_Content>()
    .Highlight("Content", 128, 1, new HighlightingOptions
    {
        PreTags = new[] { "**" },
        PostTags = new[] { "**" },
        GroupKey = "Category"
    }, out Highlightings highlightings)
    .Search("Content", "raven")
    .ToArray();

// get fragments for 'News' category
var newsHighlightings = highlightings.GetFragments("News");
`}
</CodeBlock>
</TabItem>
<TabItem value="Index" label="Index">
<CodeBlock language="csharp">
{`public class BlogPosts_ByCategory_Content : AbstractIndexCreationTask<BlogPost, BlogPosts_ByCategory_Content.Result>
{
    public class Result
    {
        public string Category { get; set; }

        public string Content { get; set; }
    }

    public BlogPosts_ByCategory_Content()
    {
        Map = posts => from post in posts
                       select new Result
                       {
                           Category = post.Category,
                           Content = post.Content
                       };

        Reduce = results => from result in results
                            group result by result.Category into g
                            select new
                            {
                                Category = g.Key,
                                Content = string.Join(" ", g.Select(r => r.Content))
                            };

        Index(x => x.Content, FieldIndexing.Search);
        Store(x => x.Content, FieldStorage.Yes);
        TermVector(x => x.Content, FieldTermVector.WithPositionsAndOffsets);
    }
}
`}
</CodeBlock>
</TabItem>
</Tabs>

## Remarks

<Admonition type="note" title="Note" id="note" href="#note">
Default `<b></b>` tags are coloured and colours are returned in following order:

- &lt;span style="border-left: 10px solid yellow"&gt;&nbsp;&lt;/span&gt;yellow,
- &lt;span style="border-left: 10px solid lawngreen"&gt;&nbsp;&lt;/span&gt;lawngreen,
- &lt;span style="border-left: 10px solid aquamarine"&gt;&nbsp;&lt;/span&gt;aquamarine,
- &lt;span style="border-left: 10px solid magenta"&gt;&nbsp;&lt;/span&gt;magenta,
- &lt;span style="border-left: 10px solid palegreen"&gt;&nbsp;&lt;/span&gt;palegreen,
- &lt;span style="border-left: 10px solid coral"&gt;&nbsp;&lt;/span&gt;coral,
- &lt;span style="border-left: 10px solid wheat"&gt;&nbsp;&lt;/span&gt;wheat,
- &lt;span style="border-left: 10px solid khaki"&gt;&nbsp;&lt;/span&gt;khaki,
- &lt;span style="border-left: 10px solid lime"&gt;&nbsp;&lt;/span&gt;lime,
- &lt;span style="border-left: 10px solid deepskyblue"&gt;&nbsp;&lt;/span&gt;deepskyblue,
- &lt;span style="border-left: 10px solid deeppink"&gt;&nbsp;&lt;/span&gt;deeppink,
- &lt;span style="border-left: 10px solid salmon"&gt;&nbsp;&lt;/span&gt;salmon,
- &lt;span style="border-left: 10px solid peachpuff"&gt;&nbsp;&lt;/span&gt;peachpuff,
- &lt;span style="border-left: 10px solid violet"&gt;&nbsp;&lt;/span&gt;violet,
- &lt;span style="border-left: 10px solid mediumpurple"&gt;&nbsp;&lt;/span&gt;mediumpurple,
- &lt;span style="border-left: 10px solid palegoldenrod"&gt;&nbsp;&lt;/span&gt;palegoldenrod,
- &lt;span style="border-left: 10px solid darkkhaki"&gt;&nbsp;&lt;/span&gt;darkkhaki,
- &lt;span style="border-left: 10px solid springgreen"&gt;&nbsp;&lt;/span&gt;springgreen,
- &lt;span style="border-left: 10px solid turquoise"&gt;&nbsp;&lt;/span&gt;turquoise,
- &lt;span style="border-left: 10px solid powderblue"&gt;&nbsp;&lt;/span&gt;powderblue
</Admonition>


