---
title: "Session: What is a Session and How Does it Work"
hide_table_of_contents: true
sidebar_label: What is a Session and How Does it Work
sidebar_position: 0
---

import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';
import LanguageSwitcher from "@site/src/components/LanguageSwitcher";
import LanguageContent from "@site/src/components/LanguageContent";

export const supportedLanguages = ["csharp", "java"];


# Session: What is a Session and How Does it Work  
<LanguageSwitcher supportedLanguages={supportedLanguages} />
<LanguageContent language="csharp">

<Admonition type="note" title="">  

* The **Session**, which is obtained from the [Document Store](../../client-api/what-is-a-document-store.mdx), is a 
  [Unit of Work](https://martinfowler.com/eaaCatalog/unitOfWork.html) that represents  
  a single business transaction on a particular database.  

* Basic **document CRUD** actions and **document Queries** are available through the `Session`.  
  More advanced options are available using `Advanced` Session operations.  

* The Session **Tracks all Changes** made to all entities that it has either loaded, stored, or queried on,  
  and persists to the server only what is needed when `SaveChanges()` is called.  

* The number of server requests allowed per session is configurable (default is 30).  
  See: [Change Maximum Number of Requests per Session](../../client-api/session/configuration/how-to-change-maximum-number-of-requests-per-session.mdx)  

* In this page:
  * [Unit of Work Pattern](../../client-api/session/what-is-a-session-and-how-does-it-work.mdx#unit-of-work-pattern)
      * [Tracking Changes](../../client-api/session/what-is-a-session-and-how-does-it-work.mdx#tracking-changes)
      * [Batching](../../client-api/session/what-is-a-session-and-how-does-it-work.mdx#batching)
      * [Store New Document Example](../../client-api/session/what-is-a-session-and-how-does-it-work.mdx#store-new-document-example)
      * [Load & Edit Document Example](../../client-api/session/what-is-a-session-and-how-does-it-work.mdx#load--edit-document-example)
  * [Identity Map Pattern](../../client-api/session/what-is-a-session-and-how-does-it-work.mdx#identity-map-pattern)
  * [Reducing Server Calls (Best Practices) For:](../../client-api/session/what-is-a-session-and-how-does-it-work.mdx#reducing-server-calls-(best-practices)-for:)
      * [The N+1 Problem](../../client-api/session/what-is-a-session-and-how-does-it-work.mdx#the-select-n1-problem)
      * [Large Query Results](../../client-api/session/what-is-a-session-and-how-does-it-work.mdx#large-query-results)
      * [Retrieving Results on Demand (Lazy)](../../client-api/session/what-is-a-session-and-how-does-it-work.mdx#retrieving-results-on-demand-lazy)

</Admonition>  
## Unit of Work Pattern  

#### Tracking Changes
* Using the Session, perform needed operations on your documents.  
  e.g. store a new document, modify an existing document, query your database, etc.  
  Any such operation '*loads*' the documents to the Session for tracking.  
* The Session **tracks all changes** made to all entities that it has either loaded or stored.  
  You don't need to manually track the changes to these entities and decide what needs to be saved and what doesn't.  
  The Session will do it for you.  
* All these tracked changes are combined & persisted to the database only when calling `SaveChanges()`.  
* Entity tracking can be disabled if needed. See:  
  * [Disable Entity Tracking](../../client-api/session/configuration/how-to-disable-tracking.mdx)  
  * [Clear a Session](../../client-api/session/how-to/clear-a-session.mdx)  
<br/>
#### Batching  
* Remote calls to a server over the network are among the most expensive operations an application makes.  
  The session optimizes this by batching all write operations it has tracked into the single `SaveChanges()` call.  
* The `SaveChanges()` call checks the Session state for all changes made to the tracked entities.  
  These changes are sent to the server as a single remote call that will complete transactionally.  
  In other words, either all changes are saved as a **Single Atomic Transaction** or none of them are.  
  Once `SaveChanges()` returns, it is guaranteed that the changes are persisted to the database.  
* The `SaveChanges()` is the only time when a RavenDB client sends updates to the server,  
  so you will experience a reduced number of network calls.  
<br/>
#### Store New Document Example  
* The Client API, and the Session in particular, is designed to be as straightforward as possible.  
  Open the session, do some operations, and apply the changes to the RavenDB server.  
* The example below shows how to store a new document in the database using the Session.  

<TabItem value="session_usage_1" label="session_usage_1">
<CodeBlock language="csharp">
{`// Obtain a Session from your Document Store
using (IDocumentSession session = store.OpenSession())
\{
    // Create a new entity
    Company entity = new Company \{ Name = "CompanyName" \};
    
    // Store the entity in the Session's internal map
    session.Store(entity);
    // From now on, any changes that will be made to the entity will be tracked by the Session.
    // However, the changes will be persisted to the server only when 'SaveChanges()' is called.
    
    session.SaveChanges();
    // At this point the entity is persisted to the database as a new document.
    // Since no database was specified when opening the Session, the Default Database is used.
\}
`}
</CodeBlock>
</TabItem>  

#### Load & Edit Document Example  
* The example below loads & edits an existing document and then saves the changes.  

<TabItem value="session_usage_2" label="session_usage_2">
<CodeBlock language="csharp">
{`// Open a session
using (IDocumentSession session = store.OpenSession())
\{
    // Load an existing document to the Session using its ID
    // The loaded entity will be added to the session's internal map
    Company entity = session.Load<Company>(companyId);
    
    // Edit the entity, the Session will track this change
    entity.Name = "NewCompanyName";

    session.SaveChanges();
    // At this point, the change made is persisted to the existing document in the database
\}
`}
</CodeBlock>
</TabItem>  

  

## Identity Map Pattern  

* The session implements the [Identity Map Pattern](https://martinfowler.com/eaaCatalog/identityMap.html).

* The first document `Load()` call goes to the server and fetches the document from the database.  
  The document is then saved as an entity in the Session's identity map.  

* All subsequent `Load()` calls to the same document will simply retrieve the entity from the Session -  
  no additional calls to the server  are made.  

<TabItem value="session_usage_3" label="session_usage_3">
<CodeBlock language="csharp">
{`// A document is fetched from the server
Company entity1 = session.Load<Company>(companyId);

// Loading the same document will now retrieve its entity from the Session's map
Company entity2 = session.Load<Company>(companyId);

// This command will Not throw an exception
Assert.Same(entity1, entity2);
`}
</CodeBlock>
</TabItem>  

* Note: To override this and update an entity with the latest changes from the server see: 
  [Refresh an Entity](../../client-api/session/how-to/refresh-entity.mdx)  

  

## Reducing Server Calls (Best Practices) For:
#### The Select N+1 Problem
* The Select N+1 problem is common 
  with all ORMs and ORM-like APIs.  
  It results in an excessive number of remote calls to the server, which makes a query very expensive.  
* Make use of RavenDB's `include()` method to include related documents and avoid this issue.  
  See: [Document Relationships](../../client-api/how-to/handle-document-relationships.mdx)  
<br/>
#### Large query results
* When query results are large and you don't want the overhead of keeping all results in memory, you can 
  [Stream the Query Results](../../client-api/session/querying/how-to-stream-query-results.mdx).  
  A single server call is executed and the client can handle the results one by one.  
* Note: [Paging](../../indexes/querying/paging.mdx) also avoids getting all query results in one time, but multiple server calls are 
  generated - one per page retrieved.  
<br/>
#### Retrieving results on demand (Lazy)
* Query calls to the server can be delayed and executed on-demand as needed using `Lazily()`
* See [Perform Queries Lazily](../../client-api/session/querying/how-to-perform-queries-lazily.mdx)




</LanguageContent>
<LanguageContent language="java">


After creating a RavenDB document store, we are ready to use the database server instance it is pointing at. For any operation we want to perform on RavenDB, we start by obtaining a new Session object from the document store. The Session object will contain everything we need to perform any operation necessary.

<TabItem value="session_usage_1" label="session_usage_1">
<CodeBlock language="java">
{`// Obtain a Session from your Document Store
try (IDocumentSession session = store.openSession()) \{

    // Create a new entity
    Company entity = new Company();
    entity.setName("Company");
    
    // Store the entity in the Session's internal map
    session.store(entity);
    // From now on, any changes that will be made to the entity will be tracked by the Session.
    // However, the changes will be persisted to the server only when 'SaveChanges()' is called.
    
    session.saveChanges();
    // At this point the entity is persisted to the database as a new document.
    // Since no database was specified when opening the Session, the Default Database is used.
\}
`}
</CodeBlock>
</TabItem>

The Client API, and using the Session object in particular, is very straightforward. Open the session, do some operations, and apply the changes to the RavenDB server. The usage of the second session is similar: open the session, get a document from the server, and do something with it.

<Admonition type="note" title="Storing Entities" id="storing-entities" href="#storing-entities"> 
You can read more about storing data with the session [here](./storing-entities).
</Admonition>


## Unit of Work

The Client API implements the Unit of Work pattern. That has several implications:

* In the context of a single session, a single document (identified by its ID) always resolves to the same instance.

<TabItem value="session_usage_3" label="session_usage_3">
<CodeBlock language="java">
{`// A document is fetched from the server
Company entity1 = session.load(Company.class, companyId);

// Loading the same document will now retrieve its entity from the Session's map
Company entity2 = session.load(Company.class, companyId);

// This command will Not throw an exception
Assert.assertSame(entity1, entity2);
`}
</CodeBlock>
</TabItem>

* The session manages change tracking for all the entities that it has either loaded or stored.

<TabItem value="session_usage_2" label="session_usage_2">
<CodeBlock language="java">
{`// Open a session
try (IDocumentSession session = store.openSession()) \{
    // Load an existing document to the Session using its ID
    // The loaded entity will be added to the session's internal map
    Company entity = session.load(Company.class, companyId);
    
    // Edit the entity, the Session will track this change
    entity.setName("NewCompanyName");

    session.saveChanges();
    // At this point, the change made is persisted to the existing document in the database
\}
`}
</CodeBlock>
</TabItem>

<Admonition type="info" title="How to Disable Entities Tacking" id="how-to-disable-entities-tacking" href="#how-to-disable-entities-tacking">

Entities tracking can be disabled using the `SessionOptions.NoTracking` property when session is being [opened](../../client-api/session/opening-a-session.mdx#example-ii---disabling-entities-tracking).

</Admonition>

## Batching

One of the most expensive operations in an application is making remote calls. The RavenDB Client API optimizes this for you by batching all write calls to the RavenDB server into a single call. This is the default behavior whenever using the Session object, you don't have to do anything to enable it. This also ensures that writes to the database are always executed in a single transaction, no matter how many operations you are actually executing.

## Remarks

A very common problem with all ORMs and ORM-like APIs is the Select N+1 problem. This is relevant to any database API which is designed to work like an ORM, RavenDB Client API included.
How RavenDB API attempts to mitigate this is not immediate, and should never be reached if RavenDB is being utilized correctly. Remote calls are expensive and the number of remote calls per "session" should be as close to "1" as possible. If the limit is reached, it is a sure sign of either a Select N+1 problem or other misuse of the RavenDB session.

<Admonition type="note" title="Configuring the maximum requests in a session" id="configuring-the-maximum-requests-in-a-session" href="#configuring-the-maximum-requests-in-a-session"> 
By default, the maximum requests count in the session is 30.
This can be changed by the DocumentConventions::maxNumberOfRequestsPerSession property.
</Admonition>


</LanguageContent>

<!---
### Client API
- [Opening a Session](../../client-api/session/opening-a-session)
- [Storing Entities](../../client-api/session/storing-entities)
- [Loading Entities](../../client-api/session/loading-entities)
- [Saving Changes](../../client-api/session/saving-changes)
- [Querying Basics](../../indexes/querying/basics)
- [What is a Document Store](../../client-api/what-is-a-document-store)

### Session
- [Opening a Session](../../client-api/session/opening-a-session)
- [Storing Entities](../../client-api/session/storing-entities)
- [Loading Entities](../../client-api/session/loading-entities)
- [Saving Changes](../../client-api/session/saving-changes)

### Querying
- [Basics](../../indexes/querying/basics)

### Document Store
- [What is a Document Store](../../client-api/what-is-a-document-store)


-->