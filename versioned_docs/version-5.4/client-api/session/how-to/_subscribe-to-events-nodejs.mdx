import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

* **Events** allow users to perform custom actions in response to operations made in 
  a `Document Store` or a `Session`.  

* An event is invoked when the selected action is executed on an entity, or querying is performed.  

* Subscribing to an event in a `Session` is valid only for this session.  

* Subscribing to an event at the `DocumentStore` level subscribes to this 
  event in all subsequent sessions.  
  Read more about `DocumentStore` events [here](../../../client-api/how-to/subscribe-to-store-events.mdx).  

## OnBeforeStore

This event is invoked as a part of `saveChanges()` but before it is actually sent to the server.  
It should be defined with this signature:  

<TabItem value="OnBeforeStore" label="OnBeforeStore">
<CodeBlock language="js">
{`store.addSessionListener("beforeStore", event => onBeforeStore(event));
`}
</CodeBlock>
</TabItem>

The usage of `SessionBeforeStoreEventArgs`:  

<TabItem value="beforeStoreEventArgs" label="beforeStoreEventArgs">
<CodeBlock language="js">
{`const beforeStoreEventArgs = new SessionBeforeStoreEventArgs(session, documentId, entity);
`}
</CodeBlock>
</TabItem>

### Example

Say we want to discontinue all of the products that are not in stock.  

<TabItem value="on_before_store_event" label="on_before_store_event">
<CodeBlock language="js">
{`function onBeforeStore(args) \{
    if (args.getEntity() instanceof Product) \{
        const product = args.getEntity();
        if (product.unitsInStock === 0) \{
            product.discontinued = true;
        \}
    \}
\}
`}
</CodeBlock>
</TabItem>

After we subscribe to the event, every stored entity will invoke the method.  

<TabItem value="store_session" label="store_session">
<CodeBlock language="js">
{`store.addSessionListener("beforeStore", event => onBeforeStore(event));

session = store.openSession();
await session.store(new Product(
    \{
        name: "RavenDB v3.5",
        unitsInStock: 0
    \})
)

await session.store(new Product(
    \{
        name: "RavenDB v4.0",
        unitsInStock: 1000
    \})
)

await session.saveChanges(); // Here the method is invoked
`}
</CodeBlock>
</TabItem>



## OnBeforeDelete

This event is invoked by `delete(id)` or `delete(entity)`. It is only executed when `saveChanges()` 
is called, but before the commands are actually sent to the server.  
It should be defined with this signature:  

<TabItem value="before_delete_event" label="before_delete_event">
<CodeBlock language="js">
{`store.addSessionListener("beforeDelete", event => onBeforeDelete(event));
`}
</CodeBlock>
</TabItem>

The usage of `SessionBeforeDeleteEventArgs`:  

<TabItem value="beforeDeleteEventArgs" label="beforeDeleteEventArgs">
<CodeBlock language="js">
{`const beforeDeleteEventArgs = new SessionBeforeDeleteEventArgs(session, documentId, entity);
`}
</CodeBlock>
</TabItem>

### Example

To prevent anyone from deleting entities we can create a method as follows:

<TabItem value="on_Before_Delete_Event" label="on_Before_Delete_Event">
<CodeBlock language="js">
{`function onBeforeDelete(args) \{
    throw new Error("Not implemented");
\}
`}
</CodeBlock>
</TabItem>

and subscribe it to the session:

<TabItem value="delete_session" label="delete_session">
<CodeBlock language="js">
{`store.addSessionListener("beforeDelete", event => onBeforeDelete(event));

session = store.openSession();
let product = await session.load("products/1-A", Product);
let product2 = await session.load("products/2-A", Product);

// onBeforeDelete is triggered whether you
// call delete() on an entity or on its ID
await session.delete(product);
await session.saveChanges(); // NotSupportedException will be thrown

await session.delete("products/2-A");
await session.saveChanges(); // NotSupportedException will be thrown
`}
</CodeBlock>
</TabItem>



## OnAfterSaveChanges

This event is invoked after the `saveChanges` is returned.  
It should be defined with this signature:  

<TabItem value="after_save_event" label="after_save_event">
<CodeBlock language="js">
{`store.addSessionListener("afterSave", event => onAfterSaveChanges(event));
`}
</CodeBlock>
</TabItem>


The usage of `SessionAfterSaveChangesEventArgs`:

<TabItem value="afterSaveChangesEventArgs" label="afterSaveChangesEventArgs">
<CodeBlock language="js">
{`const afterSaveChangesEventArgs = new SessionAfterSaveChangesEventArgs(session, documentId, entity);
`}
</CodeBlock>
</TabItem>


### Example

If we want to log each entity that was saved, we can create a method as follows:  

<TabItem value="on_after_save_changes_event" label="on_after_save_changes_event">
<CodeBlock language="js">
{`function onAfterSaveChanges(args) \{
    console.log("Document " + args.documentId + " was saved.");
\}
`}
</CodeBlock>
</TabItem>



## OnBeforeQuery

This event is invoked just before the query is sent to the server. 
It should be defined with this signature:  

<TabItem value="before_query_event" label="before_query_event">
<CodeBlock language="js">
{`store.addSessionListener("beforeQuery", event => onBeforeQuery(event));
`}
</CodeBlock>
</TabItem>

The usage of `SessionBeforeQueryEventArgs`:  

<TabItem value="beforeQueryEventArgs" label="beforeQueryEventArgs">
<CodeBlock language="js">
{`const beforeQueryEventArgs = new SessionBeforeQueryEventArgs(session, documentId, entity);
`}
</CodeBlock>
</TabItem>

### Example I

If you want to disable caching of all query results, you can implement the method as follows:  

<TabItem value="on_before_query_execute_event" label="on_before_query_execute_event">
<CodeBlock language="js">
{`function onBeforeQuery(args) \{
    args.queryCustomization.noCaching();
\}
`}
</CodeBlock>
</TabItem>

### Example II

If you want each query to [wait for non-stale results](../../../indexes/stale-indexes.mdx) you can create an event as follows:  

<TabItem value="on_before_query_execute_event_2" label="on_before_query_execute_event_2">
<CodeBlock language="js">
{`function onBeforeQuery(args) \{
    args.queryCustomization.waitForNonStaleResults(30);
\}
`}
</CodeBlock>
</TabItem>



## OnBeforeConversionToDocument

This event is invoked before conversion of an entity to blittable JSON document. E.g. it's called when sending a document to a server.  
It should be defined with this signature:  

<TabItem value="beforeConversionToDocument_event" label="beforeConversionToDocument_event">
<CodeBlock language="js">
{`store.addSessionListener("beforeConversionToDocument", event => onBeforeConversionToDocument(event));
`}
</CodeBlock>
</TabItem>

The usage of `BeforeConversionToDocumentEventArgs`:  

<TabItem value="beforeConversionToDocument" label="beforeConversionToDocument">
<CodeBlock language="js">
{`const beforeConversionToDocumentEventArgs = new BeforeConversionToDocumentEventArgs(session, documentId, entity);
`}
</CodeBlock>
</TabItem>

### Example

<TabItem value="on_before_conversion_to_document" label="on_before_conversion_to_document">
<CodeBlock language="js">
{`function onBeforeConversionToDocument(args) \{
    if (args.getEntity() instanceof Product) \{
        const product = args.getEntity();
        product.before = true;
    \}
\}
`}
</CodeBlock>
</TabItem>



## OnAfterConversionToDocument

This event is invoked after conversion of an entity to blittable JSON document.  
It should be defined with this signature:  

<TabItem value="afterConversionToDocument_event" label="afterConversionToDocument_event">
<CodeBlock language="js">
{`store.addSessionListener("afterConversionToDocument", event => onAfterConversionToDocument(event));
`}
</CodeBlock>
</TabItem>

The class `AfterConversionToDocumentEventArgs`:  

<TabItem value="afterConversionToDocument" label="afterConversionToDocument">
<CodeBlock language="js">
{`const afterConversionToDocument = new AfterConversionToDocumentEventArgs(session, documentId, entity, document);
`}
</CodeBlock>
</TabItem>


### Example

<TabItem value="on_after_conversion_to_document" label="on_after_conversion_to_document">
<CodeBlock language="js">
{`function onAfterConversionToDocument(args) \{
    if (args.getEntity() instanceof Product) \{
        const product = args.getEntity();
        if (product.document.after == null) \{
            product.document.after = true;
        \}
    \}
\}
`}
</CodeBlock>
</TabItem>



## OnBeforeConversionToEntity

This event is invoked before conversion of a JSON document to an entity. E.g. it's called when loading a document.  

It takes the argument `BeforeConversionToEntityEventArgs`, that consists of a JSON document, its ID and type, and the session instance.  

<TabItem value="on_before_conversion_to_entity" label="on_before_conversion_to_entity">
<CodeBlock language="js">
{`store.addSessionListener("beforeConversionToEntity", (event: BeforeConversionToEntityEventArgs) => \{
    const document = ObjectUtil.clone(event.document);

    document.before = true;
    event.document = document;
\});
`}
</CodeBlock>
</TabItem>




## OnAfterConversionToEntity

This event is invoked after conversion of a JSON document to an entity. It takes the argument `AfterConversionToEntityEventArgs`, that consists of a JSON document, its ID, the session instance and a converted entity.  

<TabItem value="on_after_conversion_to_entity" label="on_after_conversion_to_entity">
<CodeBlock language="js">
{`store.addSessionListener("afterConversionToEntity", (event: AfterConversionToEntityEventArgs) => \{
    if (event.entity instanceof Item) \{
        const item = event.entity;
        item.after = true;
    \}
\});
`}
</CodeBlock>
</TabItem>




