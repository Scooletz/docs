import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

<Admonition type="note" title="">

* Use the `Recurse` method to traverse the layers of a hierarchical document and index its fields.

* In this Page:  
   * [Hierarchical data](../indexes/indexing-hierarchical-data.mdx#hierarchical-data)  
   * [Index hierarchical data](../indexes/indexing-hierarchical-data.mdx#index-hierarchical-data)  
   * [Query the index](../indexes/indexing-hierarchical-data.mdx#query-the-index)  

</Admonition>
## Hierarchical data

One significant advantage of document databases is their tendency not to impose limits on data structuring.
**Hierarchical data structures** exemplify this quality well; for example, consider the commonly used comment thread, implemented using objects such as:

<TabItem value="indexes_1" label="indexes_1">
<CodeBlock language="python">
{`class BlogPost:
    def __init__(self, author: str = None, title: str = None, text: str = None, comments: List[BlogPostComment] = None):
        self.author = author
        self.title = title
        self.text = text
        
        # Blog post readers can leave comments
        self.comments = comments


class BlogPostComment:
    def __init__(self, author: str = None, text: str = None, comments: List[BlogPostComment] = None):
        self.author = author
        self.text = text

        # Allow nested comments, enabling replies to existing comments
        self.comments = comments
`}
</CodeBlock>
</TabItem>

Readers of a post created using the above `BlogPost` structure can add `BlogPostComment` entries to the post's _comments_ field,
and readers of these comments can reply with comments of their own, creating a recursive hierarchical structure. 

For example, the following document, `BlogPosts/1-A`, represents a blog post by John that contains multiple layers of comments from various authors.  

`BlogPosts/1-A`:  

<TabItem value="json" label="json">
<CodeBlock language="json">
{`\{
    "Author": "John",
    "Title": "Post title..",
    "Text": "Post text..",
    "Comments": [
        \{
            "Author": "Moon",
            "Text": "Comment text..",
            "Comments": [
                \{
                    "Author": "Bob",
                    "Text": "Comment text.."
                \},
                \{
                    "Author": "Adel",
                    "Text": "Comment text..",
                    "Comments": \{
                        "Author": "Moon",
                        "Text": "Comment text.."
                    \}
                \}
            ]
        \}
    ],
    "@metadata": \{
        "@collection": "BlogPosts"
    \}
\}
`}
</CodeBlock>
</TabItem>



## Index hierarchical data

To index the elements of a hierarchical structure like the one above, use RavenDB's `Recurse` method.

The sample index below shows how to use `Recurse` to traverse the comments in the post thread and index them by their authors.
We can then [query the index](../indexes/indexing-hierarchical-data.mdx#query-the-index) for all blog posts that contain comments by specific authors.

<Tabs groupId='languageSyntax'>
<TabItem value="AbstractIndexCreationTask" label="AbstractIndexCreationTask">
<CodeBlock language="python">
{`class BlogPosts_ByCommentAuthor(AbstractIndexCreationTask):
    class Result:
        def __init__(self, authors: List[str] = None):
            self.authors = authors

    def __init__(self):
        super().__init__()
        self.map = "from blogpost in docs.Blogposts let authors = Recurse(blogpost, x => x.comments) select new { authors = authors.Select(x => x.author) }"
`}
</CodeBlock>
</TabItem>
<TabItem value="Operation" label="Operation">
<CodeBlock language="python">
{`store.maintenance.send(
    PutIndexesOperation(
        IndexDefinition(
            name="BlogPosts/ByCommentAuthor",
            maps={
                """from blogpost in docs.BlogPosts
 in Recurse(blogpost, (Func<dynamic, dynamic>)(x => x.comments))
select new
{
 comment.author
}"""
            },
        )
    )
)
`}
</CodeBlock>
</TabItem>
</Tabs>



## Query the index

The index can be queried for all blog posts that contain comments made by specific authors.

**Query the index using code**:  

<Tabs groupId='languageSyntax'>
<TabItem value="Query" label="Query">
<CodeBlock language="python">
{`results = list(
    session.query_index_type(BlogPosts_ByCommentAuthor, BlogPosts_ByCommentAuthor.Result).where_equals(
        "authors", "Moon"
    )
)
`}
</CodeBlock>
</TabItem>
<TabItem value="RQL" label="RQL">
<CodeBlock language="sql">
{`from index "BlogPosts/ByCommentAuthor"
where Authors == "Moon"
`}
</CodeBlock>
</TabItem>
</Tabs>

**Query the index using Studio**:

  * Query the index from Studio's [List of Indexes](../studio/database/indexes/indexes-list-view.mdx#indexes-list-view) view:  
     
      !["List of Indexes view"](./assets/list-of-indexes-view.png)

  * View the query results in the [Query](../studio/database/queries/query-view.mdx) view:  
    
      !["Query View"](./assets/query-view.png)
    
  * View the list of terms indexed by the `Recurse` method:

      !["Click to View Index Terms"](./assets/click-to-view-terms.png)

      !["Index Terms"](./assets/index-terms.png)




