import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

<Admonition type="note" title="">

* Indexing attachments allows you to query for documents based on their attachments' details and content.

* **Static indexes**:   
  Both attachments' details and content can be indexed within a static-index definition.

* **Auto-indexes**:  
  Auto-indexing attachments via dynamic queries is not available at this time.

* In this page:  
  * [Syntax](../../document-extensions/attachments/indexing.mdx#syntax)  
  * [Examples](../../document-extensions/attachments/indexing.mdx#examples)  
  * [Leveraging indexed attachments](../../document-extensions/attachments/indexing.mdx#leveraging-indexed-attachments)  

</Admonition>
## Syntax

### Using AttachmentsFor()

The `AttachmentsFor` method returns information about each attachment that extends 
a specified document, including their names, sizes, and content type. write index definition as string.

<Tabs groupId='languageSyntax'>
<TabItem value="Method" label="Method">
<CodeBlock language="java">
{`IEnumerable<AttachmentName> AttachmentsFor(object doc);
`}
</CodeBlock>
</TabItem>
<TabItem value="AttachmentName" label="AttachmentName">
<CodeBlock language="java">
{`private String name;
private String hash;
private String contentType;
private long size;
`}
</CodeBlock>
</TabItem>
</Tabs>

The `AttachmentsFor` method is available in `AbstractIndexCreationTask`.

### Using LoadAttachment()/LoadAttachments()

`LoadAttachment()` loads an attachment to the index by document and attachment name.  
`LoadAttachments()` loads all the attachments of a given document.  

<TabItem value="syntax_2" label="syntax_2">
<CodeBlock language="java">
{`public IAttachmentObject LoadAttachment(object doc, string name);
public IEnumerable<IAttachmentObject> LoadAttachments(object doc);
`}
</CodeBlock>
</TabItem>

| Parameter | Type | Description |
| - | - | - |
| **doc** | A server-side document, an entity | The document whose attachments you want to load |
| **name** | `String` | The name of the attachment you want to load |

#### GetContentAs Methods

To access the attachment content itself, use `GetContentAsStream()`. To 
convert the content into a `string`, use `GetContentAsString()` with 
the desired character encoding.  

<TabItem value="csharp" label="csharp">
<CodeBlock language="csharp">
{`public Stream GetContentAsStream();

public string GetContentAsString(Encoding encoding);

public string GetContentAsString(); // Default: UTF-8
`}
</CodeBlock>
</TabItem>



## Examples

#### Indexes with `AttachmentsFor()`

<Tabs groupId='languageSyntax'>
<TabItem value="JavaScript-syntax" label="JavaScript-syntax">
<CodeBlock language="java">
{`public static class Employees_ByAttachmentNames extends AbstractIndexCreationTask {
    public Employees_ByAttachmentNames() {
        map = "from e in docs.Employees\\n" +
            "let attachments = AttachmentsFor(e)\\n" +
            "select new {\\n" +
            "   attachmentNames = attachments.Select(x => x.Name).ToArray()\\n" +
            "}";
    }
}
`}
</CodeBlock>
</TabItem>
</Tabs>

#### Indexes with `LoadAttachment()`

<Tabs groupId='languageSyntax'>
<TabItem value="JavaScript-syntax" label="JavaScript-syntax">
<CodeBlock language="java">
{`private class Companies_With_Attachments_JavaScript extends AbstractJavaScriptIndexCreationTask {
    public Companies_With_Attachments_JavaScript() {
        setMaps(Collections.singleton(
            "map('Companies', function (company) {\\n" +
                "   var attachment = LoadAttachment(company, company.ExternalId);\\n" +
                "   return {\\n" +
                "       CompanyName: company.Name,\\n" +
                "       AttachmentName: attachment.Name,\\n" +
                "       AttachmentContentType: attachment.ContentType,\\n" +
                "       AttachmentHash: attachment.Hash,\\n" +
                "       AttachmentSize: attachment.Size,\\n" +
                "       AttachmentContent: attachment.getContentAsString('utf8')\\n" +
                "   }\\n"+
                "});"
            )
        );
    }
}
`}
</CodeBlock>
</TabItem>
</Tabs>

#### Indexes with `LoadAttachments()`

<Tabs groupId='languageSyntax'>
<TabItem value="JavaScript-syntax" label="JavaScript-syntax">
<CodeBlock language="java">
{`private class Companies_With_All_Attachments_JS extends AbstractJavaScriptIndexCreationTask {
    public Companies_With_All_Attachments_JS() {
        setMaps(Collections.singleton(
            "map('Companies', function (company) {\\n" +
            "    var attachments = LoadAttachments(company);\\n" +
            "    return attachments.map(attachment => ({\\n" +
            "        AttachmentName: attachment.Name,\\n" +
            "        AttachmentContent: attachment.getContentAsString('utf8')\\n" +
            "     }));\\n" +
            "})"
            )
        );
    }
}
`}
</CodeBlock>
</TabItem>
</Tabs>

#### Querying the Index


<TabItem value="query1" label="query1">
<CodeBlock language="java">
{`//return all employees that have an attachment called "cv.pdf"
List<Employee> employees = session.query(Employees_ByAttachmentNames.class)
    .containsAny("attachmentNames", Arrays.asList("employees_cv.pdf"))
    .selectFields(Company.class, "cv.pdf").ofType(Employee.class)
    .toList();
`}
</CodeBlock>
</TabItem>



## Leveraging indexed attachments

* Access to the indexed attachment content opens the door to many different applications,  
  including many that can be integrated directly into RavenDB.

* In this [blog post](https://ayende.com/blog/192001-B/using-machine-learning-with-ravendb),
  Oren Eini demonstrates how image recognition can be applied to indexed attachments using the [additional sources](../../indexes/extending-indexes.mdx) feature.
  The resulting index allows filtering and querying based on image content.





