---
title: "Commands: UploadAsync"
hide_table_of_contents: true
sidebar_label: Upload
sidebar_position: 0
---

import Admonition from '@theme/Admonition';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';
import LanguageSwitcher from "@site/src/components/LanguageSwitcher";
import LanguageContent from "@site/src/components/LanguageContent";

export const supportedLanguages = ["csharp", "http"];


## Syntax
<LanguageSwitcher supportedLanguages={supportedLanguages} />
<LanguageContent language="csharp">
#Commands: UploadAsync

**UploadAsync** is used to insert a new file or update the content of an existing one in a file system.



<TabItem value="upload_1" label="upload_1">
<CodeBlock language="csharp">
{`Task UploadAsync(string filename, Stream source, RavenJObject metadata = null, Etag etag = null);
`}
</CodeBlock>
</TabItem>

| Parameters | | |
| ------------- | ------------- | ----- |
| **filename** | string | The name of the uploaded file (full path) |
| **source** | Stream | The file content |
| **metadata** | RavenJObject | The file metadata (default: `null`) |
| **etag** | Etag | The current file etag used for concurrency checks (`null` skips check) |

| Return Value | |
| ------------- | ------------- |
| **Task** | A task that represents the asynchronous upload operation |

<TabItem value="upload_3" label="upload_3">
<CodeBlock language="csharp">
{`Task UploadAsync(string filename, Action<Stream> source, Action prepareStream, long size, RavenJObject metadata = null, Etag etag = null);
`}
</CodeBlock>
</TabItem>

| Parameters | | |
| ------------- | ------------- | ----- |
| **filename** | string | The name of the uploaded file (full path) |
| **source** | Action&lt;Stream&gt; | The action which writes file content to the network stream |
| **prepareStream** | Action | The action executed before the content is being written (`null` means no action to perform) |
| **size** | long | The file size. It is sent in `RavenFS-Size` header to validate the number of bytes received on the server side. If there is a mismatch between the size reported in the header and the number of the bytes read on the server side, then `BadRequestException` is thrown |
| **metadata** | RavenJObject | The file metadata (default: `null`) |
| **etag** | Etag | The current file etag used for concurrency checks (`null` skips check) |

| Return Value | |
| ------------- | ------------- |
| **Task** | A task that represents the asynchronous upload operation |

## Example I

<TabItem value="upload_2" label="upload_2">
<CodeBlock language="csharp">
{`using (var file = File.OpenRead(@"C:\\intro.avi"))
\{
	await store
	.AsyncFilesCommands
	.UploadAsync(
		"/movies/intro.avi",
		file,
		new RavenJObject
		\{
			\{
				"AllowRead", "Everyone"
			\}
		\}
	);
\}
`}
</CodeBlock>
</TabItem>

## Example II

<TabItem value="upload_4" label="upload_4">
<CodeBlock language="csharp">
{`await store
	.AsyncFilesCommands
	.UploadAsync(
		"two-bytes-file.bin",
		s =>
		\{
			s.WriteByte(1);
			s.WriteByte(2);
		\},
		null,
		2,
		new RavenJObject
		\{
			\{
				"AllowRead", "Everyone"
			\}
		\}
	);
`}
</CodeBlock>
</TabItem>

</LanguageContent>
<LanguageContent language="http">
#Commands: Upload

The **PUT** method is used to insert a new file or update the content of an existing one in a file system.



<TabItem value="json" label="json">
<CodeBlock language="json">
{`curl \\
	http://\{serverUrl\}/fs/\{fileSystemName\}/files/\{name\}  \\
	-X PUT \\
	--data-binary @file  \\
	--header "anyKey:anyValue" \\
    --header "If-None-Match:\{etag\}" \\
    --header "RavenFS-Size:\{size\}" \\ 
    --header "Content-Length:\{length\}"
Â 
curl \\
	http://\{serverUrl\}/fs/\{fileSystemName\}/files/\{name\}  \\
	-X PUT \\
	--data-binary @file  \\
	--header "anyKey:anyValue" \\
    --header "If-None-Match:\{etag\}" \\
    --header "RavenFS-Size:\{size\}" \\ 
    --header "Transfer-Encoding:chunked"
`}
</CodeBlock>
</TabItem>

### Request

| Payload |
| ------- |
| The file's content|

| Query parameter | Required | Description |
| ------------- | -- | ---- |
| **name** | Yes | The name under which the file will be stored |

| Header | Required | Description |
| --------| ------- | --- |
| **If-None-Match** | No |  Used to pass the file `Etag` |
| **RavenFS-Size** | No |  Used to validate the number of bytes received on the server side. If there is a mismatch between the size reported in the header and the number of the bytes read on the server side, then `BadRequestException` is thrown. |
| **Content-Length** | Yes / No |  Used to specify the length if the request (actually the size of the uploaded file). If not specified then `Transfer-Encoding:chunked` must be set. |
| **Transfer-Encoding** | Yes / No |  Used to define how the file is sent. If you don't know the actual file size you can set it to `chunked`, then there is no need to specify `Content-Length` header. |
| Any other header | No | Used to pass metadata records |

### Response

| Status code | Description |
| ----------- | - |
| `201` | Created |
| `405` | The concurrency exception occurred |
| `420` | The synchronization exception occurred |

| Return Value | Description |
| ------------- | ------------- |
| **None** | The request does not return any message |

---

## Examples

Put a file under name `/movies/intro.avi` with `AllowRead` metadata:

<TabItem value="json" label="json">
<CodeBlock language="json">
{`curl \\
	-X PUT http://localhost:8080/fs/NorthwindFS/files/movies/intro.avi  \\
	--data-binary @C:\\intro.avi
	--header "AllowRead:Everyone" \\
	--header "Content-Length:1338" \\
    --header "RavenFS-Size:1338"
< HTTP/1.1 201 Created
`}
</CodeBlock>
</TabItem>

If you don't know the exact file size you can take advantage of `Transfer-Encoding:chunked` header:

<TabItem value="json" label="json">
<CodeBlock language="json">
{`curl \\
	-X PUT http://localhost:8080/fs/NorthwindFS/files/movies/intro.avi  \\
	--data-binary @C:\\intro.avi
	--header "AllowRead:Everyone" \\
	--header "Transfer-Encoding:chunked"
< HTTP/1.1 201 Created
`}
</CodeBlock>
</TabItem>


Attempting to put a file with an invalid `Etag` ends up with the concurrency error:

<TabItem value="json" label="json">
<CodeBlock language="json">
{`curl \\
	-X PUT http://localhost:8080/fs/NorthwindFS/files/movies/intro.avi  \\
	--data-binary @C:\\intro.avi
	--header "Content-Length:1338" \\
    --header "If-None-Match:01000000-0000-0008-0000-0000000000CC"
 
< HTTP/1.1 405 Method Not Allowed
\{
    "Url":"/fs/NorthwindFS/files/movies/intro.avi",
    "ActualETag":"00000000-0000-0003-0000-000000000006",
    "ExpectedETag":"01000000-0000-0008-0000-0000000000CC",
    "Error":"Operation attempted on file '/movies/intro.avi' using a non current etag"
\}
`}
</CodeBlock>
</TabItem>

The put operation on the currently being synced file returns the synchronization error:

<TabItem value="json" label="json">
<CodeBlock language="json">
{`curl \\
	-X PUT http://localhost:8080/fs/NorthwindFS/files/movies/intro.avi  \\
	--data-binary @C:\\intro.avi
	--header "Content-Length:1338"
 
< HTTP/1.1 420
\{
    "Url":"/fs/NorthwindFS/files/movies/intro.avi",
    "Error":"File /movies/intro.avi is being synced"
\}
`}
</CodeBlock>
</TabItem>

</LanguageContent>

<!---

-->